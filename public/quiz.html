<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <!-- セキュリティヘッダーは _headers で統一管理（Studio埋め込み許可） -->
  
  <title>放課後クロニクル ― 診断ゲーム</title>
  

  
  <!-- 最優先TypeSquare完全遮断システム -->
  <script>
    (function() {
      'use strict';
      
      // ローカル開発時は過剰ギミックを無効化
      if (location.protocol === 'file:') { return; }
      
      // 安全なコンソール乗っ取り（F12開放時エラー対策）
      let originalError, originalWarn, originalLog;
      
      try {
        originalError = console.error;
        originalWarn = console.warn;
        originalLog = console.log;
        
        console.error = function(...args) {
          try {
            const message = args.join(' ');
            if (message.includes('typesquare') || 
                message.includes('ERR_BLOCKED_BY_CLIENT') ||
                message.includes('Failed to load resource') ||
                message.includes('net::') ||
                message.includes('GET https://l.typesquare.com') ||
                message.includes('Uncaught (in promise) n') ||
                (message.includes('Uncaught') && message.includes('typesquare'))) {
              return; // 完全に無視
            }
            return originalError.apply(console, args);
          } catch(e) {
            // コンソール操作でエラーが発生した場合は元の関数を使用
            return originalError.apply(console, args);
          }
        };
        
        console.warn = function(...args) {
          try {
            const message = args.join(' ');
            if (message.includes('typesquare') || message.includes('ERR_BLOCKED_BY_CLIENT')) {
              return; // 完全に無視
            }
            return originalWarn.apply(console, args);
          } catch(e) {
            return originalWarn.apply(console, args);
          }
        };
      } catch(consoleError) {
        console.log('⚠️ コンソール乗っ取りでエラー発生、スキップ');
      }
      
      // 全てのエラーとPromise rejectionsを即座に捕捉
      window.addEventListener('error', function(e) {
        if (e.filename && (
          e.filename.includes('typesquare') || 
          e.filename.includes('ts?') ||
          e.filename.includes('entry.') ||
          e.filename.includes('l.typesquare.com')
        )) {
          e.stopImmediatePropagation();
          e.preventDefault();
          return false;
        }
        if (e.message && (
          e.message.includes('typesquare') ||
          e.message.includes('ERR_BLOCKED_BY_CLIENT') ||
          e.message.includes('Failed to load resource') ||
          e.message.includes('net::ERR_')
        )) {
          e.stopImmediatePropagation();
          e.preventDefault();
          return false;
        }
      }, true);
      
      window.addEventListener('unhandledrejection', function(e) {
        if (e.reason) {
          const reason = e.reason.toString();
          if (reason.includes('typesquare') ||
              reason.includes('ERR_BLOCKED_BY_CLIENT') ||
              reason.includes('Failed to fetch') ||
              reason.includes('net::ERR_')) {
            e.stopImmediatePropagation();
            e.preventDefault();
            return false;
          }
        }
      }, true);
      
      // TypeSquare関連変数を安全にブロック
      const blockedVariables = ['ts', 'TypeSquare', 'Typekit', 'WebFont', 'Ts', 'TS', 'typesquare'];
      blockedVariables.forEach(varName => {
        try {
          // 既に定義されているかチェック
          if (window.hasOwnProperty(varName)) {
            console.log('🚫 既存の変数をnullに設定:', varName);
            try {
              window[varName] = null;
            } catch(setError) {
              console.warn('⚠️ 変数設定失敗:', varName, setError);
            }
          } else {
            // 新規定義
            Object.defineProperty(window, varName, {
              get: function() { return null; },
              set: function() { return false; },
              configurable: true,
              enumerable: false
            });
            console.log('🚫 新規変数ブロック設定:', varName);
          }
        } catch(e) {
          console.warn('⚠️ 変数ブロック設定失敗:', varName, e.message);
        }
      });
      
      // fetchとXMLHttpRequestをフックしてTypeSquareリクエストをブロック
      const originalFetch = window.fetch;
      if (originalFetch) {
        window.fetch = function(url, options) {
          if (typeof url === 'string' && (
            url.includes('typesquare') || 
            url.includes('l.typesquare.com') ||
            url.includes('ts?condition=')
          )) {
            console.log('🚫 TypeSquare fetchリクエストをブロック:', url);
            return Promise.reject(new Error('TypeSquare request blocked'));
          }
          return originalFetch.apply(this, arguments);
        };
      }
      
      const originalXHROpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function(method, url) {
        if (typeof url === 'string' && (
          url.includes('typesquare') ||
          url.includes('l.typesquare.com') ||
          url.includes('ts?condition=')
        )) {
          console.log('🚫 TypeSquare XHRリクエストをブロック:', url);
          return;
        }
        return originalXHROpen.apply(this, arguments);
      };
      
      // MutationObserverでTypeSquareスクリプトの動的追加を監視・ブロック
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1) { // Element node
              // TypeSquare関連のスクリプトやリンクを即座に削除
              if (node.src && (
                node.src.includes('typesquare') || 
                node.src.includes('entry.') ||
                node.src.includes('l.typesquare.com')
              )) {
                node.remove();
                console.log('🚫 TypeSquareスクリプトを削除:', node.src);
              }
              if (node.href && node.href.includes('typesquare')) {
                node.remove();
                console.log('🚫 TypeSquareリンクを削除:', node.href);
              }
              // 子要素もチェック
              const typeSquareElements = node.querySelectorAll && node.querySelectorAll('[src*="typesquare"], [href*="typesquare"], [src*="entry."], [src*="l.typesquare.com"]');
              if (typeSquareElements) {
                typeSquareElements.forEach(el => {
                  el.remove();
                  console.log('🚫 TypeSquare子要素を削除');
                });
              }
            }
          });
        });
      });
      
      // DOM全体を監視開始
      observer.observe(document, {
        childList: true,
        subtree: true
      });
      
      console.log('🛡️ 最強TypeSquare遮断システム起動完了（DOM監視含む）');
    })();
  </script>
  
  <!-- TypeSquareエラー対策スクリプト -->
  <script>
    (function() {
      'use strict';
      
      // ローカル開発時は過剰ギミックを無効化
      if (location.protocol === 'file:') { return; }
      
      console.log('🛡️ TypeSquareエラー対策システム起動（Quiz版）');
      
      // TypeSquareエラー検出カウンター
      let typeSquareErrorCount = 0;
      
      // すべてのTypeSquareエラーを抑制
      window.addEventListener('error', function(e) {
        if (e.filename && (
          e.filename.includes('typesquare') || 
          e.filename.includes('ts?') ||
          e.filename.includes('entry.') ||
          e.message.includes('typesquare') ||
          e.message.includes('ERR_BLOCKED_BY_CLIENT')
        )) {
          typeSquareErrorCount++;
          console.warn('🚫 TypeSquareエラーを無効化 (Quiz):', e.message, '(カウント:', typeSquareErrorCount, ')');
          e.stopImmediatePropagation();
          e.preventDefault();
          return false;
        }
      }, true);
      
      window.addEventListener('unhandledrejection', function(e) {
        if (e.reason && (
          e.reason.toString().includes('typesquare') ||
          e.reason.toString().includes('ERR_BLOCKED_BY_CLIENT') ||
          e.reason.toString().includes('Failed to fetch')
        )) {
          typeSquareErrorCount++;
          console.warn('🚫 TypeSquare Promise rejection を無効化 (Quiz) (カウント:', typeSquareErrorCount, ')');
          e.stopImmediatePropagation();
          e.preventDefault();
          return false;
        }
      }, true);
      
      // TypeSquare関連のグローバル変数を無効化
      const tsVariables = ['ts', 'TypeSquare', 'Typekit', 'WebFont', 'Ts', 'TS'];
      tsVariables.forEach(varName => {
        Object.defineProperty(window, varName, {
          get: function() { return null; },
          set: function() { console.warn('🚫 TypeSquare変数設定を阻止 (Quiz):', varName); },
          configurable: false,
          enumerable: false
        });
      });
      
      // コンソールエラーも抑制
      const originalConsoleError = console.error;
      console.error = function(...args) {
        const message = args.join(' ');
        if (message.includes('typesquare') || 
            message.includes('ERR_BLOCKED_BY_CLIENT') ||
            message.includes('Failed to load resource')) {
          console.warn('🔇 TypeSquareコンソールエラーを抑制 (Quiz):', message);
          return;
        }
        return originalConsoleError.apply(console, args);
      };
      
      console.log('✅ TypeSquareエラー対策完了（Quiz版）');
    })();
  </script>
  
  <style>
    /* TypeSquareとStudio環境スクリプトの完全無効化 */
    link[href*="typesquare"], 
    script[src*="typesquare"],
    script[src*="entry."],
    script[src*="l.typesquare.com"],
    iframe[src*="typesquare"],
    *[data-typesquare],
    *[class*="typesquare"],
    *[id*="typesquare"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
      position: absolute !important;
      left: -9999px !important;
      top: -9999px !important;
      width: 0 !important;
      height: 0 !important;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ===== iPhone等の狭幅 最適化（見た目は据え置き） ===== */
    @media (max-width: 430px) {
      /* 全体のパディングを詰めて内容幅を確保 */
      .diagnosis-container {
        padding: 0.75rem;
        margin: 0.75rem auto;
        max-width: 92vw;
      }

      /* 結果カード：内側を少し詰める */
      .result-card,
      .unified-result-card {
        padding: 0.9rem 0.9rem 1rem;
        border-radius: 12px;
      }

      /* タイトル・サブタイトルはclampで自動調整し、行間を締める */
      .result-title {
        font-size: clamp(18px, 4.8vw, 22px);
        line-height: 1.25;
        letter-spacing: .03em;
        margin-bottom: .4rem;
        text-align: left; /* 中央でも可。左だと改行が整う */
      }
      .result-subtitle {
        font-size: clamp(13px, 3.6vw, 15px);
        line-height: 1.4;
        margin-bottom: .8rem;
        color: #666;
      }

      /* プレビューの一文は"折返し優先"に。余白を少しだけ */
      .preview-msg,
      .unified-result-card .preview-msg {
        font-size: clamp(14px, 4vw, 16px);
        line-height: 1.6;
        white-space: normal;     /* pre-lineを解除して改行過多を抑える */
        text-wrap: pretty;       /* 対応環境のみ効く。未対応でも害なし */
        margin-bottom: .6rem;
      }

      /* ラベル/値の2列を"狭幅でも崩れない"1列グリッドに */
      .result-details {
        display: grid;
        grid-template-columns: 1fr;
        row-gap: .6rem;
      }
      .result-item {
        display: grid;
        grid-template-columns: auto 1fr;
        column-gap: .5rem;
        align-items: start;
      }
      .result-label {
        font-size: .95rem;
        line-height: 1.4;
        white-space: nowrap;
      }
      .result-value {
        font-size: 1rem;
        line-height: 1.6;
        word-break: break-word;  /* 長い学科名でも折れて見切れない */
      }

      /* エピソード見出し・本文の詰め */
      .episode-section { margin-top: .8rem; }
      .episode-title { font-size: .95rem; }

      /* "ひとくちエピソード"本文：改行を抑え、読みやすい行間に */
      #episodeMsg,
      .episode-msg,
      .narrative-text {
        white-space: normal;     /* pre-line→normal（見た目の改行だけに依存しない） */
        line-height: 1.7;
        letter-spacing: .01em;
      }
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Yu Gothic UI", "Yu Gothic", "Meiryo UI", "Meiryo", "MS PGothic", sans-serif !important;
      background: #2a2a2a;
      background-image: 
        linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 20px 20px;
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      margin-bottom: 30px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #dda0dd, #b0c4de);
      border-radius: 4px;
      transition: width 0.5s ease;
      width: 0%;
    }
    
    .question-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }
    
    .question-title {
      font-size: 1.2rem;
      color: #666;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .question-text {
      font-size: 1.5rem;
      color: #333;
      margin-bottom: 30px;
      text-align: center;
      font-weight: 600;
    }
    
    .answer-options {
      display: grid;
      gap: 15px;
    }
    
    .answer-option {
      padding: 20px;
      background: white;
      border: 2px solid #dda0dd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.1rem;
      text-align: center;
      color: #666;
    }
    
    .answer-option:hover {
      background: #f8f9fa;
      border-color: #c891c8;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(221, 160, 221, 0.3);
      color: #444;
    }
    
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
    }
    
    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
    }
    
    .back-btn:hover {
      background: #5a6268;
    }
    
    .back-btn:disabled {
      background: #e0e0e0;
      color: #999;
      cursor: not-allowed;
    }
    
    .result-container {
      display: none;
    }
    
    .result-card {
      background: rgba(240, 240, 240, 0.95);
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 600px;
      margin: 0 auto;
      color: #333;
    }
    
    .result-title {
      font-size: 2rem;
      color: #dda0dd;
      margin-bottom: 20px;
      font-weight: 700;
    }
    

    
    .result-item {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      font-size: 1.1rem;
    }
    
    .result-label {
      font-weight: 600;
      color: #666;
    }
    
    .result-value {
      font-weight: 700;
      color: #333;
    }
    
    .unified-result-section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 0;
      margin: 20px 0;
      text-align: left;
    }
    
    .preview-message {
      padding: 20px;
      border-left: 4px solid #dda0dd;
      margin-bottom: 0;
    }
    
    .result-details {
      background: none;
      border-radius: 0;
      padding: 20px;
      margin: 0;
      border-left: 4px solid transparent;
    }
    
    .episode-section {
      padding: 20px;
      background: none;
      border-radius: 0;
      border-left: 4px solid #98d7a5;
      text-align: left;
      margin: 0;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .episode-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .episode-text {
      color: #666;
      font-style: italic;
      font-size: 0.95rem;
      line-height: 1.5;
    }
    
    .buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 30px;
    }
    
    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #dda0dd, #b0c4de);
      color: white;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #98d7a5, #b0c4de);
      color: white;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .question-card {
        padding: 20px;
      }
      
      .question-text {
        font-size: 1.2rem;
      }
      
      .answer-option {
        padding: 15px;
        font-size: 1rem;
      }
      
      .buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
  
  <!-- showResult=true対応スクリプト -->
  <script>
         (function(){
       const p = new URLSearchParams(location.search);
       // showResult判定を統一（'1' or 'true' の両方を受け入れる）
       const isShowResult = p.get('showResult') === '1' || p.get('showResult') === 'true';
       if (isShowResult) {
        document.addEventListener('DOMContentLoaded', () => {
          // 既存要素のIDは現状のまま利用（無ければスキップ）
          const qc = document.getElementById('questionContainer');
          const rc = document.getElementById('resultContainer');
          if (qc) qc.style.display = 'none';
          if (rc) rc.style.display = 'block';

          // 既存の結果表示要素への最小値流し込み（存在チェックして安全に）
          const dept   = p.get('department') || '';
          const course = p.get('course') || '';
          const club   = p.get('club') || '';
          const pm     = p.get('previewMessage') || '';
          const em     = p.get('episodeMessage') || '';

          const rCourseEl = document.getElementById('resultCourse');
                     const rClubEl   = document.getElementById('resultClub');
           if (rCourseEl) rCourseEl.textContent = course || dept || rCourseEl.textContent;
           if (rClubEl)   rClubEl.textContent   = club || rClubEl.textContent;

          if (pm) { const el = document.getElementById('previewMsg'); if (el) el.textContent = pm; }
          if (em) { const el = document.getElementById('episodeMsg'); if (el) el.textContent = em; }
        });
      }
    })();
  </script>
</head>
<body>
  <div class="container">
    <!-- 進捗バー -->
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- 質問表示エリア -->
    <div id="questionContainer">
      <!-- 質問がここに表示される -->
    </div>

    <!-- 結果表示エリア -->
    <div class="result-container" id="resultContainer">
      <div class="result-card">
        <div class="result-title">診断結果発表！</div>
        <div style="font-size: 1.2rem; color: #666; margin-bottom: 20px;">あなたの学校生活は...</div>
        
        <div class="unified-result-section">
          <div class="preview-message">
            <div id="previewMsg" style="font-size: 1.1rem; color: #333; font-weight: 600; margin: 0;">
              <!-- プレビューメッセージ -->
            </div>
          </div>

          <div class="result-details">
            <div class="result-item">
              <span class="result-label">学科/コース</span>
              <span class="result-value" id="resultCourse">-</span>
            </div>
            <div class="result-item">
              <span class="result-label">部活動</span>
              <span class="result-value" id="resultClub">-</span>
            </div>
          </div>

          <div class="episode-section">
            <div class="episode-title">ひとくちエピソード</div>
            <div class="episode-text" id="episodeMsg">
              <!-- エピソードメッセージ -->
            </div>
          </div>
        </div>

        <div class="buttons">
          <button type="button" class="btn btn-primary" id="toGeneratorBtn">
            学生証を作成する
          </button>
          <button type="button" class="btn btn-secondary" id="restartBtn">
            診断をやり直す
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    console.log('🚀 シンプル診断ゲーム開始');

    // TypeSquareエラーの完全無視（メイン処理内）
    window.addEventListener('error', function(e) {
      if (e.message && (
        e.message.includes('typesquare') || 
        e.message.includes('ERR_BLOCKED_BY_CLIENT') ||
        e.message.includes('net::') ||
        e.message.includes('Failed to fetch') ||
        e.message.includes('entry.b8fdbc69.js')
      )) {
        console.warn('🔇 エラーを無視 (Quiz):', e.message);
        e.preventDefault();
        return true;
      }
    });

    window.addEventListener('unhandledrejection', function(e) {
      if (e.reason && (
        e.reason.toString().includes('typesquare') ||
        e.reason.toString().includes('ERR_BLOCKED_BY_CLIENT') ||
        e.reason.toString().includes('Failed to fetch')
      )) {
        console.warn('🔇 Promise rejection を無視 (Quiz)');
        e.preventDefault();
      }
    });

    // 質問データ
    const questions = [
      {
        q: '朝の支度、どんな感じ？',
        choices: [
          { text:'ぎりぎりまで寝てる', scores:{ course:'', club:'帰宅', vibe:4 } },
          { text:'支度は前日に完璧', scores:{ course:'特進コース', club:'', vibe:1 } },
          { text:'なんとなくでOK', scores:{ course:'', club:'美術', vibe:3 } },
          { text:'毎朝ドタバタしてる', scores:{ course:'', club:'ダンス', vibe:5 } }
        ]
      },
      {
        q: '授業中によくあることは？',
        choices: [
          { text:'つい落書きしてしまう', scores:{ course:'美術コース', club:'', vibe:3 } },
          { text:'ノートをきれいにまとめる', scores:{ course:'特進コース', club:'', vibe:1 } },
          { text:'夢の中', scores:{ course:'', club:'図書', vibe:2 } },
          { text:'友達にこっそりメモ渡す', scores:{ course:'', club:'文芸', vibe:4 } }
        ]
      },
      {
        q: 'お昼休みの過ごし方は？',
        choices: [
          { text:'友達とワイワイご飯', scores:{ course:'', club:'演劇', vibe:4 } },
          { text:'図書室でのんびり読書', scores:{ course:'', club:'図書', vibe:2 } },
          { text:'校庭で遊ぶ', scores:{ course:'', club:'陸上', vibe:3 } },
          { text:'購買ダッシュ', scores:{ course:'', club:'バスケットボール', vibe:5 } }
        ]
      },
      {
        q: '体育の時間といえば？',
        choices: [
          { text:'全力で勝ちにいく！', scores:{ course:'', club:'テニス', vibe:2 } },
          { text:'まあまあ楽しむ派', scores:{ course:'', club:'バレーボール', vibe:3 } },
          { text:'見学したい……', scores:{ course:'', club:'帰宅', vibe:1 } },
          { text:'体育祭だけ本気出す', scores:{ course:'', club:'ダンス', vibe:4 } }
        ]
      },
      {
        q: '放課後の予定は？',
        choices: [
          { text:'部活に全力！', scores:{ course:'', club:'吹奏楽', vibe:2 } },
          { text:'友達と寄り道', scores:{ course:'', club:'帰宅', vibe:4 } },
          { text:'即帰宅', scores:{ course:'', club:'帰宅', vibe:3 } },
          { text:'学校に残って自主練や自習', scores:{ course:'特進コース', club:'', vibe:1 } }
        ]
      },
      {
        q: 'テスト期間中、あなたは…？',
        choices: [
          { text:'計画的にコツコツ', scores:{ course:'特進コース', club:'', vibe:1 } },
          { text:'一夜漬け', scores:{ course:'', club:'帰宅', vibe:5 } },
          { text:'勉強会を開催', scores:{ course:'', club:'演劇', vibe:3 } },
          { text:'ノリと勢い', scores:{ course:'', club:'ダンス', vibe:4 } }
        ]
      },
      {
        q: '文化祭でやってみたいことは？',
        choices: [
          { text:'演劇やダンスのステージ', scores:{ course:'', club:'演劇', vibe:3 } },
          { text:'模擬店や屋台運営', scores:{ course:'', club:'バスケットボール', vibe:4 } },
          { text:'展示や制作系の出し物', scores:{ course:'美術コース', club:'', vibe:2 } },
          { text:'お化け屋敷や脱出ゲーム', scores:{ course:'', club:'ホラー布教', vibe:5 } }
        ]
      },
      {
        q: '忘れ物した時どうする？',
        choices: [
          { text:'正直に言って謝る', scores:{ course:'特進コース', club:'', vibe:1 } },
          { text:'誰かに借りる', scores:{ course:'', club:'演劇', vibe:3 } },
          { text:'そもそも気づかない', scores:{ course:'', club:'美術', vibe:4 } },
          { text:'なんとか誤魔化す', scores:{ course:'', club:'帰宅', vibe:5 } }
        ]
      },
      {
        q: 'テスト返却の日の気持ちは？',
        choices: [
          { text:'自信あり', scores:{ course:'特進コース', club:'', vibe:2 } },
          { text:'とにかく祈る', scores:{ course:'', club:'文芸', vibe:3 } },
          { text:'周りの点数が気になる', scores:{ course:'', club:'演劇', vibe:4 } },
          { text:'これ何の教科だっけ？', scores:{ course:'', club:'帰宅', vibe:5 } }
        ]
      },
      {
        q: '学校行事で一番燃えるのは？',
        choices: [
          { text:'体育祭', scores:{ course:'', club:'陸上', vibe:3 } },
          { text:'文化祭', scores:{ course:'', club:'演劇', vibe:4 } },
          { text:'合唱コンクール', scores:{ course:'音楽コース', club:'', vibe:2 } },
          { text:'修学旅行', scores:{ course:'英語コース', club:'', vibe:5 } }
        ]
      }
    ];

         // ゲーム状態
     let currentQuestion = 0;
     let scores = {
       course: { '特進コース': 0, '英語コース': 0, '音楽コース': 0, '美術コース': 0 },
       club: {},
       vibe: 0
     };

     // ── 部活グループ定義（要件どおり・増減禁止） ─────────────────
     const CLUB_GROUP = {
       sports: ['陸上','テニス','バドミントン','バスケットボール','バレーボール','水泳','ダンス'],
       culture: ['声楽','吹奏楽','絵画','彫刻','放送','英語研究','演劇','茶道','華道'],
       other:  ['帰宅'],
       rare:   ['ホラー布教']
     };

     // グループ判定 → グループ内で均等（レアは別枠）
     function chooseClubByGroup(tally) {
       // 1) グループ合算
       const sum = { sports:0, culture:0, other:0, rare:0 };
       for (const [club, v] of Object.entries(tally)) {
         if (CLUB_GROUP.sports.includes(club))  sum.sports += v;
         else if (CLUB_GROUP.culture.includes(club)) sum.culture += v;
         else if (CLUB_GROUP.other.includes(club))   sum.other += v;
         else if (CLUB_GROUP.rare.includes(club))    sum.rare += v;
       }

       // 2) レア判定（強いときだけ・それ以外は低確率に抑制）
       const maxMajor = Math.max(sum.sports, sum.culture, sum.other);
       if (sum.rare > 0 && sum.rare >= maxMajor * 1.2) return 'ホラー布教'; // 回答が強く示唆
       // 低確率での遊び（1〜2%）にしたいときは下行を有効化
       // if (Math.random() < 0.015) return 'ホラー布教';

       // 3) 上位グループを決める（±10%は同率扱い）
       const entries = Object.entries({sports:sum.sports,culture:sum.culture,other:sum.other});
       const topVal = Math.max(...entries.map(([,v])=>v));
       const tops = entries.filter(([,v]) => v >= topVal * 0.9).map(([k])=>k);

       // 4) 候補プール（上位グループの合併）から均等抽選
       const pool = tops.flatMap(g => CLUB_GROUP[g]);
       // 事前スコア（Laplace平滑：+1）で微調整しつつ極端な偏りを防ぐ
       const weights = pool.map(c => (tally[c] ?? 0) + 1);
       const total = weights.reduce((a,b)=>a+b,0);
       let r = Math.random() * total;
       for (let i=0;i<pool.length;i++){
         r -= weights[i];
         if (r <= 0) return pool[i];
       }
       return pool[0];
     }

     // 正規化テーブル（既存互換性のため残す）
     const CLUB_SET = [
       '陸上','テニス','バドミントン','バスケットボール','バレーボール','水泳','ダンス',
       '声楽','吹奏楽','絵画','彫刻','放送','英語研究','演劇','茶道','華道','帰宅','ホラー布教'
     ];
     const CLUB_WEIGHT = Object.fromEntries(CLUB_SET.map(k => [k, 1]));
     CLUB_WEIGHT['ホラー布教'] = 0.15; // レア

     function normalizeClub(raw) {
       if (!raw) return '';
       let c = String(raw).replace(/部$/,'');       // 語尾「部」を除去
       // 表記ゆれ吸収
       if (c === '軽音') c = '吹奏楽';
       if (c === '美術') c = '絵画';
       if (c === '文芸' || c === '図書') c = '英語研究';
       // 既定セット外は弾く
       return CLUB_SET.includes(c) ? c : '';
     }

    // 質問表示
    function showQuestion(index) {
      if (index >= questions.length) {
        showResult();
        return;
      }

      const question = questions[index];
      const container = document.getElementById('questionContainer');
      
             // 安全なHTML生成（元のデザインを維持）
       const choicesHTML = question.choices.map((choice, i) => 
         `<div class="answer-option" onclick="selectAnswer(${i})">${choice.text || '選択肢' + (i + 1)}</div>`
       ).join('');
       
       const backButtonHTML = index > 0 ? 
         `<button class="back-btn" onclick="goBack()">← 前の質問</button>` : 
         '<div></div>';
      
      container.innerHTML = `
        <div class="question-card">
          <div class="question-title">質問 ${index + 1} / ${questions.length}</div>
          <div class="question-text">${question.q || '質問が読み込めませんでした'}</div>
          <div class="answer-options">
            ${choicesHTML}
          </div>
          <div class="controls">
            ${backButtonHTML}
            <span style="color: #666;">${index + 1} / ${questions.length}</span>
          </div>
        </div>
      `;
      
             // 念のため、クリックイベントを手動で追加（デザインは変更しない）
       setTimeout(function() {
         const answerOptions = container.querySelectorAll('.answer-option');
         answerOptions.forEach((option, i) => {
           option.addEventListener('click', function(event) {
             console.log('🖱️ 選択肢クリック (手動):', i);
             event.preventDefault();
             event.stopPropagation();
             selectAnswer(i);
           });
         });
       }, 100);

      // 進捗バー更新
      const progress = ((index + 1) / questions.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
    }

    // 堅牢な回答処理（TypeSquareエラー対策強化版）
    function selectAnswer(answerIndex) {
      try {
        console.log('🎯 回答選択:', answerIndex, '(質問', currentQuestion + 1, ')');
        
        // 二重実行防止
        if (window.answerProcessing) {
          console.log('⏸️ 処理中のため無視');
          return;
        }
        window.answerProcessing = true;
        
        // 安全性チェック
        if (typeof answerIndex !== 'number' || answerIndex < 0) {
          console.error('❌ 無効な回答インデックス:', answerIndex);
          window.answerProcessing = false;
          return;
        }
        
        const question = questions[currentQuestion];
        if (!question || !question.choices || !question.choices[answerIndex]) {
          console.error('❌ 無効な質問または選択肢:', currentQuestion, answerIndex);
          window.answerProcessing = false;
          return;
        }
        
        const choice = question.choices[answerIndex];
        console.log('📝 選択した回答:', choice.text);
        
                 // スコア計算（エラーハンドリング付き）
         try {
           if (choice.scores.course) {
             scores.course[choice.scores.course] = (scores.course[choice.scores.course] || 0) + 1;
           }
           if (choice.scores.club) {
             const club = normalizeClub(choice.scores.club);
             if (club) scores.club[club] = (scores.club[club] || 0) + 1;
           }
           scores.vibe += choice.scores.vibe || 0;
          
          console.log('📊 現在のスコア:', { course: scores.course, club: Object.keys(scores.club).length, vibe: scores.vibe });
        } catch (scoreError) {
          console.error('❌ スコア計算エラー:', scoreError);
        }
        
        // 次の質問へ進む
        currentQuestion++;
        console.log('➡️ 次の質問へ:', currentQuestion);
        
        // 遅延実行でUI更新
        setTimeout(function() {
          try {
            showQuestion(currentQuestion);
          } catch (showError) {
            console.error('❌ 質問表示エラー:', showError);
            // 強制的に次に進む
            if (currentQuestion < questions.length) {
              currentQuestion++;
              showQuestion(currentQuestion);
            } else {
              showResult();
            }
          } finally {
            window.answerProcessing = false;
          }
        }, 300);
        
      } catch (error) {
        console.error('❌ 回答処理の重大エラー:', error);
        alert('エラーが発生しましたが、次の質問に進みます。');
        
        // 緊急復旧処理
        try {
          currentQuestion++;
          if (currentQuestion >= questions.length) {
            showResult();
          } else {
            showQuestion(currentQuestion);
          }
        } catch (recoveryError) {
          console.error('❌ 復旧処理エラー:', recoveryError);
          // 最後の手段：結果画面に強制遷移
          showResult();
        } finally {
          window.answerProcessing = false;
        }
      }
    }
    
    // グローバルに selectAnswer を確実に定義
    window.selectAnswer = selectAnswer;

    // 戻る
    function goBack() {
      if (currentQuestion > 0) {
        currentQuestion--;
        showQuestion(currentQuestion);
      }
    }

    // 結果計算
    function calculateResult() {
      // コース決定
      const courseEntries = Object.entries(scores.course);
      const topCourse = courseEntries.reduce((a, b) => a[1] > b[1] ? a : b);
      const courseName = topCourse[0];
      
      let department, course, displayCourse;
      switch(courseName) {
        case '特進コース':
          department = '普通科';
          course = '特進';
          displayCourse = '普通科（特進コース）';
          break;
        case '英語コース':
          department = '普通科';
          course = '英語';
          displayCourse = '普通科（英語コース）';
          break;
        case '音楽コース':
          department = '芸術科';
          course = '音楽';
          displayCourse = '芸術科（音楽コース）';
          break;
        case '美術コース':
          department = '芸術科';
          course = '美術';
          displayCourse = '芸術科（美術コース）';
          break;
        default:
          department = '普通科';
          course = '一般';
          displayCourse = '普通科（一般コース）';
      }
      
             // 部活決定（グループ優先の均等化）
       const club = chooseClubByGroup(scores.club);
      
      return { department, course, displayCourse, club };
    }

    // プレビューメッセージ
    const previewMessages = [
      "${club}での活動が話題に！注目の存在です。",
      "${club}のエースとして期待も大きいとか。",
      "学業と${club}での経験が見事にマッチしています。",
      "${club}で披露したパフォーマンスが印象的でした。",
      "${club}の活動に打ち込む姿は、みんなから一目置かれています。"
    ];

    const episodes = [
      "給食のゼリーを毎日友達とジャンケンで奪い合っている。",
      "教室の隅っこでこっそり折り紙を量産している。",
      "掃除の時間、ほうきでエアギターを始めがち。",
      "体育の準備運動に全力すぎて毎回笑いが起きる。",
      "宿題を忘れても「風のせい」と言い訳して乗り切る天才。",
      "朝の挨拶がでかすぎて隣の教室まで聞こえる。",
      "黒板に書いたイラストを勝手に\"連載化\"している。",
      "ノートの端に毎回変なキャラが登場している。",
      "図書室の隅でなぜか紙芝居をしていたことがある。",
      "美術室で絵の具のフタを開ける係を勝手にしている。"
    ];

    // 結果表示
    function showResult() {
      document.getElementById('questionContainer').style.display = 'none';
      document.getElementById('resultContainer').style.display = 'block';
      
      const result = calculateResult();
      
             document.getElementById('resultCourse').textContent = result.displayCourse;
       
       // 表示は語尾「部」を付けない（カード画像に表記あり）
       document.getElementById('resultClub').textContent = result.club;
       
       // プレビューメッセージ
       const msgTemplate = previewMessages[Math.floor(Math.random() * previewMessages.length)];
       const previewMessage = msgTemplate.replace('${club}', result.club);
      document.getElementById('previewMsg').textContent = previewMessage;
      
      // エピソード
      const episode = episodes[Math.floor(Math.random() * episodes.length)];
      document.getElementById('episodeMsg').textContent = episode;
      
      // ボタン設定
      document.getElementById('toGeneratorBtn').onclick = () => {
        // 画像側に「部」が印字済みのため、テキストには付けない
        const baseClubMap = {
          '陸上': '陸上', 'テニス': 'テニス', 'バドミントン': 'バドミントン',
          'バスケットボール': 'バスケットボール', 'バレーボール': 'バレーボール',
          '水泳': '水泳', 'ダンス': 'ダンス',
          '声楽': '声楽', '吹奏楽': '吹奏楽', '絵画': '絵画', '彫刻': '彫刻',
          '放送': '放送', '英語研究': '英語研究', '演劇': '演劇', '茶道': '茶道', '華道': '華道',
          '帰宅': '帰宅', 'なし': '帰宅'
        };
        
        const normalizeClub = (raw) => {
          const s = (raw || '').replace(/部$/,'');
          if (!s) return '帰宅';
          return baseClubMap[s] ?? s;
        };
        const mappedClub = normalizeClub(result.club);
        
        const url = new URL('generator.html', window.location.href);
        url.searchParams.set('department', result.department);
        url.searchParams.set('course', result.course);
        url.searchParams.set('club', mappedClub);
        url.searchParams.set('previewMessage', previewMessage);
        url.searchParams.set('episodeMessage', episode);
        
        // embedパラメータを引き継ぐ
        if (window.location.search.includes('embed=1')) {
          url.searchParams.set('embed', '1');
        }
        
        window.location.href = url.toString();
      };
      
      document.getElementById('restartBtn').onclick = () => {
        window.location.reload();
      };
    }

    // 診断ゲーム初期化（TypeSquareエラー対策強化版）
    function initializeQuiz() {
      try {
        console.log('🚀 診断ゲーム初期化開始');
        
        // DOM要素の存在確認
        const questionContainer = document.getElementById('questionContainer');
        const progressFill = document.getElementById('progressFill');
        
        if (!questionContainer) {
          console.error('❌ questionContainer が見つかりません');
          document.body.innerHTML = '<div style="text-align: center; padding: 50px; color: red;">エラー: 診断ゲームを読み込めませんでした。ページを再読み込みしてください。</div>';
          return;
        }
        
        if (!progressFill) {
          console.warn('⚠️ progressFill が見つかりません（進捗バーなしで続行）');
        }
        
        // グローバル関数の確認・修正
        if (typeof window.selectAnswer !== 'function') {
          console.warn('⚠️ selectAnswer関数を再定義');
          window.selectAnswer = selectAnswer;
        }
        
        if (typeof window.goBack !== 'function') {
          console.warn('⚠️ goBack関数を再定義');
          window.goBack = goBack;
        }
        
        // 質問データの検証
        if (!questions || questions.length === 0) {
          console.error('❌ 質問データが見つかりません');
          questionContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: red;">エラー: 質問データが読み込めませんでした。</div>';
          return;
        }
        
                 console.log('✅ 診断ゲーム初期化完了:', questions.length + '問');
         
         // デバッグモード（開発時のみ表示）
         if (window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1')) {
           console.log('🔧 デバッグ: selectAnswer関数確認:', typeof window.selectAnswer);
           console.log('🔧 デバッグ: goBack関数確認:', typeof window.goBack);
         }
         
         // 最初の質問を表示
         showQuestion(0);
         
         // 動作確認（開発時のみ）
         if (window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1')) {
           setTimeout(function() {
             const firstOption = document.querySelector('.answer-option');
             if (firstOption) {
               console.log('✅ 選択肢が正常に表示されています。');
             } else {
               console.error('❌ 選択肢が見つかりません');
             }
           }, 3000);
         }
        
      } catch (error) {
        console.error('❌ 診断ゲーム初期化エラー:', error);
        document.body.innerHTML = '<div style="text-align: center; padding: 50px; color: red;">重大エラー: 診断ゲームを開始できませんでした。<br><button type="button" onclick="location.reload()">ページを再読み込み</button></div>';
      }
    }
    
    // showResult=1の場合は初期化をスキップ
    const params = new URLSearchParams(location.search);
    const showResult = params.get('showResult');
    
    if (showResult !== '1') {
      // 複数の方法で初期化を試行
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeQuiz);
      } else {
        // すでに読み込み完了している場合は即座に実行
        initializeQuiz();
      }
      
      // 念のため、少し遅延してからも実行
      setTimeout(function() {
        if (!document.getElementById('questionContainer').innerHTML.trim()) {
          console.warn('⚠️ 遅延初期化を実行');
          initializeQuiz();
        }
      }, 1000);
    }
  </script>
  
  <!-- 埋め込みモード制御スクリプト -->
  <script src="assets/js/embed-mode.js" defer></script>
</body>
</html> 