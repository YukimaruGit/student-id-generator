<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ _headers ã§çµ±ä¸€ç®¡ç†ï¼ˆStudioåŸ‹ã‚è¾¼ã¿è¨±å¯ï¼‰ -->
  
  <title>æ”¾èª²å¾Œã‚¯ãƒ­ãƒ‹ã‚¯ãƒ« â€• è¨ºæ–­ã‚²ãƒ¼ãƒ </title>
  

  
  <!-- æœ€å„ªå…ˆTypeSquareå®Œå…¨é®æ–­ã‚·ã‚¹ãƒ†ãƒ  -->
  <script>
    (function() {
      'use strict';
      
      // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã¯éå‰°ã‚®ãƒŸãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–
      if (location.protocol === 'file:') { return; }
      
      // å®‰å…¨ãªã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¹—ã£å–ã‚Šï¼ˆF12é–‹æ”¾æ™‚ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼‰
      let originalError, originalWarn, originalLog;
      
      try {
        originalError = console.error;
        originalWarn = console.warn;
        originalLog = console.log;
        
        console.error = function(...args) {
          try {
            const message = args.join(' ');
            if (message.includes('typesquare') || 
                message.includes('ERR_BLOCKED_BY_CLIENT') ||
                message.includes('Failed to load resource') ||
                message.includes('net::') ||
                message.includes('GET https://l.typesquare.com') ||
                message.includes('Uncaught (in promise) n') ||
                (message.includes('Uncaught') && message.includes('typesquare'))) {
              return; // å®Œå…¨ã«ç„¡è¦–
            }
            return originalError.apply(console, args);
          } catch(e) {
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«æ“ä½œã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯å…ƒã®é–¢æ•°ã‚’ä½¿ç”¨
            return originalError.apply(console, args);
          }
        };
        
        console.warn = function(...args) {
          try {
            const message = args.join(' ');
            if (message.includes('typesquare') || message.includes('ERR_BLOCKED_BY_CLIENT')) {
              return; // å®Œå…¨ã«ç„¡è¦–
            }
            return originalWarn.apply(console, args);
          } catch(e) {
            return originalWarn.apply(console, args);
          }
        };
      } catch(consoleError) {
        console.log('âš ï¸ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¹—ã£å–ã‚Šã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã€ã‚¹ã‚­ãƒƒãƒ—');
      }
      
      // å…¨ã¦ã®ã‚¨ãƒ©ãƒ¼ã¨Promise rejectionsã‚’å³åº§ã«æ•æ‰
      window.addEventListener('error', function(e) {
        if (e.filename && (
          e.filename.includes('typesquare') || 
          e.filename.includes('ts?') ||
          e.filename.includes('entry.') ||
          e.filename.includes('l.typesquare.com')
        )) {
          e.stopImmediatePropagation();
          e.preventDefault();
          return false;
        }
        if (e.message && (
          e.message.includes('typesquare') ||
          e.message.includes('ERR_BLOCKED_BY_CLIENT') ||
          e.message.includes('Failed to load resource') ||
          e.message.includes('net::ERR_')
        )) {
          e.stopImmediatePropagation();
          e.preventDefault();
          return false;
        }
      }, true);
      
      window.addEventListener('unhandledrejection', function(e) {
        if (e.reason) {
          const reason = e.reason.toString();
          if (reason.includes('typesquare') ||
              reason.includes('ERR_BLOCKED_BY_CLIENT') ||
              reason.includes('Failed to fetch') ||
              reason.includes('net::ERR_')) {
            e.stopImmediatePropagation();
            e.preventDefault();
            return false;
          }
        }
      }, true);
      
      // TypeSquareé–¢é€£å¤‰æ•°ã‚’å®‰å…¨ã«ãƒ–ãƒ­ãƒƒã‚¯
      const blockedVariables = ['ts', 'TypeSquare', 'Typekit', 'WebFont', 'Ts', 'TS', 'typesquare'];
      blockedVariables.forEach(varName => {
        try {
          // æ—¢ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (window.hasOwnProperty(varName)) {
            console.log('ğŸš« æ—¢å­˜ã®å¤‰æ•°ã‚’nullã«è¨­å®š:', varName);
            try {
              window[varName] = null;
            } catch(setError) {
              console.warn('âš ï¸ å¤‰æ•°è¨­å®šå¤±æ•—:', varName, setError);
            }
          } else {
            // æ–°è¦å®šç¾©
            Object.defineProperty(window, varName, {
              get: function() { return null; },
              set: function() { return false; },
              configurable: true,
              enumerable: false
            });
            console.log('ğŸš« æ–°è¦å¤‰æ•°ãƒ–ãƒ­ãƒƒã‚¯è¨­å®š:', varName);
          }
        } catch(e) {
          console.warn('âš ï¸ å¤‰æ•°ãƒ–ãƒ­ãƒƒã‚¯è¨­å®šå¤±æ•—:', varName, e.message);
        }
      });
      
      // fetchã¨XMLHttpRequestã‚’ãƒ•ãƒƒã‚¯ã—ã¦TypeSquareãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯
      const originalFetch = window.fetch;
      if (originalFetch) {
        window.fetch = function(url, options) {
          if (typeof url === 'string' && (
            url.includes('typesquare') || 
            url.includes('l.typesquare.com') ||
            url.includes('ts?condition=')
          )) {
            console.log('ğŸš« TypeSquare fetchãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯:', url);
            return Promise.reject(new Error('TypeSquare request blocked'));
          }
          return originalFetch.apply(this, arguments);
        };
      }
      
      const originalXHROpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function(method, url) {
        if (typeof url === 'string' && (
          url.includes('typesquare') ||
          url.includes('l.typesquare.com') ||
          url.includes('ts?condition=')
        )) {
          console.log('ğŸš« TypeSquare XHRãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯:', url);
          return;
        }
        return originalXHROpen.apply(this, arguments);
      };
      
      // MutationObserverã§TypeSquareã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‹•çš„è¿½åŠ ã‚’ç›£è¦–ãƒ»ãƒ–ãƒ­ãƒƒã‚¯
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1) { // Element node
              // TypeSquareé–¢é€£ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„ãƒªãƒ³ã‚¯ã‚’å³åº§ã«å‰Šé™¤
              if (node.src && (
                node.src.includes('typesquare') || 
                node.src.includes('entry.') ||
                node.src.includes('l.typesquare.com')
              )) {
                node.remove();
                console.log('ğŸš« TypeSquareã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‰Šé™¤:', node.src);
              }
              if (node.href && node.href.includes('typesquare')) {
                node.remove();
                console.log('ğŸš« TypeSquareãƒªãƒ³ã‚¯ã‚’å‰Šé™¤:', node.href);
              }
              // å­è¦ç´ ã‚‚ãƒã‚§ãƒƒã‚¯
              const typeSquareElements = node.querySelectorAll && node.querySelectorAll('[src*="typesquare"], [href*="typesquare"], [src*="entry."], [src*="l.typesquare.com"]');
              if (typeSquareElements) {
                typeSquareElements.forEach(el => {
                  el.remove();
                  console.log('ğŸš« TypeSquareå­è¦ç´ ã‚’å‰Šé™¤');
                });
              }
            }
          });
        });
      });
      
      // DOMå…¨ä½“ã‚’ç›£è¦–é–‹å§‹
      observer.observe(document, {
        childList: true,
        subtree: true
      });
      
      console.log('ğŸ›¡ï¸ æœ€å¼·TypeSquareé®æ–­ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†ï¼ˆDOMç›£è¦–å«ã‚€ï¼‰');
    })();
  </script>
  
  <!-- TypeSquareã‚¨ãƒ©ãƒ¼å¯¾ç­–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    (function() {
      'use strict';
      
      // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã¯éå‰°ã‚®ãƒŸãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–
      if (location.protocol === 'file:') { return; }
      
      console.log('ğŸ›¡ï¸ TypeSquareã‚¨ãƒ©ãƒ¼å¯¾ç­–ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ï¼ˆQuizç‰ˆï¼‰');
      
      // TypeSquareã‚¨ãƒ©ãƒ¼æ¤œå‡ºã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
      let typeSquareErrorCount = 0;
      
      // ã™ã¹ã¦ã®TypeSquareã‚¨ãƒ©ãƒ¼ã‚’æŠ‘åˆ¶
      window.addEventListener('error', function(e) {
        if (e.filename && (
          e.filename.includes('typesquare') || 
          e.filename.includes('ts?') ||
          e.filename.includes('entry.') ||
          e.message.includes('typesquare') ||
          e.message.includes('ERR_BLOCKED_BY_CLIENT')
        )) {
          typeSquareErrorCount++;
          console.warn('ğŸš« TypeSquareã‚¨ãƒ©ãƒ¼ã‚’ç„¡åŠ¹åŒ– (Quiz):', e.message, '(ã‚«ã‚¦ãƒ³ãƒˆ:', typeSquareErrorCount, ')');
          e.stopImmediatePropagation();
          e.preventDefault();
          return false;
        }
      }, true);
      
      window.addEventListener('unhandledrejection', function(e) {
        if (e.reason && (
          e.reason.toString().includes('typesquare') ||
          e.reason.toString().includes('ERR_BLOCKED_BY_CLIENT') ||
          e.reason.toString().includes('Failed to fetch')
        )) {
          typeSquareErrorCount++;
          console.warn('ğŸš« TypeSquare Promise rejection ã‚’ç„¡åŠ¹åŒ– (Quiz) (ã‚«ã‚¦ãƒ³ãƒˆ:', typeSquareErrorCount, ')');
          e.stopImmediatePropagation();
          e.preventDefault();
          return false;
        }
      }, true);
      
      // TypeSquareé–¢é€£ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ç„¡åŠ¹åŒ–
      const tsVariables = ['ts', 'TypeSquare', 'Typekit', 'WebFont', 'Ts', 'TS'];
      tsVariables.forEach(varName => {
        Object.defineProperty(window, varName, {
          get: function() { return null; },
          set: function() { console.warn('ğŸš« TypeSquareå¤‰æ•°è¨­å®šã‚’é˜»æ­¢ (Quiz):', varName); },
          configurable: false,
          enumerable: false
        });
      });
      
      // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã‚‚æŠ‘åˆ¶
      const originalConsoleError = console.error;
      console.error = function(...args) {
        const message = args.join(' ');
        if (message.includes('typesquare') || 
            message.includes('ERR_BLOCKED_BY_CLIENT') ||
            message.includes('Failed to load resource')) {
          console.warn('ğŸ”‡ TypeSquareã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’æŠ‘åˆ¶ (Quiz):', message);
          return;
        }
        return originalConsoleError.apply(console, args);
      };
      
      console.log('âœ… TypeSquareã‚¨ãƒ©ãƒ¼å¯¾ç­–å®Œäº†ï¼ˆQuizç‰ˆï¼‰');
    })();
  </script>
  
  <style>
    /* TypeSquareã¨Studioç’°å¢ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Œå…¨ç„¡åŠ¹åŒ– */
    link[href*="typesquare"], 
    script[src*="typesquare"],
    script[src*="entry."],
    script[src*="l.typesquare.com"],
    iframe[src*="typesquare"],
    *[data-typesquare],
    *[class*="typesquare"],
    *[id*="typesquare"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
      position: absolute !important;
      left: -9999px !important;
      top: -9999px !important;
      width: 0 !important;
      height: 0 !important;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ===== iPhoneç­‰ã®ç‹­å¹… æœ€é©åŒ–ï¼ˆè¦‹ãŸç›®ã¯æ®ãˆç½®ãï¼‰ ===== */
    @media (max-width: 430px) {
      /* å…¨ä½“ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è©°ã‚ã¦å†…å®¹å¹…ã‚’ç¢ºä¿ */
      .diagnosis-container {
        padding: 0.75rem;
        margin: 0.75rem auto;
        max-width: 92vw;
      }

      /* çµæœã‚«ãƒ¼ãƒ‰ï¼šå†…å´ã‚’å°‘ã—è©°ã‚ã‚‹ */
      .result-card,
      .unified-result-card {
        padding: 0.9rem 0.9rem 1rem;
        border-radius: 12px;
      }

      /* ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã¯clampã§è‡ªå‹•èª¿æ•´ã—ã€è¡Œé–“ã‚’ç· ã‚ã‚‹ */
      .result-title {
        font-size: clamp(18px, 4.8vw, 22px);
        line-height: 1.25;
        letter-spacing: .03em;
        margin-bottom: .4rem;
        text-align: left; /* ä¸­å¤®ã§ã‚‚å¯ã€‚å·¦ã ã¨æ”¹è¡ŒãŒæ•´ã† */
      }
      .result-subtitle {
        font-size: clamp(13px, 3.6vw, 15px);
        line-height: 1.4;
        margin-bottom: .8rem;
        color: #666;
      }

      /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ä¸€æ–‡ã¯"æŠ˜è¿”ã—å„ªå…ˆ"ã«ã€‚ä½™ç™½ã‚’å°‘ã—ã ã‘ */
      .preview-msg,
      .unified-result-card .preview-msg {
        font-size: clamp(14px, 4vw, 16px);
        line-height: 1.6;
        white-space: normal;     /* pre-lineã‚’è§£é™¤ã—ã¦æ”¹è¡Œéå¤šã‚’æŠ‘ãˆã‚‹ */
        text-wrap: pretty;       /* å¯¾å¿œç’°å¢ƒã®ã¿åŠ¹ãã€‚æœªå¯¾å¿œã§ã‚‚å®³ãªã— */
        margin-bottom: .6rem;
      }

      /* ãƒ©ãƒ™ãƒ«/å€¤ã®2åˆ—ã‚’"ç‹­å¹…ã§ã‚‚å´©ã‚Œãªã„"1åˆ—ã‚°ãƒªãƒƒãƒ‰ã« */
      .result-details {
        display: grid;
        grid-template-columns: 1fr;
        row-gap: .6rem;
      }
      .result-item {
        display: grid;
        grid-template-columns: auto 1fr;
        column-gap: .5rem;
        align-items: start;
      }
      .result-label {
        font-size: .95rem;
        line-height: 1.4;
        white-space: nowrap;
      }
      .result-value {
        font-size: 1rem;
        line-height: 1.6;
        word-break: break-word;  /* é•·ã„å­¦ç§‘åã§ã‚‚æŠ˜ã‚Œã¦è¦‹åˆ‡ã‚Œãªã„ */
      }

      /* ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰è¦‹å‡ºã—ãƒ»æœ¬æ–‡ã®è©°ã‚ */
      .episode-section { margin-top: .8rem; }
      .episode-title { font-size: .95rem; }

      /* "ã²ã¨ãã¡ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰"æœ¬æ–‡ï¼šæ”¹è¡Œã‚’æŠ‘ãˆã€èª­ã¿ã‚„ã™ã„è¡Œé–“ã« */
      #episodeMsg,
      .episode-msg,
      .narrative-text {
        white-space: normal;     /* pre-lineâ†’normalï¼ˆè¦‹ãŸç›®ã®æ”¹è¡Œã ã‘ã«ä¾å­˜ã—ãªã„ï¼‰ */
        line-height: 1.7;
        letter-spacing: .01em;
      }
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Yu Gothic UI", "Yu Gothic", "Meiryo UI", "Meiryo", "MS PGothic", sans-serif !important;
      background: #2a2a2a;
      background-image: 
        linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 20px 20px;
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      margin-bottom: 30px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #dda0dd, #b0c4de);
      border-radius: 4px;
      transition: width 0.5s ease;
      width: 0%;
    }
    
    .question-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }
    
    .question-title {
      font-size: 1.2rem;
      color: #666;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .question-text {
      font-size: 1.5rem;
      color: #333;
      margin-bottom: 30px;
      text-align: center;
      font-weight: 600;
    }
    
    .answer-options {
      display: grid;
      gap: 15px;
    }
    
    .answer-option {
      padding: 20px;
      background: white;
      border: 2px solid #dda0dd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.1rem;
      text-align: center;
      color: #666;
    }
    
    .answer-option:hover {
      background: #f8f9fa;
      border-color: #c891c8;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(221, 160, 221, 0.3);
      color: #444;
    }
    
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
    }
    
    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
    }
    
    .back-btn:hover {
      background: #5a6268;
    }
    
    .back-btn:disabled {
      background: #e0e0e0;
      color: #999;
      cursor: not-allowed;
    }
    
    .result-container {
      display: none;
    }
    
    .result-card {
      background: rgba(240, 240, 240, 0.95);
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 600px;
      margin: 0 auto;
      color: #333;
    }
    
    .result-title {
      font-size: 2rem;
      color: #dda0dd;
      margin-bottom: 20px;
      font-weight: 700;
    }
    

    
    .result-item {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      font-size: 1.1rem;
    }
    
    .result-label {
      font-weight: 600;
      color: #666;
    }
    
    .result-value {
      font-weight: 700;
      color: #333;
    }
    
    .unified-result-section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 0;
      margin: 20px 0;
      text-align: left;
    }
    
    .preview-message {
      padding: 20px;
      border-left: 4px solid #dda0dd;
      margin-bottom: 0;
    }
    
    .result-details {
      background: none;
      border-radius: 0;
      padding: 20px;
      margin: 0;
      border-left: 4px solid transparent;
    }
    
    .episode-section {
      padding: 20px;
      background: none;
      border-radius: 0;
      border-left: 4px solid #98d7a5;
      text-align: left;
      margin: 0;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .episode-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .episode-text {
      color: #666;
      font-style: italic;
      font-size: 0.95rem;
      line-height: 1.5;
    }
    
    .buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 30px;
    }
    
    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #dda0dd, #b0c4de);
      color: white;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #98d7a5, #b0c4de);
      color: white;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .question-card {
        padding: 20px;
      }
      
      .question-text {
        font-size: 1.2rem;
      }
      
      .answer-option {
        padding: 15px;
        font-size: 1rem;
      }
      
      .buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
  
  <!-- showResult=trueå¯¾å¿œã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
         (function(){
       const p = new URLSearchParams(location.search);
       // showResultåˆ¤å®šã‚’çµ±ä¸€ï¼ˆ'1' or 'true' ã®ä¸¡æ–¹ã‚’å—ã‘å…¥ã‚Œã‚‹ï¼‰
       const isShowResult = p.get('showResult') === '1' || p.get('showResult') === 'true';
       if (isShowResult) {
        document.addEventListener('DOMContentLoaded', () => {
          // æ—¢å­˜è¦ç´ ã®IDã¯ç¾çŠ¶ã®ã¾ã¾åˆ©ç”¨ï¼ˆç„¡ã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          const qc = document.getElementById('questionContainer');
          const rc = document.getElementById('resultContainer');
          if (qc) qc.style.display = 'none';
          if (rc) rc.style.display = 'block';

          // æ—¢å­˜ã®çµæœè¡¨ç¤ºè¦ç´ ã¸ã®æœ€å°å€¤æµã—è¾¼ã¿ï¼ˆå­˜åœ¨ãƒã‚§ãƒƒã‚¯ã—ã¦å®‰å…¨ã«ï¼‰
          const dept   = p.get('department') || '';
          const course = p.get('course') || '';
          const club   = p.get('club') || '';
          const pm     = p.get('previewMessage') || '';
          const em     = p.get('episodeMessage') || '';

          const rCourseEl = document.getElementById('resultCourse');
                     const rClubEl   = document.getElementById('resultClub');
           if (rCourseEl) rCourseEl.textContent = course || dept || rCourseEl.textContent;
           if (rClubEl)   rClubEl.textContent   = club || rClubEl.textContent;

          if (pm) { const el = document.getElementById('previewMsg'); if (el) el.textContent = pm; }
          if (em) { const el = document.getElementById('episodeMsg'); if (el) el.textContent = em; }
        });
      }
    })();
  </script>
</head>
<body>
  <div class="container">
    <!-- é€²æ—ãƒãƒ¼ -->
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- è³ªå•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="questionContainer">
      <!-- è³ªå•ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
    </div>

    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="result-container" id="resultContainer">
      <div class="result-card">
        <div class="result-title">è¨ºæ–­çµæœç™ºè¡¨ï¼</div>
        <div style="font-size: 1.2rem; color: #666; margin-bottom: 20px;">ã‚ãªãŸã®å­¦æ ¡ç”Ÿæ´»ã¯...</div>
        
        <div class="unified-result-section">
          <div class="preview-message">
            <div id="previewMsg" style="font-size: 1.1rem; color: #333; font-weight: 600; margin: 0;">
              <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            </div>
          </div>

          <div class="result-details">
            <div class="result-item">
              <span class="result-label">å­¦ç§‘/ã‚³ãƒ¼ã‚¹</span>
              <span class="result-value" id="resultCourse">-</span>
            </div>
            <div class="result-item">
              <span class="result-label">éƒ¨æ´»å‹•</span>
              <span class="result-value" id="resultClub">-</span>
            </div>
          </div>

          <div class="episode-section">
            <div class="episode-title">ã²ã¨ãã¡ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰</div>
            <div class="episode-text" id="episodeMsg">
              <!-- ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            </div>
          </div>
        </div>

        <div class="buttons">
          <button type="button" class="btn btn-primary" id="toGeneratorBtn">
            å­¦ç”Ÿè¨¼ã‚’ä½œæˆã™ã‚‹
          </button>
          <button type="button" class="btn btn-secondary" id="restartBtn">
            è¨ºæ–­ã‚’ã‚„ã‚Šç›´ã™
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    console.log('ğŸš€ ã‚·ãƒ³ãƒ—ãƒ«è¨ºæ–­ã‚²ãƒ¼ãƒ é–‹å§‹');

    // TypeSquareã‚¨ãƒ©ãƒ¼ã®å®Œå…¨ç„¡è¦–ï¼ˆãƒ¡ã‚¤ãƒ³å‡¦ç†å†…ï¼‰
    window.addEventListener('error', function(e) {
      if (e.message && (
        e.message.includes('typesquare') || 
        e.message.includes('ERR_BLOCKED_BY_CLIENT') ||
        e.message.includes('net::') ||
        e.message.includes('Failed to fetch') ||
        e.message.includes('entry.b8fdbc69.js')
      )) {
        console.warn('ğŸ”‡ ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦– (Quiz):', e.message);
        e.preventDefault();
        return true;
      }
    });

    window.addEventListener('unhandledrejection', function(e) {
      if (e.reason && (
        e.reason.toString().includes('typesquare') ||
        e.reason.toString().includes('ERR_BLOCKED_BY_CLIENT') ||
        e.reason.toString().includes('Failed to fetch')
      )) {
        console.warn('ğŸ”‡ Promise rejection ã‚’ç„¡è¦– (Quiz)');
        e.preventDefault();
      }
    });

    // è³ªå•ãƒ‡ãƒ¼ã‚¿
    const questions = [
      {
        q: 'æœã®æ”¯åº¦ã€ã©ã‚“ãªæ„Ÿã˜ï¼Ÿ',
        choices: [
          { text:'ãã‚Šãã‚Šã¾ã§å¯ã¦ã‚‹', scores:{ course:'', club:'å¸°å®…', vibe:4 } },
          { text:'æ”¯åº¦ã¯å‰æ—¥ã«å®Œç’§', scores:{ course:'ç‰¹é€²ã‚³ãƒ¼ã‚¹', club:'', vibe:1 } },
          { text:'ãªã‚“ã¨ãªãã§OK', scores:{ course:'', club:'ç¾è¡“', vibe:3 } },
          { text:'æ¯æœãƒ‰ã‚¿ãƒã‚¿ã—ã¦ã‚‹', scores:{ course:'', club:'ãƒ€ãƒ³ã‚¹', vibe:5 } }
        ]
      },
      {
        q: 'æˆæ¥­ä¸­ã«ã‚ˆãã‚ã‚‹ã“ã¨ã¯ï¼Ÿ',
        choices: [
          { text:'ã¤ã„è½æ›¸ãã—ã¦ã—ã¾ã†', scores:{ course:'ç¾è¡“ã‚³ãƒ¼ã‚¹', club:'', vibe:3 } },
          { text:'ãƒãƒ¼ãƒˆã‚’ãã‚Œã„ã«ã¾ã¨ã‚ã‚‹', scores:{ course:'ç‰¹é€²ã‚³ãƒ¼ã‚¹', club:'', vibe:1 } },
          { text:'å¤¢ã®ä¸­', scores:{ course:'', club:'å›³æ›¸', vibe:2 } },
          { text:'å‹é”ã«ã“ã£ãã‚Šãƒ¡ãƒ¢æ¸¡ã™', scores:{ course:'', club:'æ–‡èŠ¸', vibe:4 } }
        ]
      },
      {
        q: 'ãŠæ˜¼ä¼‘ã¿ã®éã”ã—æ–¹ã¯ï¼Ÿ',
        choices: [
          { text:'å‹é”ã¨ãƒ¯ã‚¤ãƒ¯ã‚¤ã”é£¯', scores:{ course:'', club:'æ¼”åŠ‡', vibe:4 } },
          { text:'å›³æ›¸å®¤ã§ã®ã‚“ã³ã‚Šèª­æ›¸', scores:{ course:'', club:'å›³æ›¸', vibe:2 } },
          { text:'æ ¡åº­ã§éŠã¶', scores:{ course:'', club:'é™¸ä¸Š', vibe:3 } },
          { text:'è³¼è²·ãƒ€ãƒƒã‚·ãƒ¥', scores:{ course:'', club:'ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«', vibe:5 } }
        ]
      },
      {
        q: 'ä½“è‚²ã®æ™‚é–“ã¨ã„ãˆã°ï¼Ÿ',
        choices: [
          { text:'å…¨åŠ›ã§å‹ã¡ã«ã„ãï¼', scores:{ course:'', club:'ãƒ†ãƒ‹ã‚¹', vibe:2 } },
          { text:'ã¾ã‚ã¾ã‚æ¥½ã—ã‚€æ´¾', scores:{ course:'', club:'ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«', vibe:3 } },
          { text:'è¦‹å­¦ã—ãŸã„â€¦â€¦', scores:{ course:'', club:'å¸°å®…', vibe:1 } },
          { text:'ä½“è‚²ç¥­ã ã‘æœ¬æ°—å‡ºã™', scores:{ course:'', club:'ãƒ€ãƒ³ã‚¹', vibe:4 } }
        ]
      },
      {
        q: 'æ”¾èª²å¾Œã®äºˆå®šã¯ï¼Ÿ',
        choices: [
          { text:'éƒ¨æ´»ã«å…¨åŠ›ï¼', scores:{ course:'', club:'å¹å¥æ¥½', vibe:2 } },
          { text:'å‹é”ã¨å¯„ã‚Šé“', scores:{ course:'', club:'å¸°å®…', vibe:4 } },
          { text:'å³å¸°å®…', scores:{ course:'', club:'å¸°å®…', vibe:3 } },
          { text:'å­¦æ ¡ã«æ®‹ã£ã¦è‡ªä¸»ç·´ã‚„è‡ªç¿’', scores:{ course:'ç‰¹é€²ã‚³ãƒ¼ã‚¹', club:'', vibe:1 } }
        ]
      },
      {
        q: 'ãƒ†ã‚¹ãƒˆæœŸé–“ä¸­ã€ã‚ãªãŸã¯â€¦ï¼Ÿ',
        choices: [
          { text:'è¨ˆç”»çš„ã«ã‚³ãƒ„ã‚³ãƒ„', scores:{ course:'ç‰¹é€²ã‚³ãƒ¼ã‚¹', club:'', vibe:1 } },
          { text:'ä¸€å¤œæ¼¬ã‘', scores:{ course:'', club:'å¸°å®…', vibe:5 } },
          { text:'å‹‰å¼·ä¼šã‚’é–‹å‚¬', scores:{ course:'', club:'æ¼”åŠ‡', vibe:3 } },
          { text:'ãƒãƒªã¨å‹¢ã„', scores:{ course:'', club:'ãƒ€ãƒ³ã‚¹', vibe:4 } }
        ]
      },
      {
        q: 'æ–‡åŒ–ç¥­ã§ã‚„ã£ã¦ã¿ãŸã„ã“ã¨ã¯ï¼Ÿ',
        choices: [
          { text:'æ¼”åŠ‡ã‚„ãƒ€ãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¸', scores:{ course:'', club:'æ¼”åŠ‡', vibe:3 } },
          { text:'æ¨¡æ“¬åº—ã‚„å±‹å°é‹å–¶', scores:{ course:'', club:'ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«', vibe:4 } },
          { text:'å±•ç¤ºã‚„åˆ¶ä½œç³»ã®å‡ºã—ç‰©', scores:{ course:'ç¾è¡“ã‚³ãƒ¼ã‚¹', club:'', vibe:2 } },
          { text:'ãŠåŒ–ã‘å±‹æ•·ã‚„è„±å‡ºã‚²ãƒ¼ãƒ ', scores:{ course:'', club:'ãƒ›ãƒ©ãƒ¼å¸ƒæ•™', vibe:5 } }
        ]
      },
      {
        q: 'å¿˜ã‚Œç‰©ã—ãŸæ™‚ã©ã†ã™ã‚‹ï¼Ÿ',
        choices: [
          { text:'æ­£ç›´ã«è¨€ã£ã¦è¬ã‚‹', scores:{ course:'ç‰¹é€²ã‚³ãƒ¼ã‚¹', club:'', vibe:1 } },
          { text:'èª°ã‹ã«å€Ÿã‚Šã‚‹', scores:{ course:'', club:'æ¼”åŠ‡', vibe:3 } },
          { text:'ãã‚‚ãã‚‚æ°—ã¥ã‹ãªã„', scores:{ course:'', club:'ç¾è¡“', vibe:4 } },
          { text:'ãªã‚“ã¨ã‹èª¤é­”åŒ–ã™', scores:{ course:'', club:'å¸°å®…', vibe:5 } }
        ]
      },
      {
        q: 'ãƒ†ã‚¹ãƒˆè¿”å´ã®æ—¥ã®æ°—æŒã¡ã¯ï¼Ÿ',
        choices: [
          { text:'è‡ªä¿¡ã‚ã‚Š', scores:{ course:'ç‰¹é€²ã‚³ãƒ¼ã‚¹', club:'', vibe:2 } },
          { text:'ã¨ã«ã‹ãç¥ˆã‚‹', scores:{ course:'', club:'æ–‡èŠ¸', vibe:3 } },
          { text:'å‘¨ã‚Šã®ç‚¹æ•°ãŒæ°—ã«ãªã‚‹', scores:{ course:'', club:'æ¼”åŠ‡', vibe:4 } },
          { text:'ã“ã‚Œä½•ã®æ•™ç§‘ã ã£ã‘ï¼Ÿ', scores:{ course:'', club:'å¸°å®…', vibe:5 } }
        ]
      },
      {
        q: 'å­¦æ ¡è¡Œäº‹ã§ä¸€ç•ªç‡ƒãˆã‚‹ã®ã¯ï¼Ÿ',
        choices: [
          { text:'ä½“è‚²ç¥­', scores:{ course:'', club:'é™¸ä¸Š', vibe:3 } },
          { text:'æ–‡åŒ–ç¥­', scores:{ course:'', club:'æ¼”åŠ‡', vibe:4 } },
          { text:'åˆå”±ã‚³ãƒ³ã‚¯ãƒ¼ãƒ«', scores:{ course:'éŸ³æ¥½ã‚³ãƒ¼ã‚¹', club:'', vibe:2 } },
          { text:'ä¿®å­¦æ—…è¡Œ', scores:{ course:'è‹±èªã‚³ãƒ¼ã‚¹', club:'', vibe:5 } }
        ]
      }
    ];

         // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
     let currentQuestion = 0;
     let scores = {
       course: { 'ç‰¹é€²ã‚³ãƒ¼ã‚¹': 0, 'è‹±èªã‚³ãƒ¼ã‚¹': 0, 'éŸ³æ¥½ã‚³ãƒ¼ã‚¹': 0, 'ç¾è¡“ã‚³ãƒ¼ã‚¹': 0 },
       club: {},
       vibe: 0
     };

     // â”€â”€ éƒ¨æ´»ã‚°ãƒ«ãƒ¼ãƒ—å®šç¾©ï¼ˆè¦ä»¶ã©ãŠã‚Šãƒ»å¢—æ¸›ç¦æ­¢ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     const CLUB_GROUP = {
       sports: ['é™¸ä¸Š','ãƒ†ãƒ‹ã‚¹','ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³','ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«','ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«','æ°´æ³³','ãƒ€ãƒ³ã‚¹'],
       culture: ['å£°æ¥½','å¹å¥æ¥½','çµµç”»','å½«åˆ»','æ”¾é€','è‹±èªç ”ç©¶','æ¼”åŠ‡','èŒ¶é“','è¯é“'],
       other:  ['å¸°å®…'],
       rare:   ['ãƒ›ãƒ©ãƒ¼å¸ƒæ•™']
     };

     // ã‚°ãƒ«ãƒ¼ãƒ—åˆ¤å®š â†’ ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§å‡ç­‰ï¼ˆãƒ¬ã‚¢ã¯åˆ¥æ ï¼‰
     function chooseClubByGroup(tally) {
       // 1) ã‚°ãƒ«ãƒ¼ãƒ—åˆç®—
       const sum = { sports:0, culture:0, other:0, rare:0 };
       for (const [club, v] of Object.entries(tally)) {
         if (CLUB_GROUP.sports.includes(club))  sum.sports += v;
         else if (CLUB_GROUP.culture.includes(club)) sum.culture += v;
         else if (CLUB_GROUP.other.includes(club))   sum.other += v;
         else if (CLUB_GROUP.rare.includes(club))    sum.rare += v;
       }

       // 2) ãƒ¬ã‚¢åˆ¤å®šï¼ˆå¼·ã„ã¨ãã ã‘ãƒ»ãã‚Œä»¥å¤–ã¯ä½ç¢ºç‡ã«æŠ‘åˆ¶ï¼‰
       const maxMajor = Math.max(sum.sports, sum.culture, sum.other);
       if (sum.rare > 0 && sum.rare >= maxMajor * 1.2) return 'ãƒ›ãƒ©ãƒ¼å¸ƒæ•™'; // å›ç­”ãŒå¼·ãç¤ºå”†
       // ä½ç¢ºç‡ã§ã®éŠã³ï¼ˆ1ã€œ2%ï¼‰ã«ã—ãŸã„ã¨ãã¯ä¸‹è¡Œã‚’æœ‰åŠ¹åŒ–
       // if (Math.random() < 0.015) return 'ãƒ›ãƒ©ãƒ¼å¸ƒæ•™';

       // 3) ä¸Šä½ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ±ºã‚ã‚‹ï¼ˆÂ±10%ã¯åŒç‡æ‰±ã„ï¼‰
       const entries = Object.entries({sports:sum.sports,culture:sum.culture,other:sum.other});
       const topVal = Math.max(...entries.map(([,v])=>v));
       const tops = entries.filter(([,v]) => v >= topVal * 0.9).map(([k])=>k);

       // 4) å€™è£œãƒ—ãƒ¼ãƒ«ï¼ˆä¸Šä½ã‚°ãƒ«ãƒ¼ãƒ—ã®åˆä½µï¼‰ã‹ã‚‰å‡ç­‰æŠ½é¸
       const pool = tops.flatMap(g => CLUB_GROUP[g]);
       // äº‹å‰ã‚¹ã‚³ã‚¢ï¼ˆLaplaceå¹³æ»‘ï¼š+1ï¼‰ã§å¾®èª¿æ•´ã—ã¤ã¤æ¥µç«¯ãªåã‚Šã‚’é˜²ã
       const weights = pool.map(c => (tally[c] ?? 0) + 1);
       const total = weights.reduce((a,b)=>a+b,0);
       let r = Math.random() * total;
       for (let i=0;i<pool.length;i++){
         r -= weights[i];
         if (r <= 0) return pool[i];
       }
       return pool[0];
     }

     // æ­£è¦åŒ–ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ—¢å­˜äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
     const CLUB_SET = [
       'é™¸ä¸Š','ãƒ†ãƒ‹ã‚¹','ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³','ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«','ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«','æ°´æ³³','ãƒ€ãƒ³ã‚¹',
       'å£°æ¥½','å¹å¥æ¥½','çµµç”»','å½«åˆ»','æ”¾é€','è‹±èªç ”ç©¶','æ¼”åŠ‡','èŒ¶é“','è¯é“','å¸°å®…','ãƒ›ãƒ©ãƒ¼å¸ƒæ•™'
     ];
     const CLUB_WEIGHT = Object.fromEntries(CLUB_SET.map(k => [k, 1]));
     CLUB_WEIGHT['ãƒ›ãƒ©ãƒ¼å¸ƒæ•™'] = 0.15; // ãƒ¬ã‚¢

     function normalizeClub(raw) {
       if (!raw) return '';
       let c = String(raw).replace(/éƒ¨$/,'');       // èªå°¾ã€Œéƒ¨ã€ã‚’é™¤å»
       // è¡¨è¨˜ã‚†ã‚Œå¸å
       if (c === 'è»½éŸ³') c = 'å¹å¥æ¥½';
       if (c === 'ç¾è¡“') c = 'çµµç”»';
       if (c === 'æ–‡èŠ¸' || c === 'å›³æ›¸') c = 'è‹±èªç ”ç©¶';
       // æ—¢å®šã‚»ãƒƒãƒˆå¤–ã¯å¼¾ã
       return CLUB_SET.includes(c) ? c : '';
     }

    // è³ªå•è¡¨ç¤º
    function showQuestion(index) {
      if (index >= questions.length) {
        showResult();
        return;
      }

      const question = questions[index];
      const container = document.getElementById('questionContainer');
      
             // å®‰å…¨ãªHTMLç”Ÿæˆï¼ˆå…ƒã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ç¶­æŒï¼‰
       const choicesHTML = question.choices.map((choice, i) => 
         `<div class="answer-option" onclick="selectAnswer(${i})">${choice.text || 'é¸æŠè‚¢' + (i + 1)}</div>`
       ).join('');
       
       const backButtonHTML = index > 0 ? 
         `<button class="back-btn" onclick="goBack()">â† å‰ã®è³ªå•</button>` : 
         '<div></div>';
      
      container.innerHTML = `
        <div class="question-card">
          <div class="question-title">è³ªå• ${index + 1} / ${questions.length}</div>
          <div class="question-text">${question.q || 'è³ªå•ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ'}</div>
          <div class="answer-options">
            ${choicesHTML}
          </div>
          <div class="controls">
            ${backButtonHTML}
            <span style="color: #666;">${index + 1} / ${questions.length}</span>
          </div>
        </div>
      `;
      
             // å¿µã®ãŸã‚ã€ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‰‹å‹•ã§è¿½åŠ ï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ã¯å¤‰æ›´ã—ãªã„ï¼‰
       setTimeout(function() {
         const answerOptions = container.querySelectorAll('.answer-option');
         answerOptions.forEach((option, i) => {
           option.addEventListener('click', function(event) {
             console.log('ğŸ–±ï¸ é¸æŠè‚¢ã‚¯ãƒªãƒƒã‚¯ (æ‰‹å‹•):', i);
             event.preventDefault();
             event.stopPropagation();
             selectAnswer(i);
           });
         });
       }, 100);

      // é€²æ—ãƒãƒ¼æ›´æ–°
      const progress = ((index + 1) / questions.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
    }

    // å …ç‰¢ãªå›ç­”å‡¦ç†ï¼ˆTypeSquareã‚¨ãƒ©ãƒ¼å¯¾ç­–å¼·åŒ–ç‰ˆï¼‰
    function selectAnswer(answerIndex) {
      try {
        console.log('ğŸ¯ å›ç­”é¸æŠ:', answerIndex, '(è³ªå•', currentQuestion + 1, ')');
        
        // äºŒé‡å®Ÿè¡Œé˜²æ­¢
        if (window.answerProcessing) {
          console.log('â¸ï¸ å‡¦ç†ä¸­ã®ãŸã‚ç„¡è¦–');
          return;
        }
        window.answerProcessing = true;
        
        // å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
        if (typeof answerIndex !== 'number' || answerIndex < 0) {
          console.error('âŒ ç„¡åŠ¹ãªå›ç­”ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', answerIndex);
          window.answerProcessing = false;
          return;
        }
        
        const question = questions[currentQuestion];
        if (!question || !question.choices || !question.choices[answerIndex]) {
          console.error('âŒ ç„¡åŠ¹ãªè³ªå•ã¾ãŸã¯é¸æŠè‚¢:', currentQuestion, answerIndex);
          window.answerProcessing = false;
          return;
        }
        
        const choice = question.choices[answerIndex];
        console.log('ğŸ“ é¸æŠã—ãŸå›ç­”:', choice.text);
        
                 // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
         try {
           if (choice.scores.course) {
             scores.course[choice.scores.course] = (scores.course[choice.scores.course] || 0) + 1;
           }
           if (choice.scores.club) {
             const club = normalizeClub(choice.scores.club);
             if (club) scores.club[club] = (scores.club[club] || 0) + 1;
           }
           scores.vibe += choice.scores.vibe || 0;
          
          console.log('ğŸ“Š ç¾åœ¨ã®ã‚¹ã‚³ã‚¢:', { course: scores.course, club: Object.keys(scores.club).length, vibe: scores.vibe });
        } catch (scoreError) {
          console.error('âŒ ã‚¹ã‚³ã‚¢è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', scoreError);
        }
        
        // æ¬¡ã®è³ªå•ã¸é€²ã‚€
        currentQuestion++;
        console.log('â¡ï¸ æ¬¡ã®è³ªå•ã¸:', currentQuestion);
        
        // é…å»¶å®Ÿè¡Œã§UIæ›´æ–°
        setTimeout(function() {
          try {
            showQuestion(currentQuestion);
          } catch (showError) {
            console.error('âŒ è³ªå•è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', showError);
            // å¼·åˆ¶çš„ã«æ¬¡ã«é€²ã‚€
            if (currentQuestion < questions.length) {
              currentQuestion++;
              showQuestion(currentQuestion);
            } else {
              showResult();
            }
          } finally {
            window.answerProcessing = false;
          }
        }, 300);
        
      } catch (error) {
        console.error('âŒ å›ç­”å‡¦ç†ã®é‡å¤§ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€æ¬¡ã®è³ªå•ã«é€²ã¿ã¾ã™ã€‚');
        
        // ç·Šæ€¥å¾©æ—§å‡¦ç†
        try {
          currentQuestion++;
          if (currentQuestion >= questions.length) {
            showResult();
          } else {
            showQuestion(currentQuestion);
          }
        } catch (recoveryError) {
          console.error('âŒ å¾©æ—§å‡¦ç†ã‚¨ãƒ©ãƒ¼:', recoveryError);
          // æœ€å¾Œã®æ‰‹æ®µï¼šçµæœç”»é¢ã«å¼·åˆ¶é·ç§»
          showResult();
        } finally {
          window.answerProcessing = false;
        }
      }
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã« selectAnswer ã‚’ç¢ºå®Ÿã«å®šç¾©
    window.selectAnswer = selectAnswer;

    // æˆ»ã‚‹
    function goBack() {
      if (currentQuestion > 0) {
        currentQuestion--;
        showQuestion(currentQuestion);
      }
    }

    // çµæœè¨ˆç®—
    function calculateResult() {
      // ã‚³ãƒ¼ã‚¹æ±ºå®š
      const courseEntries = Object.entries(scores.course);
      const topCourse = courseEntries.reduce((a, b) => a[1] > b[1] ? a : b);
      const courseName = topCourse[0];
      
      let department, course, displayCourse;
      switch(courseName) {
        case 'ç‰¹é€²ã‚³ãƒ¼ã‚¹':
          department = 'æ™®é€šç§‘';
          course = 'ç‰¹é€²';
          displayCourse = 'æ™®é€šç§‘ï¼ˆç‰¹é€²ã‚³ãƒ¼ã‚¹ï¼‰';
          break;
        case 'è‹±èªã‚³ãƒ¼ã‚¹':
          department = 'æ™®é€šç§‘';
          course = 'è‹±èª';
          displayCourse = 'æ™®é€šç§‘ï¼ˆè‹±èªã‚³ãƒ¼ã‚¹ï¼‰';
          break;
        case 'éŸ³æ¥½ã‚³ãƒ¼ã‚¹':
          department = 'èŠ¸è¡“ç§‘';
          course = 'éŸ³æ¥½';
          displayCourse = 'èŠ¸è¡“ç§‘ï¼ˆéŸ³æ¥½ã‚³ãƒ¼ã‚¹ï¼‰';
          break;
        case 'ç¾è¡“ã‚³ãƒ¼ã‚¹':
          department = 'èŠ¸è¡“ç§‘';
          course = 'ç¾è¡“';
          displayCourse = 'èŠ¸è¡“ç§‘ï¼ˆç¾è¡“ã‚³ãƒ¼ã‚¹ï¼‰';
          break;
        default:
          department = 'æ™®é€šç§‘';
          course = 'ä¸€èˆ¬';
          displayCourse = 'æ™®é€šç§‘ï¼ˆä¸€èˆ¬ã‚³ãƒ¼ã‚¹ï¼‰';
      }
      
             // éƒ¨æ´»æ±ºå®šï¼ˆã‚°ãƒ«ãƒ¼ãƒ—å„ªå…ˆã®å‡ç­‰åŒ–ï¼‰
       const club = chooseClubByGroup(scores.club);
      
      return { department, course, displayCourse, club };
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const previewMessages = [
      "${club}ã§ã®æ´»å‹•ãŒè©±é¡Œã«ï¼æ³¨ç›®ã®å­˜åœ¨ã§ã™ã€‚",
      "${club}ã®ã‚¨ãƒ¼ã‚¹ã¨ã—ã¦æœŸå¾…ã‚‚å¤§ãã„ã¨ã‹ã€‚",
      "å­¦æ¥­ã¨${club}ã§ã®çµŒé¨“ãŒè¦‹äº‹ã«ãƒãƒƒãƒã—ã¦ã„ã¾ã™ã€‚",
      "${club}ã§æŠ«éœ²ã—ãŸãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå°è±¡çš„ã§ã—ãŸã€‚",
      "${club}ã®æ´»å‹•ã«æ‰“ã¡è¾¼ã‚€å§¿ã¯ã€ã¿ã‚“ãªã‹ã‚‰ä¸€ç›®ç½®ã‹ã‚Œã¦ã„ã¾ã™ã€‚"
    ];

    const episodes = [
      "çµ¦é£Ÿã®ã‚¼ãƒªãƒ¼ã‚’æ¯æ—¥å‹é”ã¨ã‚¸ãƒ£ãƒ³ã‚±ãƒ³ã§å¥ªã„åˆã£ã¦ã„ã‚‹ã€‚",
      "æ•™å®¤ã®éš…ã£ã“ã§ã“ã£ãã‚ŠæŠ˜ã‚Šç´™ã‚’é‡ç”£ã—ã¦ã„ã‚‹ã€‚",
      "æƒé™¤ã®æ™‚é–“ã€ã»ã†ãã§ã‚¨ã‚¢ã‚®ã‚¿ãƒ¼ã‚’å§‹ã‚ãŒã¡ã€‚",
      "ä½“è‚²ã®æº–å‚™é‹å‹•ã«å…¨åŠ›ã™ãã¦æ¯å›ç¬‘ã„ãŒèµ·ãã‚‹ã€‚",
      "å®¿é¡Œã‚’å¿˜ã‚Œã¦ã‚‚ã€Œé¢¨ã®ã›ã„ã€ã¨è¨€ã„è¨³ã—ã¦ä¹—ã‚Šåˆ‡ã‚‹å¤©æ‰ã€‚",
      "æœã®æŒ¨æ‹¶ãŒã§ã‹ã™ãã¦éš£ã®æ•™å®¤ã¾ã§èã“ãˆã‚‹ã€‚",
      "é»’æ¿ã«æ›¸ã„ãŸã‚¤ãƒ©ã‚¹ãƒˆã‚’å‹æ‰‹ã«\"é€£è¼‰åŒ–\"ã—ã¦ã„ã‚‹ã€‚",
      "ãƒãƒ¼ãƒˆã®ç«¯ã«æ¯å›å¤‰ãªã‚­ãƒ£ãƒ©ãŒç™»å ´ã—ã¦ã„ã‚‹ã€‚",
      "å›³æ›¸å®¤ã®éš…ã§ãªãœã‹ç´™èŠå±…ã‚’ã—ã¦ã„ãŸã“ã¨ãŒã‚ã‚‹ã€‚",
      "ç¾è¡“å®¤ã§çµµã®å…·ã®ãƒ•ã‚¿ã‚’é–‹ã‘ã‚‹ä¿‚ã‚’å‹æ‰‹ã«ã—ã¦ã„ã‚‹ã€‚"
    ];

    // çµæœè¡¨ç¤º
    function showResult() {
      document.getElementById('questionContainer').style.display = 'none';
      document.getElementById('resultContainer').style.display = 'block';
      
      const result = calculateResult();
      
             document.getElementById('resultCourse').textContent = result.displayCourse;
       
       // è¡¨ç¤ºã¯èªå°¾ã€Œéƒ¨ã€ã‚’ä»˜ã‘ãªã„ï¼ˆã‚«ãƒ¼ãƒ‰ç”»åƒã«è¡¨è¨˜ã‚ã‚Šï¼‰
       document.getElementById('resultClub').textContent = result.club;
       
       // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
       const msgTemplate = previewMessages[Math.floor(Math.random() * previewMessages.length)];
       const previewMessage = msgTemplate.replace('${club}', result.club);
      document.getElementById('previewMsg').textContent = previewMessage;
      
      // ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰
      const episode = episodes[Math.floor(Math.random() * episodes.length)];
      document.getElementById('episodeMsg').textContent = episode;
      
      // ãƒœã‚¿ãƒ³è¨­å®š
      document.getElementById('toGeneratorBtn').onclick = () => {
        // ç”»åƒå´ã«ã€Œéƒ¨ã€ãŒå°å­—æ¸ˆã¿ã®ãŸã‚ã€ãƒ†ã‚­ã‚¹ãƒˆã«ã¯ä»˜ã‘ãªã„
        const baseClubMap = {
          'é™¸ä¸Š': 'é™¸ä¸Š', 'ãƒ†ãƒ‹ã‚¹': 'ãƒ†ãƒ‹ã‚¹', 'ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³': 'ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³',
          'ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«': 'ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«', 'ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«': 'ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«',
          'æ°´æ³³': 'æ°´æ³³', 'ãƒ€ãƒ³ã‚¹': 'ãƒ€ãƒ³ã‚¹',
          'å£°æ¥½': 'å£°æ¥½', 'å¹å¥æ¥½': 'å¹å¥æ¥½', 'çµµç”»': 'çµµç”»', 'å½«åˆ»': 'å½«åˆ»',
          'æ”¾é€': 'æ”¾é€', 'è‹±èªç ”ç©¶': 'è‹±èªç ”ç©¶', 'æ¼”åŠ‡': 'æ¼”åŠ‡', 'èŒ¶é“': 'èŒ¶é“', 'è¯é“': 'è¯é“',
          'å¸°å®…': 'å¸°å®…', 'ãªã—': 'å¸°å®…'
        };
        
        const normalizeClub = (raw) => {
          const s = (raw || '').replace(/éƒ¨$/,'');
          if (!s) return 'å¸°å®…';
          return baseClubMap[s] ?? s;
        };
        const mappedClub = normalizeClub(result.club);
        
        const url = new URL('generator.html', window.location.href);
        url.searchParams.set('department', result.department);
        url.searchParams.set('course', result.course);
        url.searchParams.set('club', mappedClub);
        url.searchParams.set('previewMessage', previewMessage);
        url.searchParams.set('episodeMessage', episode);
        
        // embedãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¼•ãç¶™ã
        if (window.location.search.includes('embed=1')) {
          url.searchParams.set('embed', '1');
        }
        
        window.location.href = url.toString();
      };
      
      document.getElementById('restartBtn').onclick = () => {
        window.location.reload();
      };
    }

    // è¨ºæ–­ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ï¼ˆTypeSquareã‚¨ãƒ©ãƒ¼å¯¾ç­–å¼·åŒ–ç‰ˆï¼‰
    function initializeQuiz() {
      try {
        console.log('ğŸš€ è¨ºæ–­ã‚²ãƒ¼ãƒ åˆæœŸåŒ–é–‹å§‹');
        
        // DOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
        const questionContainer = document.getElementById('questionContainer');
        const progressFill = document.getElementById('progressFill');
        
        if (!questionContainer) {
          console.error('âŒ questionContainer ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          document.body.innerHTML = '<div style="text-align: center; padding: 50px; color: red;">ã‚¨ãƒ©ãƒ¼: è¨ºæ–­ã‚²ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div>';
          return;
        }
        
        if (!progressFill) {
          console.warn('âš ï¸ progressFill ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆé€²æ—ãƒãƒ¼ãªã—ã§ç¶šè¡Œï¼‰');
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã®ç¢ºèªãƒ»ä¿®æ­£
        if (typeof window.selectAnswer !== 'function') {
          console.warn('âš ï¸ selectAnsweré–¢æ•°ã‚’å†å®šç¾©');
          window.selectAnswer = selectAnswer;
        }
        
        if (typeof window.goBack !== 'function') {
          console.warn('âš ï¸ goBacké–¢æ•°ã‚’å†å®šç¾©');
          window.goBack = goBack;
        }
        
        // è³ªå•ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
        if (!questions || questions.length === 0) {
          console.error('âŒ è³ªå•ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          questionContainer.innerHTML = '<div style="text-align: center; padding: 50px; color: red;">ã‚¨ãƒ©ãƒ¼: è³ªå•ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
          return;
        }
        
                 console.log('âœ… è¨ºæ–­ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†:', questions.length + 'å•');
         
         // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆé–‹ç™ºæ™‚ã®ã¿è¡¨ç¤ºï¼‰
         if (window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1')) {
           console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°: selectAnsweré–¢æ•°ç¢ºèª:', typeof window.selectAnswer);
           console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°: goBacké–¢æ•°ç¢ºèª:', typeof window.goBack);
         }
         
         // æœ€åˆã®è³ªå•ã‚’è¡¨ç¤º
         showQuestion(0);
         
         // å‹•ä½œç¢ºèªï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
         if (window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1')) {
           setTimeout(function() {
             const firstOption = document.querySelector('.answer-option');
             if (firstOption) {
               console.log('âœ… é¸æŠè‚¢ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚');
             } else {
               console.error('âŒ é¸æŠè‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
             }
           }, 3000);
         }
        
      } catch (error) {
        console.error('âŒ è¨ºæ–­ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        document.body.innerHTML = '<div style="text-align: center; padding: 50px; color: red;">é‡å¤§ã‚¨ãƒ©ãƒ¼: è¨ºæ–­ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br><button type="button" onclick="location.reload()">ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿</button></div>';
      }
    }
    
    // showResult=1ã®å ´åˆã¯åˆæœŸåŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—
    const params = new URLSearchParams(location.search);
    const showResult = params.get('showResult');
    
    if (showResult !== '1') {
      // è¤‡æ•°ã®æ–¹æ³•ã§åˆæœŸåŒ–ã‚’è©¦è¡Œ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeQuiz);
      } else {
        // ã™ã§ã«èª­ã¿è¾¼ã¿å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
        initializeQuiz();
      }
      
      // å¿µã®ãŸã‚ã€å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚‚å®Ÿè¡Œ
      setTimeout(function() {
        if (!document.getElementById('questionContainer').innerHTML.trim()) {
          console.warn('âš ï¸ é…å»¶åˆæœŸåŒ–ã‚’å®Ÿè¡Œ');
          initializeQuiz();
        }
      }, 1000);
    }
  </script>
  
  <!-- åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰åˆ¶å¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="assets/js/embed-mode.js" defer></script>
</body>
</html> 