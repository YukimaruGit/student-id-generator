<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç”Ÿè¨¼ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <meta property="og:title" content="æ”¾èª²å¾Œã‚¯ãƒ­ãƒ‹ã‚¯ãƒ« å­¦ç”Ÿè¨¼ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼">
  <meta property="og:description" content="ã‚ãªãŸã ã‘ã®å­¦ç”Ÿè¨¼ã‚’ä½œæˆã—ã‚ˆã†ï¼">
  <meta property="og:image" content="https://res.cloudinary.com/di5xqlddy/image/upload/f_auto,q_auto,w_1200,h_630,c_fill,fl_force_strip/v1/student-id-generator/preview.png">
  <meta property="og:url" content="https://lime016395.studio.site/student-id">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://res.cloudinary.com/di5xqlddy/image/upload/f_auto,q_auto,w_1200,h_630,c_fill,fl_force_strip/v1/student-id-generator/preview.png">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="æ”¾èª²å¾Œã‚¯ãƒ­ãƒ‹ã‚¯ãƒ«">
  <meta name="twitter:site" content="@as_chronicle">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    /* å­¦ç”Ÿè¨¼ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    :root {
      --primary-color: #dda0dd;    /* æ’«å­è‰²é¢¨ã®æŸ”ã‚‰ã‹ã„ç´«ãŒã‹ã£ãŸãƒ”ãƒ³ã‚¯ */
      --secondary-color: #b0c4de;  /* æ°´æµ…è‘±é¢¨ã®æŸ”ã‚‰ã‹ã„é’ã¿ã®ã‚°ãƒ¬ãƒ¼ */
      --accent-color: #98d7a5;     /* è‹¥è‘‰è‰²é¢¨ã®æŸ”ã‚‰ã‹ã„é»„ç·‘ */
      --background-color: #1a1a1a; /* é»’æ–¹çœ¼ç´™é¢¨èƒŒæ™¯ */
      --card-background: #ffffff;
      --text-color: #787878;       /* å„ªã—ã„ãƒŸãƒ‡ã‚£ã‚¢ãƒ ã‚°ãƒ¬ãƒ¼ */
      --error-color: #f8d7da;      /* è–„ç´…è‰²é¢¨ã®éå¸¸ã«å„ªã—ã„ãƒ”ãƒ³ã‚¯ */
      --success-color: #d4edda;    /* ç™½ç¾¤è‰²é¢¨ã®æŸ”ã‚‰ã‹ã„ãƒŸãƒ³ãƒˆã‚°ãƒªãƒ¼ãƒ³ */
      --border-radius: 12px;
      --transition-duration: 0.3s;
      --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --container-width: 1400px;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Noto Sans JP', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--background-color);
      background-image: 
        linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
      background-size: 20px 20px;
      min-height: 100vh;
      color: var(--text-color);
      line-height: 1.6;
    }
    
    .header-line {
      height: 2px;
      background: white;
      margin-bottom: 2rem;
    }
    
    .container {
      max-width: var(--container-width);
      margin: 0 auto;
      padding: 2rem;
    }
    
    .back-link {
      display: inline-block;
      margin-bottom: 2rem;
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: all 0.3s ease;
      background: rgba(221, 160, 221, 0.1);
    }
    
    .back-link:hover {
      background: rgba(221, 160, 221, 0.2);
      transform: translateX(-5px);
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    .panel {
      background: rgba(248, 246, 240, 0.7);
      border-radius: var(--border-radius);
      padding: 2rem;
      box-shadow: var(--box-shadow);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .panel-title {
      color: #666;
      font-size: 1.3rem;
      font-weight: 650;
      margin-bottom: 1.5rem;
      text-align: center;
      font-family: 'Noto Serif JP', serif;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8), 0 0 4px rgba(255, 255, 255, 0.3);
    }
    
    .image-selection {
      width: 100%;
      height: 200px;
      border: 3px dashed var(--primary-color);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
      background: rgba(221, 160, 221, 0.05);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .image-selection:hover {
      border-color: #c8a2c8;
      background: rgba(221, 160, 221, 0.1);
    }
    
    .image-selection-text {
      color: var(--primary-color);
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #666;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.875rem;
      border: 1px solid #bdc3c7;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: white;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(221, 160, 221, 0.1);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;

    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .btn {
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
    }
    
    .btn-return {
      background: var(--accent-color);
    }
    
    .btn-return:hover {
      background: #8bc8a0;
      transform: translateY(-2px);
    }
    
    .btn-view-results {
      background: var(--secondary-color);
    }
    
    .btn-view-results:hover {
      background: #9fb8d1;
      transform: translateY(-2px);
    }
    
         .preview-area {
       width: 100%;
       height: 400px;
       background: white;
       border-radius: 12px;
       box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
       margin-bottom: 1.5rem;
       display: flex;
       align-items: center;
       justify-content: center;
       border: 1px solid #ecf0f1;
       position: relative;
     }
     
     .preview-area canvas {
       max-width: 100%;
       max-height: 100%;
       object-fit: contain;
     }
    
    .preview-placeholder {
      color: #95a5a6;
      font-size: 1rem;
      text-align: center;
      line-height: 1.6;
    }
    
         .instructions {
       color: #7f8c8d;
       font-size: 0.85rem;
       line-height: 1.6;
       margin: 1rem 0 2rem 0;
       padding: 1rem;
       background: rgba(255, 255, 255, 0.1);
       border-radius: 8px;
       border-left: 3px solid var(--accent-color);
     }
    
    .sharing-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .btn-share-x {
      background: #1da1f2;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .btn-share-x:hover {
      background: #1a91da;
      transform: translateY(-2px);
    }
    
    .btn-copy-url {
      background: #95a5a6;
    }
    
         .btn-copy-url:hover {
       background: #7f8c8d;
       transform: translateY(-2px);
     }
     
     .btn-primary {
       background: var(--primary-color);
     }
     
     .btn-primary:hover {
       background: #c8a2c8;
       transform: translateY(-2px);
     }
    
    .diagnosis-result {
      background: rgba(176, 196, 222, 0.3);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      border-left: 4px solid var(--secondary-color);
    }
    
    .diagnosis-result h3 {
      color: #5a6c7d;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .diagnosis-item {
      margin-bottom: 0.5rem;
      padding: 0.5rem 0;
    }
    
    .diagnosis-label {
      font-weight: 600;
      color: #5a6c7d;
    }
    
    .diagnosis-value {
      color: #424242;
      margin-left: 0.5rem;
    }
    
    .student-info {
      background: rgba(248, 246, 240, 0.9);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      border-left: 4px solid var(--primary-color);
    }
    
    .student-info h3 {
      color: #666;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid #dee2e6;
    }
    
    .info-item:last-child {
      border-bottom: none;
    }
    
    .info-label {
      font-weight: 600;
      color: #495057;
    }
    
    .info-value {
      color: #6c757d;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .container {
        padding: 1rem;
      }
    }
    
    @media (max-width: 768px) {
      .panel {
        padding: 1.5rem;
      }
      
      .form-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
      
      .action-buttons,
      .sharing-buttons {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
      
      .image-selection {
        height: 150px;
      }
      
             .preview-area {
         height: 300px;
       }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 0.5rem;
      }
      
      .panel {
        padding: 1rem;
        border-radius: 12px;
      }
      
      .form-group input,
      .form-group select {
        padding: 0.75rem;
        font-size: 0.95rem;
      }
      
      .btn {
        padding: 0.75rem 1.25rem;
        font-size: 0.95rem;
      }
    }
    
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .panel {
      animation: fadeInUp 0.6s ease-out;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      animation: fadeInUp 0.3s ease-out;
    }
  </style>
</head>
<body>
  <div class="header-line"></div>
  
  <div class="container">
         <!-- è¨ºæ–­ã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã¯å‰Šé™¤æ¸ˆã¿ -->
    
    <div class="main-content">
      <!-- å·¦ãƒ‘ãƒãƒ«: å­¦ç”Ÿè¨¼ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="panel">
        <h2 class="panel-title">å­¦ç”Ÿè¨¼ã‚’ä½œæˆ</h2>
        
        <div class="image-selection" onclick="selectImage()">
          <div class="image-selection-text">ç”»åƒã‚’é¸æŠ</div>
        </div>
        
        <form id="studentForm">
                                <div class="form-group">
            <label for="nameJa">æ°åï¼ˆæ¼¢å­—ï¼‰</label>
            <input type="text" id="nameJa" placeholder="ä¾‹: é«˜æ£®ã®ã°ã‚‰" required oninput="updateStudentCard()">
          </div>
          
          <div class="form-group">
            <label for="nameEn">æ°åï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰</label>
            <input type="text" id="nameEn" placeholder="ä¾‹: Takamori Nobara" required oninput="updateStudentCard()">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="dobMonth">ç”Ÿå¹´æœˆæ—¥</label>
              <select id="dobMonth" required onchange="updateStudentCard()">
                <option value="">æœˆ</option>
                <option value="1">1æœˆ</option>
                <option value="2">2æœˆ</option>
                <option value="3">3æœˆ</option>
                <option value="4">4æœˆ</option>
                <option value="5">5æœˆ</option>
                <option value="6">6æœˆ</option>
                <option value="7">7æœˆ</option>
                <option value="8">8æœˆ</option>
                <option value="9">9æœˆ</option>
                <option value="10">10æœˆ</option>
                <option value="11">11æœˆ</option>
                <option value="12">12æœˆ</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="dobDay">&nbsp;</label>
              <select id="dobDay" required onchange="updateStudentCard()">
                <option value="">æ—¥</option>
                <option value="1">1æ—¥</option>
                <option value="2">2æ—¥</option>
                <option value="3">3æ—¥</option>
                <option value="4">4æ—¥</option>
                <option value="5">5æ—¥</option>
                <option value="6">6æ—¥</option>
                <option value="7">7æ—¥</option>
                <option value="8">8æ—¥</option>
                <option value="9">9æ—¥</option>
                <option value="10">10æ—¥</option>
                <option value="11">11æ—¥</option>
                <option value="12">12æ—¥</option>
                <option value="13">13æ—¥</option>
                <option value="14">14æ—¥</option>
                <option value="15">15æ—¥</option>
                <option value="16">16æ—¥</option>
                <option value="17">17æ—¥</option>
                <option value="18">18æ—¥</option>
                <option value="19">19æ—¥</option>
                <option value="20">20æ—¥</option>
                <option value="21">21æ—¥</option>
                <option value="22">22æ—¥</option>
                <option value="23">23æ—¥</option>
                <option value="24">24æ—¥</option>
                <option value="25">25æ—¥</option>
                <option value="26">26æ—¥</option>
                <option value="27">27æ—¥</option>
                <option value="28">28æ—¥</option>
                <option value="29">29æ—¥</option>
                <option value="30">30æ—¥</option>
                <option value="31">31æ—¥</option>
              </select>
            </div>
          </div>
          

           
           <div class="action-buttons" style="margin-top: 1rem;">
             <button type="button" class="btn btn-return" onclick="returnToDiagnosis()">è¨ºæ–­ã«æˆ»ã‚‹</button>
             <button type="button" class="btn btn-view-results" onclick="viewDiagnosisResults()">è¨ºæ–­çµæœã‚’è¦‹ã‚‹</button>
           </div>
        </form>
      </div>
      
      <!-- å³ãƒ‘ãƒãƒ«: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨å…±æœ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
      <div class="panel">
        <h2 class="panel-title">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        
        <div class="preview-area" id="previewArea">
          <div id="previewPlaceholder" class="preview-placeholder">
            å­¦ç”Ÿè¨¼ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒ<br>ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
          </div>
                     <canvas id="cardCanvas" width="800" height="500" style="display: none; max-width: 100%; height: auto; border: 2px solid #ddd; border-radius: 8px;"></canvas>
        </div>
        
                 <div class="instructions">
           â€»å®Œæˆã—ãŸå­¦ç”Ÿè¨¼ã¯ã€Œç”»åƒã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ä¿å­˜ã§ãã¾ã™<br>
           â€»å…±æœ‰URLã¯å¿…ãšã€ŒURLã‚’ã‚³ãƒ”ãƒ¼ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å–å¾—ã—ã¦ãã ã•ã„
         </div>
        
                 <div class="sharing-buttons">
           <button class="btn btn-primary" onclick="saveStudentCard()">ç”»åƒã‚’ä¿å­˜</button>
           <button class="btn btn-copy-url" onclick="copyUrl()">URLã‚’ã‚³ãƒ”ãƒ¼</button>
         </div>
      </div>
    </div>
  </div>

  <script>
    // è¨ºæ–­çµæœã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const department = urlParams.get('department');
    const course = urlParams.get('course');
    const club = urlParams.get('club');
    
    // è¨ºæ–­çµæœã¯å­¦ç”Ÿè¨¼ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«åæ˜ ã•ã‚Œã‚‹ãŸã‚ã€ä»˜ç®‹ã¯è¡¨ç¤ºã—ãªã„
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let selectedImage = null;
    let currentNameJa = '';
    let currentNameEn = '';
    let currentDobMonth = '';
    let currentDobDay = '';
    
         // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸæç”»
     window.addEventListener('load', function() {
       drawStudentCard();
       enableRightClickSave(); // å³ã‚¯ãƒªãƒƒã‚¯ä¿å­˜æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
     });
    
    // Base64URLå¤‰æ›ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
    function b64UrlFromUtf8(jsonStr) {
      const bin = Array.from(new TextEncoder().encode(jsonStr), b => String.fromCharCode(b)).join('');
      return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }

    // URLçŸ­ç¸®ã®ãŸã‚ã®æœ€é©åŒ–ã•ã‚ŒãŸã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
    function createShortShareUrl({ public_id, version, eager_url }) {
      // ãƒ‡ãƒ¼ã‚¿ã‚’æœ€å°é™ã«åœ§ç¸®
      const shortData = {
        p: public_id.substring(0, 8), // æœ€åˆã®8æ–‡å­—ã®ã¿ä½¿ç”¨
        v: version,
        i: eager_url ? eager_url.split('/').pop() : '' // ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿ä½¿ç”¨
      };
      
      const jsonStr = JSON.stringify(shortData);
      const bin = Array.from(new TextEncoder().encode(jsonStr), b => String.fromCharCode(b)).join('');
      const slug = btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      
      return new URL(`/s/${slug}`, location.origin).toString();
    }

    // å…±æœ‰URLä½œæˆé–¢æ•°ï¼ˆçŸ­ç¸®ç‰ˆï¼‰
    function buildShareUrlWithImage({ public_id, version, eager_url }) {
      // çŸ­ç¸®ç‰ˆURLã‚’ç”Ÿæˆ
      return createShortShareUrl({ public_id, version, eager_url });
    }

    // ç”»åƒé¸æŠæ©Ÿèƒ½
    function selectImage() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            selectedImage = e.target.result;
            const imageSelection = document.querySelector('.image-selection');
            imageSelection.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
            imageSelection.style.border = '3px solid var(--accent-color)';
            imageSelection.style.background = 'rgba(152, 215, 165, 0.1)';
            
            // ç”»åƒé¸æŠæ™‚ã«å­¦ç”Ÿè¨¼ã‚’æ›´æ–°
            drawStudentCard();
          };
          reader.readAsDataURL(file);
        }
      };
      input.click();
    }
    
    // è¨ºæ–­ã«æˆ»ã‚‹
    function returnToDiagnosis() {
      window.location.href = 'index.html';
    }
    
         // è¨ºæ–­çµæœã‚’è¦‹ã‚‹
     function viewDiagnosisResults() {
       // ç¾åœ¨ã®è¨ºæ–­çµæœãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦index.htmlã«é·ç§»
       const url = new URL('index.html', window.location.href);
       url.searchParams.set('showResult', 'true'); // '1'ã§ã¯ãªã'true'ã‚’ä½¿ç”¨
       if (department) url.searchParams.set('department', department);
       if (course) url.searchParams.set('course', course);
       if (club) url.searchParams.set('club', club);
       
       // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚è¨­å®š
       const previewMessage = urlParams.get('previewMessage');
       const episodeMessage = urlParams.get('episodeMessage');
       if (previewMessage) url.searchParams.set('previewMessage', previewMessage);
       if (episodeMessage) url.searchParams.set('episodeMessage', episodeMessage);
       
       window.location.href = url.toString();
     }
    
         // å­¦ç”Ÿè¨¼ç”»åƒã‚’ä¿å­˜
     function saveStudentCard() {
       const canvas = document.getElementById('cardCanvas');
       const previewPlaceholder = document.getElementById('previewPlaceholder');
       
       if (previewPlaceholder.style.display === 'block') {
         alert('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšå­¦ç”Ÿè¨¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚');
         return;
       }
       
       try {
         // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
         const link = document.createElement('a');
         link.download = 'student_card.png';
         link.href = canvas.toDataURL('image/png', 1.0);
         document.body.appendChild(link);
         link.click();
         document.body.removeChild(link);
         
         // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         const notification = document.createElement('div');
         notification.style.cssText = `
           position: fixed;
           top: 20px;
           right: 20px;
           background: #4CAF50;
           color: white;
           padding: 12px 20px;
           border-radius: 8px;
           z-index: 1000;
           font-family: 'Noto Sans JP', sans-serif;
           box-shadow: 0 4px 12px rgba(0,0,0,0.2);
           font-size: 14px;
         `;
         notification.textContent = 'å­¦ç”Ÿè¨¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼';
         document.body.appendChild(notification);
         
         setTimeout(() => {
           notification.remove();
         }, 3000);
       } catch (error) {
         console.error('ç”»åƒä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
         alert('ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
       }
     }
     
     // Xã«æŠ•ç¨¿
     function shareToX() {
       alert('Xã¸ã®æŠ•ç¨¿æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚\n\nå­¦ç”Ÿè¨¼ã®ç”»åƒãŒç”Ÿæˆã•ã‚ŒãŸå¾Œã«åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚');
     }
    
    // URLã‚’ã‚³ãƒ”ãƒ¼
    async function copyUrl() {
      // å­¦ç”Ÿè¨¼ç”»åƒã‚’Cloudinaryã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å…±æœ‰URLã‚’ç”Ÿæˆ
      await uploadStudentCardToCloudinary();
    }
    
         // å­¦ç”Ÿè¨¼ç”»åƒã‚’Cloudinaryã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
     async function uploadStudentCardToCloudinary() {
       const canvas = document.getElementById('cardCanvas');
       const previewPlaceholder = document.getElementById('previewPlaceholder');
       
       if (previewPlaceholder.style.display === 'block') {
         alert('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšå­¦ç”Ÿè¨¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚');
         return;
       }
       
       // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
       const copyButton = document.querySelector('.btn-copy-url');
       const originalText = copyButton.textContent;
       copyButton.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
       copyButton.disabled = true;
       
       // Canvasã‹ã‚‰ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
       canvas.toBlob(function(blob) {
                   // FormDataã‚’ä½œæˆ
          const formData = new FormData();
          formData.append('file', blob, 'student_card.png');
          formData.append('upload_preset', 'student_card_AS_chronicle');
          formData.append('folder', 'as_chronicle/student_card');
         
                   // Cloudinaryã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          fetch('https://api.cloudinary.com/v1_1/di5xqlddy/image/upload', {
            method: 'POST',
            body: formData
          })
          .then(response => {
            if (!response.ok) {
              // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å–å¾—
              return response.text().then(text => {
                try {
                  const errorData = JSON.parse(text);
                  throw new Error(`Cloudinaryã‚¨ãƒ©ãƒ¼: ${errorData.error?.message || errorData.error || `HTTP ${response.status}`}`);
                } catch (e) {
                  throw new Error(`HTTP error! status: ${response.status}, response: ${text.substring(0, 100)}`);
                }
              });
            }
            return response.json();
          })
         .then(data => {
           if (data.secure_url) {
                          // SNSå…±æœ‰ç”¨ã®URLã‚’ç”Ÿæˆï¼ˆ/s/{slug}å½¢å¼ï¼‰
             const shareUrl = buildShareUrlWithImage({
               public_id: data.public_id,
               version: data.version,
               eager_url: data.secure_url
             });
             
                            // URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
             copyTextReliable(shareUrl).then((success) => {
               if (success) {
                 console.log('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ:', shareUrl);
               } else {
                 console.log('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã€æ‰‹å‹•ã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
               }
             });
           } else {
             throw new Error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«secure_urlãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
           }
         })
         .catch(error => {
           console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
           let errorMessage = 'ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
           
           if (error.message.includes('Overwrite parameter')) {
             errorMessage += '\n\nCloudinaryã®è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚';
           } else if (error.message.includes('HTTP error! status: 400')) {
             errorMessage += '\n\nã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚';
           } else {
             errorMessage += '\n\nã‚¨ãƒ©ãƒ¼è©³ç´°: ' + error.message;
           }
           
           errorMessage += '\n\nã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
           alert(errorMessage);
         })
         .finally(() => {
           // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
           copyButton.textContent = originalText;
           copyButton.disabled = false;
         });
       }, 'image/png');
     }
    
    // å­¦ç”Ÿè¨¼ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateStudentCard() {
      const nameJa = document.getElementById('nameJa').value;
      const nameEn = document.getElementById('nameEn').value;
      const dobMonth = document.getElementById('dobMonth').value;
      const dobDay = document.getElementById('dobDay').value;
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
      currentNameJa = nameJa;
      currentNameEn = nameEn;
      currentDobMonth = dobMonth;
      currentDobDay = dobDay;
      
      // å­¦ç”Ÿè¨¼ã‚’æç”»
      drawStudentCard();
    }
    
         
    
               // å³ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–ï¼ˆHTMLä¿å­˜ã‚’é˜²ãï¼‰
      function enableRightClickSave() {
        const canvas = document.getElementById('cardCanvas');
        if (canvas) {
          // å³ã‚¯ãƒªãƒƒã‚¯ã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ–
          canvas.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
          });
          
          // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚‚ç„¡åŠ¹åŒ–
          canvas.addEventListener('dblclick', function(e) {
            e.preventDefault();
            return false;
          });
        }
        
        // ãƒšãƒ¼ã‚¸å…¨ä½“ã®å³ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–
        document.addEventListener('contextmenu', function(e) {
          e.preventDefault();
          return false;
        });
        
        // ãƒšãƒ¼ã‚¸å…¨ä½“ã®ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚‚ç„¡åŠ¹åŒ–
        document.addEventListener('dblclick', function(e) {
          e.preventDefault();
          return false;
        });
      }
     

      
      // å­¦ç”Ÿè¨¼ã‚’æç”»ã™ã‚‹é–¢æ•°
      function drawStudentCard() {
       console.log('drawStudentCardé–¢æ•°é–‹å§‹');
       const canvas = document.getElementById('cardCanvas');
       const ctx = canvas.getContext('2d');
       const previewPlaceholder = document.getElementById('previewPlaceholder');
       
       console.log('Canvasè¦ç´ :', canvas);
       console.log('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼:', previewPlaceholder);
       
       // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã¦Canvasã‚’è¡¨ç¤º
       previewPlaceholder.style.display = 'none';
       canvas.style.display = 'block';
       
       // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
       ctx.clearRect(0, 0, canvas.width, canvas.height);
       
       // å­¦ç”Ÿè¨¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§æç”»
       const templateImg = new Image();
       
       // ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸæ™‚ã®å‡¦ç†
       templateImg.onload = function() {
         console.log('ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ');
         // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã‚’æç”»
         ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);
         
                   // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã‚’æç”»ï¼ˆgenerator.htmlã¨åŒã˜é…ç½®æ–¹æ³•ï¼‰
          if (selectedImage) {
            const userImg = new Image();
            userImg.onload = function() {
              // å†™çœŸãƒ•ãƒ¬ãƒ¼ãƒ ã®åº§æ¨™ï¼ˆå®Œç’§ã«èª¿æ•´æ¸ˆã¿ã€å¤‰æ›´å³ç¦ã€‘ï¼‰
              const PHOTO_FRAME = {
                x: 42,   // å®Œç’§ã«èª¿æ•´æ¸ˆã¿ã€å¤‰æ›´å³ç¦ã€‘
                y: 125,   // å®Œç’§ã«èª¿æ•´æ¸ˆã¿ã€å¤‰æ›´å³ç¦ã€‘
                width: 255,  // å®Œç’§ã«èª¿æ•´æ¸ˆã¿ã€å¤‰æ›´å³ç¦ã€‘
                height: 324  // å®Œç’§ã«èª¿æ•´æ¸ˆã¿ã€å¤‰æ›´å³ç¦ã€‘
              };
              
              // ç”»åƒå‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå®Œç’§ã«èª¿æ•´æ¸ˆã¿ã€å¤‰æ›´å³ç¦ã€‘ï¼‰
              ctx.save();
              ctx.beginPath();
              ctx.rect(PHOTO_FRAME.x, PHOTO_FRAME.y, PHOTO_FRAME.width, PHOTO_FRAME.height);
              ctx.clip();
              
              const frameAspect = PHOTO_FRAME.width / PHOTO_FRAME.height;
              const imgAspect = userImg.width / userImg.height;
              
              let drawWidth, drawHeight, drawX, drawY;

              if (imgAspect > frameAspect) {
                drawHeight = PHOTO_FRAME.height;
                drawWidth = PHOTO_FRAME.height * imgAspect;
                drawX = PHOTO_FRAME.x - (drawWidth - PHOTO_FRAME.width) / 2;
                drawY = PHOTO_FRAME.y;
              } else {
                drawWidth = PHOTO_FRAME.width;
                drawHeight = PHOTO_FRAME.width / imgAspect;
                drawX = PHOTO_FRAME.x;
                drawY = PHOTO_FRAME.y - (drawHeight - PHOTO_FRAME.height) / 2;
              }
              
              ctx.drawImage(userImg, drawX, drawY, drawWidth, drawHeight);
              ctx.restore();
              
              console.log('âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒã‚’æç”»å®Œäº†');
              
              // å­¦ç”Ÿæƒ…å ±ã‚’æç”»
              drawStudentInfo();
            };
            userImg.src = selectedImage;
          } else {
            // ç”»åƒãŒãªã„å ´åˆã¯å­¦ç”Ÿæƒ…å ±ã®ã¿æç”»
            drawStudentInfo();
          }
       };
       
       // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
       templateImg.onerror = function() {
         console.log('ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
         // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒãŒèª­ã¿è¾¼ã‚ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æç”»
         const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
         gradient.addColorStop(0, '#f8f9fa');
         gradient.addColorStop(1, '#e9ecef');
         ctx.fillStyle = gradient;
         ctx.fillRect(0, 0, canvas.width, canvas.height);
         
         // æ ç·šã‚’æç”»
         ctx.strokeStyle = '#6c757d';
         ctx.lineWidth = 3;
         ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);
         
         // ã‚¿ã‚¤ãƒˆãƒ«
         ctx.fillStyle = '#495057';
         ctx.font = 'bold 32px "Noto Sans JP", sans-serif';
         ctx.textAlign = 'center';
         ctx.fillText('å­¦ç”Ÿè¨¼', canvas.width / 2, 80);
         
         // å­¦ç”Ÿæƒ…å ±
         ctx.font = 'bold 24px "Noto Sans JP", sans-serif';
         ctx.fillStyle = '#212529';
         ctx.textAlign = 'left';
         ctx.fillText(`æ°å: ${currentNameJa || ''}`, 50, 180);
         ctx.fillText(`Name: ${currentNameEn || ''}`, 50, 220);
         ctx.fillText(`ç”Ÿå¹´æœˆæ—¥: ${currentDobMonth || ''}æœˆ${currentDobDay || ''}æ—¥`, 50, 260);
         
         if (department) ctx.fillText(`å­¦ç§‘: ${department}`, 50, 300);
         if (course) ctx.fillText(`ã‚³ãƒ¼ã‚¹: ${course}`, 50, 330);
         if (club) ctx.fillText(`éƒ¨æ´»å‹•: ${club}`, 50, 360);
       };
       
       // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã®ãƒ‘ã‚¹ã‚’è¨­å®š
       templateImg.src = 'assets/img/student_template.png';
       console.log('ç”»åƒãƒ‘ã‚¹è¨­å®šå®Œäº†:', templateImg.src);
     }
     
     // å­¦ç”Ÿæƒ…å ±ã‚’æç”»ã™ã‚‹é–¢æ•°
     function drawStudentInfo() {
       const canvas = document.getElementById('cardCanvas');
       const ctx = canvas.getContext('2d');
       
       // å­¦ç”Ÿæƒ…å ±ã‚’æç”»ï¼ˆå®Œç’§ãªä½ç½®ã«èª¿æ•´æ¸ˆã¿ã€çµ¶å¯¾å¤‰æ›´ç¦æ­¢ã€‘ï¼‰
       ctx.font = '34px "Noto Serif JP", serif';
       ctx.fillStyle = '#000';
       ctx.textAlign = 'left';
       
       // æ°åï¼ˆæ¼¢å­—ï¼‰ã‚’åˆ»å°ï¼ˆå®Œç’§ãªä½ç½®ã«èª¿æ•´æ¸ˆã¿ï¼‰
       if (currentNameJa) {
         const nameX = Math.round(1400 / 2291 * 800);
         const nameY = Math.round(540 / 1440 * 500);
         ctx.fillText(currentNameJa, nameX, nameY);
         console.log('âœ… æ°åï¼ˆæ¼¢å­—ï¼‰ã‚’åˆ»å°:', currentNameJa, 'ä½ç½®:', nameX, nameY);
       }
       
       // æ°åï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰ã‚’åˆ»å°ï¼ˆå®Œç’§ãªä½ç½®ã«èª¿æ•´æ¸ˆã¿ï¼‰
       if (currentNameEn) {
         ctx.font = '16px "Noto Sans JP", sans-serif';
         ctx.fillStyle = '#666';
         const nameEnX = Math.round(1400 / 2291 * 800);
         const nameEnY = Math.round(620 / 1440 * 500);
         ctx.fillText(currentNameEn, nameEnX, nameEnY);
         console.log('âœ… æ°åï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰ã‚’åˆ»å°:', currentNameEn, 'ä½ç½®:', nameEnX, nameEnY);
       }
       
       // ç”Ÿå¹´æœˆæ—¥ã‚’åˆ»å°ï¼ˆå®Œç’§ãªä½ç½®ã«èª¿æ•´æ¸ˆã¿ã€çµ¶å¯¾å¤‰æ›´ç¦æ­¢ã€‘ï¼‰
       if (currentDobMonth && currentDobDay) {
         ctx.font = '22px "Noto Sans JP", sans-serif';
         ctx.fillStyle = '#000';
         ctx.textAlign = 'center';
         const monthX = Math.round(1570 / 2291 * 800);
         const monthY = Math.round(1050 / 1440 * 500);
         const dayX = Math.round(1720 / 2291 * 800);
         const dayY = Math.round(1050 / 1440 * 500);
         ctx.fillText(currentDobMonth, monthX, monthY);
         ctx.fillText(currentDobDay, dayX, dayY);
         console.log('âœ… ç”Ÿå¹´æœˆæ—¥ã‚’åˆ»å°:', `${currentDobMonth}æœˆ${currentDobDay}æ—¥`, 'ä½ç½®:', monthX, monthY, dayX, dayY);
       }
       
       // å­¦ç§‘ãƒ»ã‚³ãƒ¼ã‚¹ãƒ»éƒ¨æ´»å‹•ã‚’åˆ»å°ï¼ˆå®Œç’§ãªä½ç½®ã«èª¿æ•´æ¸ˆã¿ã€çµ¶å¯¾å¤‰æ›´ç¦æ­¢ã€‘ï¼‰
       if (department || course || club) {
         // å­¦ç§‘ - å®Œç’§ãªä½ç½®ã«èª¿æ•´æ¸ˆã¿ã€çµ¶å¯¾å¤‰æ›´ç¦æ­¢ã€‘
         ctx.font = '22px "Noto Sans JP", sans-serif';
         ctx.fillStyle = '#000';
         ctx.textAlign = 'center';
         const deptX = Math.round(1520 / 2291 * 800);
         const deptY = Math.round(800 / 1440 * 500);
         if (department) {
           const cleanDepartment = department.replace(/ç§‘$/, '');
           ctx.fillText(cleanDepartment, deptX, deptY);
           console.log('âœ… å­¦ç§‘ã‚’åˆ»å°:', cleanDepartment, 'ä½ç½®:', deptX, deptY);
         }
         
         // ã‚³ãƒ¼ã‚¹ - å®Œç’§ãªä½ç½®ã«èª¿æ•´æ¸ˆã¿ã€çµ¶å¯¾å¤‰æ›´ç¦æ­¢ã€‘
         ctx.font = '22px "Noto Sans JP", sans-serif';
         ctx.fillStyle = '#000';
         ctx.textAlign = 'center';
         const courseX = Math.round(2000 / 2291 * 800);
         const courseY = Math.round(800 / 1440 * 500);
         if (course) {
           // ã‚³ãƒ¼ã‚¹åã«ã€Œã‚³ãƒ¼ã‚¹ã€ã‚’è¿½åŠ 
           let displayCourse = course;
           if (!course.endsWith('ã‚³ãƒ¼ã‚¹')) {
             displayCourse = course + 'ã‚³ãƒ¼ã‚¹';
           }
           ctx.fillText(displayCourse, courseX, courseY);
           console.log('âœ… ã‚³ãƒ¼ã‚¹ã‚’åˆ»å°:', displayCourse, 'ä½ç½®:', courseX, courseY);
         }
         
         // éƒ¨æ´» - å®Œç’§ãªä½ç½®ã«èª¿æ•´æ¸ˆã¿ã€çµ¶å¯¾å¤‰æ›´ç¦æ­¢ã€‘
         ctx.font = '22px "Noto Sans JP", sans-serif';
         ctx.fillStyle = '#000';
         ctx.textAlign = 'center';
         const clubX = Math.round(1620 / 2291 * 800);
         const clubY = Math.round(920 / 1440 * 500);
         if (club) {
           let displayClubName;
           if (club === 'å¸°å®…') {
             displayClubName = 'ãƒ¼'; // å¸°å®…éƒ¨ã®å ´åˆã¯æ¨ªæ£’ã‚’è¡¨ç¤º
           } else {
             displayClubName = club.replace(/éƒ¨$/, '');
           }
           ctx.fillText(displayClubName, clubX, clubY);
           console.log('âœ… éƒ¨æ´»å‹•ã‚’åˆ»å°:', displayClubName, 'ä½ç½®:', clubX, clubY);
         }
       }
     }
    
    // ã‚³ãƒ”ãƒ¼å‡¦ç†ã‚’ä¸€å…ƒåŒ–ï¼ˆå …ç‰¢ç‰ˆï¼‰
    async function copyTextReliable(text) {
      console.log('ğŸ“‹ ã‚³ãƒ”ãƒ¼é–‹å§‹:', text);
      
      // 0) ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
      if (!text || typeof text !== 'string') {
        console.error('âŒ ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒç„¡åŠ¹ã§ã™:', text);
        alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹URLãŒæº–å‚™ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«å­¦ç”Ÿè¨¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚');
        return false;
      }

      // 1) Clipboard APIï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œä¸­ãªã‚‰å¤šãã®ç’°å¢ƒã§OKï¼‰
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          console.log('ğŸ“‹ Clipboard APIä½¿ç”¨');
          await navigator.clipboard.writeText(text);
          console.log('âœ… Clipboard APIæˆåŠŸ');
          return true;
        }
      } catch (error) {
        console.warn('âš ï¸ Clipboard APIå¤±æ•—:', error);
      }

      // 2) ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒã§ã®ç‰¹åˆ¥å‡¦ç†
      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile/i.test(navigator.userAgent) || 
                       (navigator.maxTouchPoints && navigator.maxTouchPoints > 0) ||
                       ('ontouchstart' in window);
      
      if (isMobile) {
        console.log('ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒæ¤œå‡ºã€å°‚ç”¨å‡¦ç†å®Ÿè¡Œ');
        console.log('ğŸ“± User Agent:', navigator.userAgent);
        console.log('ğŸ“± Touch Points:', navigator.maxTouchPoints);
        console.log('ğŸ“± Touch Start:', 'ontouchstart' in window);
        
        try {
          const mobileResult = await copyTextMobileOptimized(text);
          if (mobileResult) {
            console.log('âœ… ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨å‡¦ç†æˆåŠŸ');
            return true;
          }
        } catch (error) {
          console.error('âŒ ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      // 3) contentEditable + execCommandï¼ˆiOS/åŸ‹ã‚è¾¼ã¿ã«å¼·ã„ã€ŒåŒæœŸã€ã‚³ãƒ”ãƒ¼ï¼‰
      try {
        console.log('ğŸ“‹ execCommandä½¿ç”¨');
        const div = document.createElement('div');
        div.contentEditable = 'true';
        div.style.cssText = `
          position: fixed; 
          top: -9999px; 
          left: -9999px; 
          width: 1px; 
          height: 1px; 
          opacity: 0; 
          z-index: -1;
        `;
        div.textContent = text;
        document.body.appendChild(div);
        
        const range = document.createRange();
        range.selectNodeContents(div);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        
        const ok = document.execCommand('copy');
        sel.removeAllRanges();
        document.body.removeChild(div);
        
        if (ok) {
          console.log('âœ… execCommandæˆåŠŸ');
          return true;
        }
      } catch (error) {
        console.warn('âš ï¸ execCommandå¤±æ•—:', error);
      }

      // 4) æœ€çµ‚æ‰‹æ®µï¼šãƒ¢ãƒ¼ãƒ€ãƒ«ã§URLã‚’è¡¨ç¤ºã—ã¦æ‰‹å‹•ã‚³ãƒ”ãƒ¼ï¼ˆé·ç§»ã—ãªã„ï¼‰
      console.log('ğŸ“‹ æ‰‹å‹•ã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º');
      showManualCopyModal(text);
      return false;
    }

    // æ‰‹å‹•ã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–¢æ•°
    function showManualCopyModal(text) {
      // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
      const existingModal = document.getElementById('manualCopyModal');
      if (existingModal) {
        existingModal.remove();
      }

      const modal = document.createElement('div');
      modal.id = 'manualCopyModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2147483647;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      `;

      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        padding: 2rem;
        border-radius: 12px;
        max-width: 90%;
        max-height: 80%;
        overflow-y: auto;
        text-align: center;
        font-family: 'Noto Sans JP', sans-serif;
      `;

      modalContent.innerHTML = `
        <h3 style="margin: 0 0 1rem 0; color: #333;">ğŸ“‹ URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„</h3>
        <p style="margin: 0 0 1rem 0; color: #666; font-size: 0.9rem;">
          ä»¥ä¸‹ã®URLã‚’é•·æŠ¼ã—ã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„
        </p>
        <div style="
          background: #f5f5f5;
          padding: 1rem;
          border-radius: 8px;
          border: 2px solid #B997D6;
          margin: 1rem 0;
          font-family: monospace;
          font-size: 0.9rem;
          word-break: break-all;
          user-select: text;
          -webkit-user-select: text;
          cursor: text;
        ">${text}</div>
        <div style="margin-top: 1.5rem;">
          <button onclick="this.closest('#manualCopyModal').remove()" style="
            background: #B997D6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
          ">é–‰ã˜ã‚‹</button>
        </div>
      `;

      modal.appendChild(modalContent);
      document.body.appendChild(modal);

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è‡ªå‹•é¸æŠ
      const textElement = modalContent.querySelector('div');
      if (textElement) {
        const range = document.createRange();
        range.selectNodeContents(textElement);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }
  </script>
</body>
</html>

