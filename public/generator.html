<!DOCTYPE html>
<!-- 最優先TypeSquare完全遮断スクリプト（DOCTYPE直後） -->
<script>
(function() {
  'use strict';
  
  // 即座にTypeSquare関連のグローバル変数を無効化
  const tsVariables = ['ts', 'TypeSquare', 'Typekit', 'WebFont', 'Ts', 'TS', 'typesquare'];
  tsVariables.forEach(varName => {
    try {
      Object.defineProperty(window, varName, {
        get: function() { return null; },
        set: function() { return false; },
        configurable: false,
        enumerable: false
      });
    } catch(e) {}
  });
  
  // コンソールエラーを即座に抑制
  const originalConsoleError = console.error;
  const originalConsoleWarn = console.warn;
  
  console.error = function(...args) {
    const message = args.join(' ');
    if (message.includes('typesquare') || message.includes('ERR_BLOCKED_BY_CLIENT') || message.includes('Failed to load resource') || message.includes('net::ERR_') || message.includes('entry.')) {
      return; // 完全に無視
    }
    return originalConsoleError.apply(console, args);
  };
  
  console.warn = function(...args) {
    const message = args.join(' ');
    if (message.includes('typesquare') || message.includes('ERR_BLOCKED_BY_CLIENT')) {
      return; // 完全に無視
    }
    return originalConsoleWarn.apply(console, args);
  };
  
  // エラーイベントを即座に抑制
  window.addEventListener('error', function(e) {
    if (e.filename && (e.filename.includes('typesquare') || e.filename.includes('ts?') || e.filename.includes('entry.') || e.filename.includes('l.typesquare.com'))) {
      e.stopImmediatePropagation();
      e.preventDefault();
      return false;
    }
    if (e.message && (e.message.includes('typesquare') || e.message.includes('ERR_BLOCKED_BY_CLIENT') || e.message.includes('Failed to load resource') || e.message.includes('net::ERR_'))) {
      e.stopImmediatePropagation();
      e.preventDefault();
      return false;
    }
  }, true);
  
  // Promise rejectionも即座に抑制
  window.addEventListener('unhandledrejection', function(e) {
    if (e.reason && (e.reason.toString().includes('typesquare') || e.reason.toString().includes('ERR_BLOCKED_BY_CLIENT') || e.reason.toString().includes('Failed to fetch'))) {
      e.stopImmediatePropagation();
      e.preventDefault();
      return false;
    }
  }, true);
  
  // fetchとXMLHttpRequestを即座にフック
  if (window.fetch) {
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
      if (typeof url === 'string' && (url.includes('typesquare') || url.includes('l.typesquare.com') || url.includes('ts?condition=') || url.includes('entry.'))) {
        return Promise.reject(new Error('TypeSquare request blocked'));
      }
      return originalFetch.apply(this, arguments);
    };
  }
  
  if (XMLHttpRequest.prototype.open) {
    const originalXHROpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(method, url) {
      if (typeof url === 'string' && (url.includes('typesquare') || url.includes('l.typesquare.com') || url.includes('ts?condition=') || url.includes('entry.'))) {
        return;
      }
      return originalXHROpen.apply(this, arguments);
    };
  }
  
  console.log('🛡️ 最強TypeSquare遮断システム起動完了（DOCTYPE直後）');
})();
</script>
<html lang="ja">
<head>
  <!-- Cloudflare Pages用の特別な設定 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Studio埋め込み用の特別な設定 -->
  <meta name="robots" content="noindex, nofollow">
  <meta name="referrer" content="no-referrer">
  
  <!-- Cloudflare Pages用の特別な設定 -->
  <meta name="cf-pages" content="true">
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>学生証ジェネレーター</title>
  <meta property="og:title" content="放課後クロニクル 学生証ジェネレーター">
  <meta property="og:description" content="あなただけの学生証を作成しよう！">
  <meta property="og:image" content="https://res.cloudinary.com/di5xqlddy/image/upload/f_auto,q_auto,w_1200,h_630,c_fill,fl_force_strip/v1/student-id-generator/preview.png">
  <meta property="og:url" content="https://student-id-generator.pages.dev/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://res.cloudinary.com/di5xqlddy/image/upload/f_auto,q_auto,w_1200,h_630,c_fill,fl_force_strip/v1/student-id-generator/preview.png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

  <link id="generator-style" rel="stylesheet">
  <script>
    (function(){
      const ORIGIN = window.APP_ORIGIN || (location.hostname === 'localhost' || location.hostname === '127.0.0.1' 
        ? location.origin 
        : 'https://student-id-generator.pages.dev');
      
      // ファイルから直接開く場合は相対パスを使用
      if (location.protocol === 'file:') {
        document.getElementById('generator-style').href = 'assets/css/style.css';
      } else {
        document.getElementById('generator-style').href = ORIGIN + '/assets/css/style.css';
      }
    })();
  </script>
  <!-- <script src="assets/js/domain-masking.js"></script> -->
  <style>
    /* TypeSquareとStudio環境スクリプトの完全無効化 */
    link[href*="typesquare"], 
    script[src*="typesquare"],
    script[src*="entry."],
    script[src*="l.typesquare.com"],
    iframe[src*="typesquare"],
    *[data-typesquare],
    *[class*="typesquare"],
    *[id*="typesquare"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
      position: absolute !important;
      left: -9999px !important;
      top: -9999px !important;
      width: 0 !important;
      height: 0 !important;
    }
    
    /* 進捗バーとカード高さ調整（診断結果ページと完全に同じ） */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin-bottom: 2rem;
      overflow: hidden;
      margin-top: 2rem;  /* 診断結果ページと同じ上余白 */
    }

    .progress-fill {
      height: 100%;
      background: #B997D6;
      border-radius: 4px;
      transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1);
      width: 0%;
    }

    /* メインコンテナのレイアウト */
    .generator-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* カードグリッドレイアウト（デフォルト設定・スマホサイズでは縦並び） */
    .cards-grid {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      align-items: stretch;
      width: 100%;
      max-width: none;
      min-height: 500px;
      position: relative;
      overflow: visible;
      float: none;
      clear: both;
    }
    
    /* デスクトップサイズでのみグリッドレイアウト */
    @media (min-width: 769px) {
      .cards-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }
    }
    
    /* カードの強制横並び（デスクトップサイズのみ） */
    @media (min-width: 769px) {
      .cards-grid > * {
        display: block !important;
        float: none !important;
        clear: none !important;
        width: auto !important;
        max-width: none !important;
      }
      
      /* フォームカードとプレビューカードの強制横並び */
      .form-card, .preview-card {
        display: block !important;
        float: none !important;
        clear: none !important;
        width: auto !important;
        max-width: none !important;
        position: relative !important;
      }
    }

    /* フォームカードとプレビューカードの高さ調整（PCサイズは元の設定、スマホサイズは拡縮可能） */
    .form-card, .preview-card {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(185, 151, 214, 0.2);
      position: relative;
      overflow: hidden; /* PCサイズでは元の設定に戻す */
      display: flex;
      flex-direction: column;
      width: 100%;
      box-sizing: border-box;
      min-height: 450px; /* PCサイズでは元の高さに戻す */
      height: 550px; /* PCサイズでは元の高さに戻す */
      max-height: 550px; /* PCサイズでは元の高さに戻す */
    }
    
    /* デスクトップサイズでのみFlexboxレイアウト */
    @media (min-width: 769px) {
      .form-card, .preview-card {
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
    }

    /* カードのパディング調整（PCサイズは元の設定） */
    .form-card {
      padding: 1.5rem;
      min-height: 450px; /* PCサイズでは元の高さに戻す */
    }

    .preview-card {
      padding: 1.5rem;
      min-height: 450px; /* PCサイズでは元の高さに戻す */
    }

    /* カードヘッダーとフッターのマージン調整（PCサイズは元の設定） */
    .card-header {
      margin-bottom: 1rem;
      font-size: 1.4rem;
      font-weight: 700;
      color: #666;
      text-align: center;
      flex-shrink: 0;
    }

    .card-footer {
      margin-top: auto;
      padding-top: 1rem;
      display: flex;
      gap: 0.8rem;
      justify-content: center;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    
    /* デスクトップサイズでのみFlexboxレイアウト */
    @media (min-width: 769px) {
      .card-header {
        flex-shrink: 0;
      }
      
      .card-footer {
        margin-top: auto;
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        flex-shrink: 0;
      }
    }

    /* カードボディの調整（PCサイズは元の設定） */
    .card-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* デスクトップサイズでのみFlexboxレイアウト */
    @media (min-width: 769px) {
      .card-body {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }

    /* フォームカードの内容調整（PCサイズは元の設定） */
    .form-card h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      flex-shrink: 0;
    }
    
    /* デスクトップサイズでのみFlexboxレイアウト */
    @media (min-width: 769px) {
      .form-card h2 {
        flex-shrink: 0;
      }
    }

    /* フォームグループのマージン調整（PCサイズは元の設定） */
    .form-group {
      margin-bottom: 1rem;
    }

    /* ボタンコンテナのマージン調整（PCサイズは元の設定） */
    .card-footer button {
      margin: 0.4rem;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      background: #B997D6;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    /* デスクトップサイズでのみ横並びボタン */
    @media (min-width: 769px) {
      .card-footer button {
        margin: 0.5rem;
        width: auto;
      }
    }

    .card-footer button:hover {
      background: #A895D0;
      transform: translateY(-1px);
    }

    /* フォーム要素のスタイル */
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #666;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.6rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #B997D6;
    }

    /* 日付入力のレイアウト（スマホサイズでは縦並び対応） */
    .date-inputs {
      display: block;
      width: 100%;
      box-sizing: border-box;
    }
    
    .date-inputs .number-input {
      margin-bottom: 0.8rem;
      width: 100%;
    }
    
    /* デスクトップサイズでのみグリッドレイアウト */
    @media (min-width: 769px) {
      .date-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      
      .date-inputs .number-input {
        margin-bottom: 0;
      }
    }

    /* ファイル入力のスタイル（PCサイズは元の設定） */
    .file-input-label {
      display: block;
      padding: 1.5rem;
      border: 2px dashed #B997D6;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(185, 151, 214, 0.05);
    }

    .file-input-label:hover {
      background: rgba(185, 151, 214, 0.1);
      border-color: #A895D0;
    }

    .file-input-label input[type="file"] {
      display: none;
    }

    /* スマホ用レスポンシブ対応（UX重視） */
    @media (max-width: 768px) {
      /* 強制的に適用するための最強セレクタ */
      html body .generator-container .cards-grid .form-card,
      html body .generator-container .cards-grid .preview-card {
        padding: 1rem !important;
        min-height: 600px !important;
        max-height: none !important;
        height: auto !important;
        overflow: visible !important;
        transform: none !important;
        transition: none !important;
        animation: none !important;
      }
      
      html body .generator-container .cards-grid .form-card {
        min-height: 800px !important;
      }
      
      html body .generator-container .cards-grid .preview-card {
        min-height: 600px !important;
      }
      
      html body .generator-container .cards-grid .form-card > *,
      html body .generator-container .cards-grid .preview-card > * {
        margin-bottom: 1rem !important;
      }
      /* コンテナの調整 */
      .generator-container {
        padding: 0 1rem !important;
        margin: 1rem auto !important;
      }
      
      /* 進捗バーの調整 */
      .progress-bar {
        margin: 1rem 0 1.5rem 0 !important;
        height: 6px !important;
      }
      
      /* カードグリッドを縦並びに変更（スマホ最適化・最強化版） */
      .cards-grid {
        display: flex !important;
        flex-direction: column !important;
        grid: none !important;
        grid-template-columns: none !important;
        grid-template-rows: none !important;
        gap: 1.5rem !important;
        min-height: auto !important;
        height: auto !important;
        width: 100% !important;
        max-width: 100% !important;
        position: relative !important;
        overflow: visible !important;
        float: none !important;
        clear: both !important;
      }
      
      /* スマホでは横並びを完全に無効化（重複設定で確実性向上） */
      .cards-grid {
        grid: none !important;
        display: flex !important;
        flex-direction: column !important;
        grid-template-columns: none !important;
        grid-template-rows: none !important;
        grid-auto-flow: none !important;
        grid-auto-rows: none !important;
        grid-auto-columns: none !important;
      }
      
      /* カードの調整（スマホ最適化・コンパクトUI・重なり防止・縦幅最適化・全要素収容対応・要素切れ完全防止・高さ最適化・拡縮可能） */
      body .generator-container .cards-grid .form-card,
      body .generator-container .cards-grid .preview-card,
      .form-card, .preview-card {
        padding: 1rem !important; /* パディングをさらに縮小 */
        height: auto !important;
        min-height: 600px !important; /* 高さをさらに最適化 */
        max-height: none !important;
        margin: 0 !important;
        border-radius: 16px !important;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1) !important;
        box-sizing: border-box !important;
        overflow: visible !important; /* 要素の切れを防ぐ */
        position: relative !important;
        z-index: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        width: 100% !important;
        max-width: 100% !important;
        flex: none !important;
        order: 0 !important;
        /* 要素切れ完全防止のための追加設定 */
        word-wrap: break-word !important;
        word-break: break-word !important;
        white-space: normal !important;
        text-overflow: clip !important;
        /* 全要素収容のための追加設定 */
        flex-wrap: wrap !important;
        align-content: flex-start !important;
        justify-content: flex-start !important;
        /* スマホサイズでのみ拡縮可能 */
        resize: vertical !important;
        overflow-y: auto !important;
        /* 強制的に適用するための追加設定 */
        transform: none !important;
        transition: none !important;
        animation: none !important;
      }
      
      /* カード間の重なり防止・全要素収容対応・要素切れ完全防止・高さ大幅増加・拡縮可能 */
      body .generator-container .cards-grid .form-card,
      .form-card {
        z-index: 2 !important;
        margin-bottom: 1.5rem !important;
        min-height: 800px !important; /* フォームカードは全要素を確実に収容するため縦幅を最適化 */
        order: 1 !important;
        /* 要素切れ完全防止のための追加設定 */
        word-wrap: break-word !important;
        word-break: break-word !important;
        white-space: normal !important;
        text-overflow: clip !important;
        /* 全要素収容のための追加設定 */
        flex-wrap: wrap !important;
        align-content: flex-start !important;
        justify-content: flex-start !important;
        /* スマホサイズでのみ拡縮可能 */
        resize: vertical !important;
        overflow-y: auto !important;
      }
      
      body .generator-container .cards-grid .preview-card,
      .preview-card {
        z-index: 1 !important;
        margin-top: 0 !important;
        min-height: 600px !important; /* プレビューカードも縦幅を最適化 */
        order: 2 !important;
        /* 要素切れ完全防止のための追加設定 */
        word-wrap: break-word !important;
        word-break: break-word !important;
        white-space: normal !important;
        text-overflow: clip !important;
        /* 全要素収容のための追加設定 */
        flex-wrap: wrap !important;
        align-content: flex-start !important;
        justify-content: flex-start !important;
        /* スマホサイズでのみ拡縮可能 */
        resize: vertical !important;
        overflow-y: auto !important;
        /* 強制的に適用するための追加設定 */
        transform: none !important;
        transition: none !important;
        animation: none !important;
      }
      
      /* カード内の要素間隔を調整（重なり防止・全要素収容対応・間隔最適化） */
      body .generator-container .cards-grid .form-card > *,
      body .generator-container .cards-grid .preview-card > *,
      .form-card > *,
      .preview-card > * {
        margin-bottom: 1rem !important; /* 要素間隔をさらに最適化して全要素収容を確実に */
        position: relative !important;
        z-index: 1 !important;
        width: 100% !important;
        box-sizing: border-box !important;
        overflow: visible !important;
        max-height: none !important;
        height: auto !important;
      }
      
      .form-card > *:last-child,
      .preview-card > *:last-child {
        margin-bottom: 0 !important;
      }
      
      /* 重なり防止のための明示的な配置（Flexbox最適化・要素切れ防止） */
      .form-card h2 {
        position: relative !important;
        z-index: 2 !important;
        margin-bottom: 0.8rem !important;
        flex-shrink: 0 !important;
        height: auto !important; /* 高さ制限を解除 */
        overflow: visible !important; /* 要素の切れを防ぐ */
      }
      
      .form-card #studentForm {
        position: relative !important;
        z-index: 1 !important;
        margin-bottom: 0.8rem !important;
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-start !important;
        gap: 0.8rem !important;
        height: auto !important; /* 高さ制限を解除 */
        overflow: visible !important; /* 要素の切れを防ぐ */
        min-height: 0 !important; /* 最小高さ制限を解除 */
      }
      
      .form-card #diagnosisButtons {
        position: relative !important;
        z-index: 1 !important;
        margin-top: 0.8rem !important; /* autoから固定値に変更 */
        padding-top: 0.8rem !important;
        flex-shrink: 0 !important;
        height: auto !important; /* 高さ制限を解除 */
        overflow: visible !important; /* 要素の切れを防ぐ */
      }
      
      .preview-card .card-header {
        position: relative !important;
        z-index: 2 !important;
        margin-bottom: 0.8rem !important;
        flex-shrink: 0 !important;
        height: auto !important; /* 高さ制限を解除 */
        overflow: visible !important; /* 要素の切れを防ぐ */
      }
      
      .preview-card .card-body {
        position: relative !important;
        z-index: 1 !important;
        margin-bottom: 0.8rem !important;
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-start !important; /* 上揃えに変更 */
        align-items: center !important;
        min-height: 250px !important; /* プレビューエリアの最小高さをさらに最適化 */
        gap: 0.8rem !important; /* 要素間の間隔をさらに最適化 */
        padding: 0.3rem 0 !important; /* 上下のパディングをさらに最適化 */
        height: auto !important; /* 高さ制限を解除 */
        overflow: visible !important; /* 要素の切れを防ぐ */
      }
      
      .preview-card .card-footer {
        position: relative !important;
        z-index: 1 !important;
        margin-top: 0.8rem !important; /* autoから固定値に変更 */
        padding-top: 0.8rem !important;
        flex-shrink: 0 !important;
        height: auto !important; /* 高さ制限を解除 */
        overflow: visible !important; /* 要素の切れを防ぐ */
      }
      
      /* フォームカードの視認性向上・全要素収容対応 */
      .form-card {
        border-bottom: 3px solid #98d7a5 !important;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 246, 240, 0.95)) !important;
        position: relative !important;
        /* 全要素収容のための追加設定 */
        min-height: 1400px !important;
        height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        flex-wrap: wrap !important;
        align-content: flex-start !important;
        justify-content: flex-start !important;
      }
      
      /* フォームカードの最適化（PCサイズと統一・メリハリ付き） */
      .form-card h2 {
        font-size: 1.7rem !important; /* フォームタイトルも大きく */
        margin-bottom: 2rem !important;
        text-align: left !important;
        color: #333 !important; /* より濃い色で強調 */
        font-family: 'Noto Serif JP', serif !important;
        font-weight: 700 !important; /* より太く */
        line-height: 1.2 !important;
      }
      
      /* 画像選択エリアの最適化（余裕のあるUI・重なり防止・全要素収容対応） */
      .file-input-label {
        padding: 1.5rem 1rem !important; /* 全要素収容のためパディングをさらに最適化 */
        border-radius: 12px !important;
        font-size: 1.1rem !important;
        min-height: 120px !important; /* 全要素収容のため高さをさらに最適化 */
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin-bottom: 1rem !important; /* 全要素収容のためマージンをさらに最適化 */
        border: 2px dashed #B997D6 !important;
        background: rgba(185, 151, 214, 0.05) !important;
        transition: all 0.3s ease !important;
        cursor: pointer !important;
        text-align: center !important;
        line-height: 1.4 !important;
        position: relative !important;
        z-index: 1 !important;
      }
      
      .file-input-label:hover {
        background: rgba(185, 151, 214, 0.1) !important;
        border-color: #A895D0 !important;
        transform: translateY(-2px) !important;
      }
      
      /* フォーム要素の最適化（余裕のあるUI・重なり防止・全要素収容対応・要素切れ防止） */
      .form-group {
        margin-bottom: 1rem !important; /* 全要素収容のため間隔をさらに最適化 */
        padding: 0 !important;
        position: relative !important;
        z-index: 1 !important;
        height: auto !important; /* 高さ制限を解除 */
        overflow: visible !important; /* 要素の切れを防ぐ */
      }
      
      .form-group label {
        font-size: 1rem !important;
        margin-bottom: 0.6rem !important; /* ラベルと入力フィールドの間隔をさらに最適化 */
        font-weight: 600 !important;
        color: #666 !important;
        display: block !important;
        line-height: 1.4 !important;
        position: relative !important;
        z-index: 1 !important;
        height: auto !important; /* 高さ制限を解除 */
        overflow: visible !important; /* 要素の切れを防ぐ */
      }
      
      .form-group input,
      .form-group select {
        padding: 0.8rem !important; /* 全要素収容のためパディングをさらに最適化 */
        font-size: 16px !important; /* iOSでズームを防ぐ */
        border-radius: 10px !important;
        border-width: 2px !important;
        width: 100% !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        line-height: 1.4 !important;
        min-height: 44px !important; /* 全要素収容のためタッチターゲットサイズをさらに最適化 */
        position: relative !important;
        z-index: 1 !important;
        height: auto !important; /* 高さ制限を解除 */
        overflow: visible !important; /* 要素の切れを防ぐ */
      }
      
      /* 日付入力の最適化（余裕のあるUI・全要素収容対応） */
      .date-inputs {
        gap: 0.8rem !important; /* 全要素収容のため間隔をさらに最適化 */
        margin-bottom: 0.8rem !important; /* 全要素収容のためマージンをさらに最適化 */
      }
      
      .number-input select {
        padding: 0.8rem !important; /* 全要素収容のためパディングをさらに最適化 */
        font-size: 16px !important;
        min-height: 44px !important; /* 全要素収容のため高さをさらに最適化 */
        border-radius: 10px !important;
        border: 2px solid #e0e0e0 !important;
        background: white !important;
        cursor: pointer !important;
      }
      
      /* 診断ボタンの最適化（余裕のあるUI・重なり防止・全要素収容対応） */
      #diagnosisButtons {
        margin-top: 1rem !important; /* 全要素収容のためマージンをさらに最適化 */
        gap: 0.8rem !important; /* 全要素収容のため間隔をさらに最適化 */
        display: flex !important;
        flex-direction: column !important;
        align-items: stretch !important;
        padding-top: 0.8rem !important; /* 全要素収容のためパディングをさらに最適化 */
        position: relative !important;
        z-index: 1 !important;
      }
      
      #diagnosisButtons button {
        padding: 0.8rem 1rem !important; /* 全要素収容のためパディングをさらに最適化 */
        font-size: 1rem !important;
        border-radius: 10px !important;
        min-height: 44px !important; /* 全要素収容のため高さをさらに最適化 */
        font-weight: 600 !important;
        border: none !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        position: relative !important;
        z-index: 1 !important;
      }
      
      #diagnosisButtons button:active {
        transform: scale(0.98) !important;
      }
      
      /* プレビューカードの最適化（PCサイズと統一・余裕のあるUI・メリハリ付き） */
      .preview-card .card-header {
        font-size: 1.8rem !important; /* 学生証は大きく */
        margin-bottom: 2rem !important;
        text-align: left !important;
        color: #333 !important; /* より濃い色で強調 */
        font-family: 'Noto Serif JP', serif !important;
        font-weight: 700 !important; /* より太く */
        padding: 0 !important;
        line-height: 1.2 !important;
      }
      
      /* プレビューカードの視認性向上・全要素収容対応 */
      .preview-card {
        position: relative !important;
        margin-top: 1rem !important;
        border-top: 3px solid #B997D6 !important;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 246, 240, 0.95)) !important;
        /* 全要素収容のための追加設定 */
        min-height: 1200px !important;
        height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        flex-wrap: wrap !important;
        align-content: flex-start !important;
        justify-content: flex-start !important;
      }
      
      /* プレビューカードの説明文を強調（メリハリ付き・重なり防止・配置最適化） */
      .preview-card small {
        background: rgba(185, 151, 214, 0.1) !important;
        padding: 0.8rem !important;
        border-radius: 10px !important;
        border-left: 4px solid #B997D6 !important;
        margin: 0.3rem 0 !important; /* 上下のマージンをさらに最適化 */
        font-weight: 500 !important;
        line-height: 1.6 !important;
        font-size: 0.8rem !important; /* 画像保存誘導文は小さく */
        color: #666 !important;
        position: relative !important;
        z-index: 2 !important; /* z-indexを上げて重なりを防止 */
        flex-shrink: 0 !important;
        width: 100% !important; /* 幅を100%に設定 */
        box-sizing: border-box !important;
      }
      
      /* プレビュー画像の最適化 */
      #cardCanvas {
        max-width: 100% !important;
        height: auto !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
      }
      
      /* 説明文の最適化 */
      .preview-card small {
        font-size: 0.85rem !important;
        line-height: 1.5 !important;
        margin: 1rem 0 !important;
        padding: 0 0.5rem !important;
      }
      
      /* アクションボタンの最適化（余裕のあるUI・重なり防止） */
      .card-footer {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 0.8rem !important;
        margin-top: auto !important;
        padding-top: 0.8rem !important;
        border-top: 1px solid rgba(185, 151, 214, 0.2) !important;
        position: relative !important;
        z-index: 1 !important;
      }
      
      .card-footer button {
        width: 100% !important;
        padding: 0.8rem 1rem !important;
        font-size: 0.95rem !important; /* シェアボタンは中くらい */
        border-radius: 12px !important;
        min-height: 44px !important; /* タッチターゲットサイズをさらに最適化 */
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
        border: none !important;
        cursor: pointer !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
      }
      
      .card-footer button:active {
        transform: scale(0.96) !important;
        transition: transform 0.1s ease !important;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15) !important;
      }
      
      .card-footer button:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      }
      
      /* ボタンの色分けを明確化 */
      #downloadBtn {
        background: linear-gradient(135deg, #4CAF50, #45a049) !important;
        color: white !important;
        border: none !important;
      }
      
      #twitterBtn {
        background: linear-gradient(135deg, #1DA1F2, #0d8bd9) !important;
        color: white !important;
        border: none !important;
      }
      
      #urlBtn {
        background: linear-gradient(135deg, #6c757d, #5a6268) !important;
        color: white !important;
        border: none !important;
      }
      
      /* スクロールガイドの追加 */
      .scroll-guide {
        position: fixed !important;
        bottom: 20px !important;
        right: 20px !important;
        background: linear-gradient(135deg, rgba(185, 151, 214, 0.95), rgba(168, 149, 208, 0.9)) !important;
        color: white !important;
        padding: 0.8rem 1rem !important;
        border-radius: 25px !important;
        font-size: 0.9rem !important;
        font-weight: 600 !important;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25) !important;
        z-index: 1000 !important;
        animation: bounce 2s infinite !important;
        cursor: pointer !important;
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        backdrop-filter: blur(10px) !important;
        transition: all 0.3s ease !important;
      }
      
      .scroll-guide:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3) !important;
        background: linear-gradient(135deg, rgba(185, 151, 214, 1), rgba(168, 149, 208, 1)) !important;
      }
      
      .scroll-guide::before {
        content: '↓' !important;
        font-size: 1.4rem !important;
        font-weight: bold !important;
        color: white !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
        /* 矢印アイコンの代替オプション（コメントアウト） */
        /* content: '▼' !important; */ /* 黒い下向き三角形 */
        /* content: '⌄' !important; */ /* 下向き矢印（シンプル） */
        /* content: '⌃' !important; */ /* 上向き矢印（シンプル） */
        /* content: '◄' !important; */ /* 左向き矢印 */
        /* content: '►' !important; */ /* 右向き矢印 */
      }
      
      @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-10px);
        }
        60% {
          transform: translateY(-5px);
        }
      }
      
      /* フッターの最適化 */
      footer {
        margin-top: 2rem !important;
        padding: 1rem !important;
      }
      
      footer a {
        font-size: 0.9rem !important;
        padding: 0.5rem 1rem !important;
        border-radius: 6px !important;
        background: rgba(255, 255, 255, 0.1) !important;
        display: inline-block !important;
        margin: 0.3rem !important;
      }
    }
    
    /* 超小型スマホ対応（重なり防止・縦幅最適化・全要素収容対応・高さ最適化） */
    @media (max-width: 375px) {
      .generator-container {
        padding: 0 0.8rem !important;
      }
      
      .form-card, .preview-card {
        padding: 1rem !important;
        min-height: 700px !important; /* 全要素収容のため縦幅をさらに最適化 */
      }
      
      .form-card {
        min-height: 800px !important; /* 全要素収容のため縦幅をさらに最適化 */
      }
      
      .preview-card {
        min-height: 600px !important; /* 全要素収容のため縦幅をさらに最適化 */
      }
      
      .file-input-label {
        padding: 2rem 1rem !important; /* 全要素収容のためパディングを拡大 */
        min-height: 140px !important; /* 全要素収容のため高さを拡大 */
      }
      
      .form-group {
        margin-bottom: 2rem !important; /* 全要素収容のため間隔を拡大 */
      }
      
      .form-group input,
      .form-group select {
        padding: 1rem !important; /* 全要素収容のためパディングを拡大 */
        min-height: 48px !important; /* 全要素収容のため高さを拡大 */
      }
      
      .card-footer button {
        padding: 1rem 1.2rem !important; /* 全要素収容のためパディングを拡大 */
        min-height: 52px !important; /* 全要素収容のため高さを拡大 */
      }
    }
    
    /* 横向きスマホ対応（縦並び維持・重なり防止・縦幅最適化・全要素収容対応・高さ最適化） */
    @media (max-width: 768px) and (orientation: landscape) {
      .generator-container {
        padding: 0 1.5rem !important;
        margin: 0.5rem auto !important;
      }
      
      /* 横向きでも縦並びを維持 */
      .cards-grid {
        display: flex !important;
        flex-direction: column !important;
        gap: 1rem !important;
        grid: none !important;
      }
      
      .form-card, .preview-card {
        padding: 1rem !important;
        min-height: 600px !important; /* 全要素収容のため縦幅をさらに最適化 */
      }
      
      .form-card {
        min-height: 700px !important; /* 全要素収容のため縦幅をさらに最適化 */
      }
      
      .preview-card {
        min-height: 500px !important; /* 全要素収容のため縦幅をさらに最適化 */
      }
      
      .file-input-label {
        min-height: 150px !important; /* 全要素収容のため高さを拡大 */
        padding: 1.5rem !important;
      }
      
      .form-group {
        margin-bottom: 2rem !important; /* 全要素収容のため間隔を拡大 */
      }
      
      .card-footer {
        flex-direction: row !important;
        gap: 0.6rem !important;
      }
      
      .card-footer button {
        flex: 1 !important;
        min-width: 0 !important;
        padding: 0.8rem 1rem !important;
        min-height: 48px !important;
      }
      
      /* 横向き時のスクロールガイド位置調整 */
      .scroll-guide {
        bottom: 15px !important;
        right: 15px !important;
        padding: 0.6rem 0.8rem !important;
        font-size: 0.8rem !important;
        /* 横向き時は矢印アイコンも少し小さく */
      }
      
      .scroll-guide::before {
        font-size: 1.2rem !important;
      }
    }

    /* デスクトップ表示の強制横並び（重要・スマホサイズでは無効化） */
    @media (min-width: 769px) {
      .cards-grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 2rem !important;
        width: 100% !important;
        max-width: none !important;
        position: relative !important;
        overflow: visible !important;
        float: none !important;
        clear: both !important;
      }
      
      .generator-container {
        max-width: 1200px !important;
        margin: 0 auto !important;
        padding: 0 1rem !important;
      }
      
      .form-card, .preview-card {
        min-height: 500px !important;
        width: auto !important;
        flex: 1 !important;
        float: none !important;
        clear: none !important;
        max-width: none !important;
        position: relative !important;
        overflow: visible !important; /* 要素の切れを防ぐ */
        max-height: none !important; /* 高さ制限を解除 */
        display: flex !important; /* デスクトップではFlexbox表示 */
        flex-direction: column !important;
      }
    }
    
    /* 重複するメディアクエリを削除（統合版に統合済み） */

    /* 重複するタッチ操作最適化を削除（統合版に統合済み） */
    
    /* トースト表示のスタイル */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 10000;
      font-size: 14px;
      transition: opacity 0.3s ease;
    }

    .toast.show {
      opacity: 1;
    }

    .toast.hide {
      opacity: 0;
    }

    /* デバッグ用スタイルは削除済み（レイアウト問題解決完了） */
    
    /* 根本原因修正：style.cssのmain要素グリッド設定を無効化 */
    .generator-container {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
    }
    
    /* スマホサイズでの強制適用（最強版） */
    @media (max-width: 768px) {
      /* カードの高さを強制的に設定 */
      .generator-container .cards-grid .form-card {
        min-height: 800px !important;
        max-height: none !important;
        height: auto !important;
        padding: 1rem !important;
        overflow: visible !important;
      }
      
      .generator-container .cards-grid .preview-card {
        min-height: 600px !important;
        max-height: none !important;
        height: auto !important;
        padding: 1rem !important;
        overflow: visible !important;
      }
      
      /* カード内の要素間隔を強制的に設定 */
      .generator-container .cards-grid .form-card > *,
      .generator-container .cards-grid .preview-card > * {
        margin-bottom: 1rem !important;
      }
      
      /* フォーム要素の間隔を強制的に設定 */
      .generator-container .cards-grid .form-card .form-group {
        margin-bottom: 1rem !important;
      }
      
      /* 画像選択エリアを強制的に設定 */
      .generator-container .cards-grid .form-card .file-input-label {
        padding: 1.5rem 1rem !important;
        min-height: 120px !important;
        margin-bottom: 1rem !important;
      }
      
      /* スクロールガイドを表示（スマホサイズのみ） */
      .scroll-guide {
        display: flex !important;
      }
    }
    
    /* PCサイズではスクロールガイドを完全に非表示 */
    @media (min-width: 769px) {
      .scroll-guide {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
        position: absolute !important;
        left: -9999px !important;
        top: -9999px !important;
      }
    }
    
    /* style.cssのmain要素グリッド設定を完全に無効化 */
    main.generator-container {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
      max-width: 1200px !important;
      margin: 0 auto !important;
      padding: 0 1rem !important;
    }
    
    /* すべてのmain要素のグリッド設定を無効化（確実性のため） */
    main {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
    }
    
    /* style.cssのmain要素グリッド設定を完全に無効化 */
    main.generator-container {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
      max-width: 1200px !important;
      margin: 0 auto !important;
      padding: 0 1rem !important;
    }
    
    /* より具体的なセレクタで無効化 */
    body > main.generator-container {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
    }
    
    /* すべてのmain要素のグリッド設定を完全に無効化 */
    main, main.generator-container, body > main {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
      grid-template-rows: none !important;
      grid-auto-flow: none !important;
      align-items: stretch !important;
      justify-items: stretch !important;
    }
    
    /* より強力な無効化 */
    *[class*="generator"] {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
    }
    
    /* style.cssのすべてのグリッド設定を完全に無効化 */
    main, main.generator-container, body > main,
    main[style*="grid"], main[class*="generator"] {
      display: block !important;
      grid-template-columns: none !important;
      grid-template-rows: none !important;
      gap: 0 !important;
      grid-auto-flow: none !important;
      align-items: stretch !important;
      justify-items: stretch !important;
      grid-template-areas: none !important;
      grid-area: auto !important;
    }
    
    /* メディアクエリ内のグリッド設定も無効化 */
    @media (max-width: 768px) {
      main, main.generator-container, body > main {
        display: block !important;
        grid-template-columns: none !important;
        grid-template-rows: none !important;
        gap: 0 !important;
        grid-auto-flow: none !important;
        align-items: stretch !important;
        justify-items: stretch !important;
      }
    }
    
    /* より具体的なセレクタで無効化 */
    body > main.generator-container,
    html body main.generator-container,
    .generator-container {
      display: block !important;
      grid-template-columns: none !important;
      grid-template-rows: none !important;
      gap: 0 !important;
      grid-auto-flow: none !important;
      align-items: stretch !important;
      justify-items: stretch !important;
      grid-template-areas: none !important;
      grid-area: auto !important;
    }
    
    /* cards-gridのグリッド設定を確実に有効化（デスクトップサイズのみ） */
    @media (min-width: 769px) {
      .cards-grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        grid-template-rows: 1fr !important;
        gap: 2rem !important;
        width: 100% !important;
        max-width: none !important;
        min-height: 550px !important;
        height: 550px !important;
        align-items: stretch !important;
        justify-items: stretch !important;
        position: relative !important;
        overflow: visible !important;
        float: none !important;
        clear: both !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        padding: 0 !important;
        grid-auto-flow: row !important;
        grid-auto-rows: 1fr !important;
      }
    }
    
    /* フォームカードとプレビューカードの高さ統一（PCサイズのみ・スマホサイズでは無効化） */
    @media (min-width: 769px) {
      .form-card, .preview-card {
        height: 550px !important;
        min-height: 550px !important;
        max-height: 550px !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-start !important;
        align-items: stretch !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
        position: relative !important;
        top: 0 !important;
        margin-top: 0 !important;
        padding-top: 1.5rem !important;
      }
    }
    
          /* カード内の要素を強制的に配置（PCサイズのみ・スマホサイズでは無効化） */
      @media (min-width: 769px) {
        .form-card > *, .preview-card > * {
          box-sizing: border-box !important;
          margin: 0 !important;
          height: auto !important; /* 高さ制限を解除 */
          overflow: visible !important; /* 要素の切れを防ぐ */
          max-height: none !important; /* 最大高さ制限を解除 */
        }
        
        /* カードヘッダーの調整（高さ統一・要素切れ防止） */
        .form-card h2, .preview-card .card-header {
          margin-top: 0 !important;
          margin-bottom: 1rem !important;
          flex-shrink: 0 !important;
          height: auto !important;
          line-height: 1.2 !important;
          padding: 0 !important;
          overflow: visible !important; /* 要素の切れを防ぐ */
          max-height: none !important; /* 最大高さ制限を解除 */
        }
        
        /* カードボディの調整（高さ統一・要素切れ防止） */
        .form-card #studentForm, .preview-card .card-body {
          flex: 1 !important;
          display: flex !important;
          flex-direction: column !important;
          justify-content: flex-start !important;
          align-items: stretch !important;
          min-height: 0 !important;
          height: auto !important;
          margin: 0 !important;
          padding: 0 !important;
          overflow: visible !important; /* 要素の切れを防ぐ */
          max-height: none !important; /* 最大高さ制限を解除 */
        }
        
        /* カードフッターの調整（高さ統一・要素切れ防止） */
        .form-card #diagnosisButtons, .preview-card .card-footer {
          margin-top: 1.5rem !important; /* autoから固定値に変更 */
          padding-top: 1rem !important;
          flex-shrink: 0 !important;
          height: auto !important;
          position: relative !important;
          bottom: 0 !important;
          overflow: visible !important; /* 要素の切れを防ぐ */
          max-height: none !important; /* 最大高さ制限を解除 */
        }
      }
    
    /* プレビューカードの内容を中央に配置（PCサイズのみ・スマホサイズでは無効化） */
    @media (min-width: 769px) {
      .preview-card .card-body {
        align-items: center !important;
        justify-content: center !important;
        flex: 1 !important;
      }
      
      /* プレビュー画像のサイズ調整 */
      #cardCanvas {
        max-width: 100% !important;
        height: auto !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
      }
      
      /* 説明文の配置調整 */
      .preview-card small {
        margin-top: 1rem !important;
        text-align: center !important;
        line-height: 1.4 !important;
        flex-shrink: 0 !important;
      }
      
      /* カード内の要素を強制的に配置 */
      .form-card > *, .preview-card > * {
        box-sizing: border-box !important;
      }
      
      /* カードヘッダーの調整 */
      .form-card h2, .preview-card .card-header {
        margin-top: 0 !important;
        margin-bottom: 1rem !important;
        flex-shrink: 0 !important;
      }
      
      /* カードボディの調整 */
      .form-card #studentForm, .preview-card .card-body {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-start !important;
      }
      
      /* カードフッターの調整 */
      .form-card #diagnosisButtons, .preview-card .card-footer {
        margin-top: auto !important;
        padding-top: 1rem !important;
        flex-shrink: 0 !important;
      }
      
      /* プレビューカードの内容を中央に配置 */
      .preview-card .card-body {
        align-items: center !important;
        justify-content: center !important;
      }
      
      /* プレビュー画像のサイズ調整 */
      #cardCanvas {
        max-width: 100% !important;
        height: auto !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
      }
      
      /* 説明文の配置調整 */
      .preview-card small {
        margin-top: 1rem !important;
        text-align: center !important;
        line-height: 1.4 !important;
      }
    }
  </style>
  <script>
    // このページでは高度対策をOFF（画像保存・Canvas操作のため）
    window.AdvancedSecurityConfig = { preventSideChannelAttacks: false };
  </script>
  <!-- ブートローダー（フォールバック付き・自前ドメイン固定） -->
  <script>
    (function () {
      // ローカル環境と本番環境を自動判定
      const MY_ORIGIN = location.hostname === 'localhost' || location.hostname === '127.0.0.1' 
        ? location.origin 
        : 'https://student-id-generator.pages.dev';

      // 埋め込み先(preview.studio.site等)では常に自分のドメインから読み込む
      window.APP_ORIGIN = MY_ORIGIN;
      
      // app.js読み込みフラグ（重複防止用）
      if (typeof window.APP_JS_LOADED === 'undefined') {
        window.APP_JS_LOADED = false;
      }

      function loadWithFallback(primary, fallback) {
        const s = document.createElement('script');
        s.defer = true;
        s.src = APP_ORIGIN + '/' + primary;
        s.setAttribute('data-loaded', 'true');
        s.onload = () => {
          console.log('✅ loadWithFallback完了:', primary);
          // 初期化を確実に実行
          setTimeout(() => {
            if (typeof window.initGeneratorPage === 'function') {
              console.log('🔄 loadWithFallbackからinitGeneratorPageを実行中...');
              window.initGeneratorPage();
            } else {
              console.log('❌ loadWithFallbackからinitGeneratorPageが見つかりません');
            }
          }, 100);
        };
        s.onerror = () => {
          if (!fallback) return;
          console.log('フォールバック: ' + primary + ' → ' + fallback);
          const s2 = document.createElement('script');
          s2.defer = true;
          s2.src = fallback;
          s2.setAttribute('data-loaded', 'true');
          s2.onload = () => {
            console.log('✅ フォールバック完了:', fallback);
            // フォールバックでも初期化を実行
            setTimeout(() => {
              if (typeof window.initGeneratorPage === 'function') {
                console.log('🔄 フォールバックからinitGeneratorPageを実行中...');
                window.initGeneratorPage();
              } else {
                console.log('❌ フォールバックからinitGeneratorPageが見つかりません');
              }
            }, 100);
          };
          document.head.appendChild(s2);
        };
        document.head.appendChild(s);
      }

      function load(p) {
        const s = document.createElement('script');
        s.src = APP_ORIGIN + '/' + p;
        s.defer = true;
        document.head.appendChild(s);
      }

      // セキュリティ系（現状のままでOK）
      load('assets/js/comprehensive-security.js');
      load('assets/js/security.js');
      load('assets/js/privacy-protection.js');
      load('assets/js/security-monitor.js');

      // app.jsは最後に読み込み（依存関係のため）
      setTimeout(() => {
        // 既に読み込まれているかチェック
        if (typeof window.drawStudentCard === 'undefined' && !window.APP_JS_LOADED) {
          console.log('🔄 app.jsを読み込み中...');
          window.APP_JS_LOADED = true;
          loadWithFallback('assets/js/app.js?v=20250902', 'assets/js/app.js?v=20250902');
        } else {
          console.log('✅ app.jsは既に読み込まれています');
        }
      }, 100);
      
      // ページ遷移時の重複読み込み防止
      if (window.APP_JS_LOADED) {
        console.log('✅ ページ遷移時の重複読み込み防止');
      }
      
      // デバッグ用ログ
      console.log('✅ スクリプトローダー初期化完了');
      console.log('APP_ORIGIN:', APP_ORIGIN);
      console.log('現在のURL:', window.location.href);
      console.log('相対パステスト:', new URL('assets/js/app.js', window.location.href).href);
    })();
  </script>
  
  <!-- 共有URL生成機能 -->
  <script>
    // 共有用ドメイン（ローカル環境では現在のオリジンを使用）
    const SHARE_BASE = location.hostname === 'localhost' || location.hostname === '127.0.0.1' 
      ? location.origin 
      : 'https://student-id-generator.pages.dev';
    
    // Cloudinary設定（app.jsと同期、二重定義防止）
    window.cloudinaryConfig ??= { 
      cloudName: 'di5xqlddy', 
      uploadPreset: 'student_card_AS_chronicle' 
    };

    // Base64URL関数は削除済み（短い固定形式に統一）

    <!-- 共有URL生成は app.js の実装を利用（再定義しない） -->
    
    // 共有リンク更新関数（app.jsから呼び出される）…UIは保持のみ、ハンドラはapp.jsが参照
    function updateShareLinksWithImage(imageData, text) {
      const shareUrl = buildShareUrlWithImage({
        public_id: imageData.public_id,
        version: imageData.version
      });
      console.log('共有URL更新:', shareUrl);
      // 共有URLを保存
      window.__shareUrl = shareUrl;
      
      // URLコピー
      const urlBtn = document.getElementById('urlBtn');
      if (urlBtn) urlBtn.onclick = () => copyTextReliable(window.__shareUrl);
      
      // 画像生成後は共有素材を最新に更新（常時バインド済みハンドラがこれを参照する）
      window.__lastImageData = imageData;
      window.__ogpImageUrl = `${location.origin}/ogp/v${imageData.version}/${imageData.public_id.split('/').map(encodeURIComponent).join('/')}.jpg`;
      
      // 表示用フィールドがあれば更新
      const field = document.getElementById('shareLinkField');
      if (field) field.value = shareUrl;
    }
    window.updateShareLinksWithImage = updateShareLinksWithImage;
    

    
    // ✅ ページ読込時に"常時"バインド（画像生成の有無に関わらず動く）
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('twitterBtn');
      if (!btn) return;
      btn.addEventListener('click', async (e) => {
        e.preventDefault(); e.stopPropagation();
        try {
          const last = window.loadResult?.();
          if (!last || !last.public_id || !last.version) {
            alert('先に学生証を作成してください'); return;
          }
          // 共有URLは app.js の実装を使う
          const shareUrl = window.buildShareUrlWithImage?.({
            public_id: last.public_id,
            version  : last.version,
            eager_url: last.eager_url || last.secure_url
          });
          const text = [
            'ようこそ、夢見が丘女子高等学校へ！',
            '　忘れられない放課後を、あなたに。',
            '✎︎＿＿＿＿＿＿＿＿＿＿＿＿＿＿',
            '',
            '▼ #放課後クロニクル　のHPで自分だけの学生証を作ろう！'
          ].join('\n');
          // iOSはアプリのみ・他はIntent新規タブ
          await window.shareToXAppFirstOnly?.(last.eager_url || last.secure_url, `${text}\n${shareUrl}`);
        } catch (e){}
      }, { passive: false });
    });

    // フォーム初期化処理は app.js の initGeneratorPage に統合
    

  </script>
  
  <!-- 直アクセス防止：診断未実施なら診断ゲームへ誘導 -->
  <script>
    (() => {
      // ① 既に一度リダイレクトしたら二度目はしない（ループ防止）
      if (sessionStorage.getItem('redir_guard') === '1') return;

      // Studio埋め込み時は直アクセス防止を完全に無効化
      try {
        // URLパラメータで明示的に埋め込み指定されている場合は無効化
        const sp = new URLSearchParams(location.search);
        if (sp.get('embed') === '1' || sp.get('studio') === '1' || sp.get('iframe') === '1') {
          console.log('🚀 URLパラメータで埋め込み検出、直アクセス防止を無効化');
          return;
        }
        
        // 診断情報がsessionStorageにある場合は安全
        if (sessionStorage.getItem('diagCtx') || 
            sessionStorage.getItem('as_chronicle_diagnosis') || 
            sessionStorage.getItem('as_chronicle_last_result')) {
          console.log('🚀 診断情報検出、直アクセス防止を無効化');
          return;
        }
        
        // セッションストレージにStudioフラグがある場合
        if (sessionStorage.getItem('studio_embed_flag') === '1') {
          console.log('🚀 Studioフラグ検出、直アクセス防止を無効化');
          return;
        }
        
        // generator_redirect_infoがある場合（Studio埋め込み遷移）
        if (sessionStorage.getItem('generator_redirect_info')) {
          console.log('🚀 Studio埋め込み遷移情報検出、直アクセス防止を無効化');
          return;
        }
        
        // Cloudflare Pages環境では、Studio埋め込みの可能性を考慮して直アクセス防止を無効化
        if (window.location.hostname === 'student-id-generator.pages.dev') {
          console.log('🚀 Cloudflare環境検出、Studio埋め込みの可能性を考慮して直アクセス防止を無効化');
          return;
        }
        
        // その他の環境でも、埋め込みの可能性がある場合は無効化
        if (window.parent !== window || window.top !== window || window.frameElement) {
          console.log('🚀 iframe環境検出、直アクセス防止を無効化');
          return;
        }
        
        // リファラが他オリジンの場合は埋め込みの可能性
        if (document.referrer && !document.referrer.startsWith(location.origin)) {
          console.log('🚀 他オリジンからのアクセス検出、埋め込みの可能性を考慮して直アクセス防止を無効化');
          return;
        }
        
        // より強力な埋め込み判定
        try {
          // 現在のURLがStudio環境かどうかの判定
          const currentUrl = window.location.href;
          if (currentUrl.includes('preview.studio.site') || 
              currentUrl.includes('studio.site') || 
              currentUrl.includes('embed') ||
              currentUrl.includes('iframe') ||
              currentUrl.includes('live/') ||
              currentUrl.includes('studio')) {
            console.log('🚀 Studio環境URL検出、直アクセス防止を無効化');
            return;
          }
          
          // リファラがStudio環境からの場合
          if (document.referrer && (
              document.referrer.includes('preview.studio.site') ||
              document.referrer.includes('studio.site') ||
              document.referrer.includes('embed') ||
              document.referrer.includes('iframe') ||
              document.referrer.includes('live/')
          )) {
            console.log('🚀 Studio埋め込み環境検出、直アクセス防止を無効化');
            return;
          }
          
          // セキュリティコンテキストの判定
          if (window.isSecureContext === false) {
            console.log('🚀 セキュリティコンテキスト判定、埋め込みの可能性を考慮して直アクセス防止を無効化');
            return;
          }
          
          // 例外発生時は埋め込み扱い
          try {
            if (window.trustedTypes && window.trustedTypes.defaultPolicy) {
              console.log('🚀 trustedTypes判定、埋め込みの可能性を考慮して直アクセス防止を無効化');
              return;
            }
          } catch(_) {}
          
        } catch(e) {
          console.log('🚀 詳細判定での例外発生により埋め込み扱い、直アクセス防止を無効化');
          return;
        }
        
      } catch(e) {
        console.log('🚀 例外発生により埋め込み扱い、直アクセス防止を無効化');
        return;
      }

      // ② 本当に"直リンク"だけ跳ねる（埋め込み時は絶対にリダイレクトしない）
      const sp = new URLSearchParams(location.search);
      const hasParams = ['department','course','club'].some(k => sp.has(k));

      const hasCtx =
        sessionStorage.getItem('diagCtx') ||
        sessionStorage.getItem('as_chronicle_diagnosis') ||
        sessionStorage.getItem('as_chronicle_last_result');

      if (!hasParams && !hasCtx) {
        console.log('🚫 直アクセスを検出、診断ゲームへリダイレクト');
        sessionStorage.setItem('redir_guard','1');
        location.replace('./index.html');
      } else {
        console.log('✅ 埋め込みまたは診断済み、リダイレクトしない');
        console.log('📋 詳細:', {
          hasParams: hasParams,
          hasCtx: hasCtx,
          params: Object.fromEntries(sp.entries()),
          sessionStorage: {
            diagCtx: sessionStorage.getItem('diagCtx'),
            as_chronicle_diagnosis: sessionStorage.getItem('as_chronicle_diagnosis'),
            as_chronicle_last_result: sessionStorage.getItem('as_chronicle_last_result')
          }
        });
        
        // 診断情報をsessionStorageに保存（安全性向上）
        if (hasParams) {
          try {
            const diagnosisData = {
              department: sp.get('department'),
              course: sp.get('course'),
              club: sp.get('club'),
              previewMessage: sp.get('previewMessage'),
              episodeMessage: sp.get('episodeMessage'),
              timestamp: Date.now()
            };
            sessionStorage.setItem('as_chronicle_diagnosis', JSON.stringify(diagnosisData));
            console.log('💾 診断情報を保存:', diagnosisData);
          } catch(e) {
            console.warn('⚠️ 診断情報の保存に失敗:', e);
          }
        }
        
        // 埋め込みフラグを設定
        try {
          sessionStorage.setItem('studio_embed_flag', '1');
          console.log('🏷️ 埋め込みフラグを設定');
        } catch(e) {
          console.warn('⚠️ 埋め込みフラグの設定に失敗:', e);
        }
      }
      
      // デバッグ用ログ（埋め込み判定の確認）
      console.log('🔍 直アクセス防止チェック:', {
        hasParams, hasCtx,
        referrer: document.referrer,
        ancestorOrigins: location.ancestorOrigins,
        windowParent: window.parent !== window,
        hostname: window.location.hostname,
        isSecureContext: window.isSecureContext,
        windowTop: window.top !== window
      });
      
      // Studio埋め込み時の詳細デバッグ情報
      try {
        const debugInfo = {
          timestamp: Date.now(),
          url: window.location.href,
          referrer: document.referrer,
          hostname: window.location.hostname,
          parent: window.parent !== window,
          top: window.top !== window,
          frameElement: !!window.frameElement,
          isSecureContext: window.isSecureContext,
          sessionStorage: {
            studio_embed_flag: sessionStorage.getItem('studio_embed_flag'),
            generator_redirect_info: sessionStorage.getItem('generator_redirect_info'),
            next_generator_url: sessionStorage.getItem('next_generator_url'),
            diagCtx: sessionStorage.getItem('diagCtx'),
            as_chronicle_diagnosis: sessionStorage.getItem('as_chronicle_diagnosis'),
            as_chronicle_last_result: sessionStorage.getItem('as_chronicle_last_result')
          },
          urlParams: Object.fromEntries(new URLSearchParams(location.search).entries())
        };
        
        console.log('🔍 Studio埋め込み詳細デバッグ:', debugInfo);
        
        // セッションストレージにデバッグ情報を保存
        sessionStorage.setItem('generator_debug_info', JSON.stringify(debugInfo));
        
      } catch(e) {
        console.warn('⚠️ デバッグ情報の保存に失敗:', e);
      }
    })();
  </script>
</head>
<body>
  <header>
    <!-- ヘッダータイトル削除 -->
  </header>

  <main class="generator-container">
    <!-- 進捗バー -->
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <div class="cards-grid">
      <section class="form-card">
        <h2>学生証を作成</h2>
        <div id="studentForm">
          <div class="form-group">
            <label class="file-input-label" for="photoInput">
              画像を選択
              <input type="file" id="photoInput" accept="image/*">
            </label>
          </div>

          <div class="form-group">
            <label>
              氏名（漢字）
              <input type="text" id="nameJa" placeholder="例：高森のばら" autocomplete="off" autocapitalize="off" spellcheck="false">
            </label>
          </div>

          <div class="form-group">
            <label>
              氏名（ローマ字）
              <input type="text" id="nameEn" placeholder="例：Takamori Nobara" autocapitalize="words" inputmode="latin" spellcheck="false" autocomplete="off">
            </label>
          </div>

          <div class="form-group">
            <label>
              生年月日
            </label>
            <div class="date-inputs">
              <div class="number-input">
                <select id="dobMonth" autocomplete="one-time-code">
                  <option value="">月</option>
                  <option value="1">1月</option>
                  <option value="2">2月</option>
                  <option value="3">3月</option>
                  <option value="4">4月</option>
                  <option value="5">5月</option>
                  <option value="6">6月</option>
                  <option value="7">7月</option>
                  <option value="8">8月</option>
                  <option value="9">9月</option>
                  <option value="10">10月</option>
                  <option value="11">11月</option>
                  <option value="12">12月</option>
                </select>
              </div>
              <div class="number-input">
                <select id="dobDay" autocomplete="one-time-code">
                  <option value="">日</option>
                  <option value="1">1日</option>
                  <option value="2">2日</option>
                  <option value="3">3日</option>
                  <option value="4">4日</option>
                  <option value="5">5日</option>
                  <option value="6">6日</option>
                  <option value="7">7日</option>
                  <option value="8">8日</option>
                  <option value="9">9日</option>
                  <option value="10">10日</option>
                  <option value="11">11日</option>
                  <option value="12">12日</option>
                  <option value="13">13日</option>
                  <option value="14">14日</option>
                  <option value="15">15日</option>
                  <option value="16">16日</option>
                  <option value="17">17日</option>
                  <option value="18">18日</option>
                  <option value="19">19日</option>
                  <option value="20">20日</option>
                  <option value="21">21日</option>
                  <option value="22">22日</option>
                  <option value="23">23日</option>
                  <option value="24">24日</option>
                  <option value="25">25日</option>
                  <option value="26">26日</option>
                  <option value="27">27日</option>
                  <option value="28">28日</option>
                  <option value="29">29日</option>
                  <option value="30">30日</option>
                  <option value="31">31日</option>
                </select>
              </div>
            </div>
          </div>

          <!-- 診断ゲーム連携ボタン（診断結果設定時のみ表示） -->
          <div id="diagnosisButtons" style="display: none; margin-top: 1rem; gap: 0.5rem; flex-wrap: wrap;">
            <button type="button" id="backToDiagnosisBtn" style="background: linear-gradient(135deg, #98d7a5, #98c8a8); color: white; flex: 1; min-width: 120px;">
              診断に戻る
            </button>
            <button type="button" id="viewDiagnosisResultBtn" style="background: linear-gradient(135deg, #87ceeb, #98c8e8); color: white; flex: 1; min-width: 120px;">
              診断結果を見る
            </button>
          </div>
        </div>
      </section>

      <section class="preview-card">
        <div class="card-header">
          プレビュー
        </div>
        <div class="card-body">
          <canvas id="cardCanvas" width="800" height="500"></canvas>
          <img id="cardPreview" alt="学生証プレビュー" style="display: none;">
        </div>
        <small style="display:block; margin:.5rem 0 0; font-size:12px; color:#888; text-align:center;">
          ※PCはプレビュー画像の上で右クリック →「名前を付けて画像を保存」<br>
          ※共有URLは必ず「URLをコピー」ボタンから取得してください
        </small>
        <div class="card-footer">
          <button type="button" id="downloadBtn">
            画像を保存
          </button>
          <script>
            document.getElementById('downloadBtn')?.addEventListener('click', (e) => {
              e.preventDefault(); e.stopPropagation();
              try {
                // 直前生成フラグ（ガードを通す）
                sessionStorage.setItem('as_chronicle_last_result','1');
                const cvs = document.getElementById('cardCanvas');
                if (cvs) window.downloadCanvasAsImage?.(cvs, '放課後クロニクル_学生証.png');
              } catch(e){}
            }, { passive:false });
          </script>
          <button type="button" id="twitterBtn" class="btn-twitter">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 4px;">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            Xに投稿
          </button>
          <button type="button" id="urlBtn">
            URLをコピー
          </button>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="footer-content" style="text-align: center; padding: 1rem; color: #666;">
      <a href="./privacy.html" style="color: #2E8B57; text-decoration: none; margin: 0 1rem;">
        プライバシーポリシー
      </a>
    </div>
  </footer>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>処理中...</p>
  </div>

  <!-- トースト表示 -->
  <div id="toast" class="toast" style="display: none;">
    <div class="toast-content">
      <span id="toastMessage"></span>
    </div>
  </div>
  
  <!-- スマホ用スクロールガイド -->
  <div id="scrollGuide" class="scroll-guide" style="display: none; visibility: hidden; opacity: 0;">
    プレビューを見る
  </div>

  <!-- 必要なJavaScriptファイルの読み込み -->
  <script src="assets/js/app.js"></script>
  <script src="assets/js/security.js"></script>
  <script src="assets/js/comprehensive-security.js"></script>
  <script src="assets/js/security-monitor.js"></script>
  <script src="assets/js/privacy-protection.js"></script>
  <script src="assets/js/embed-mode.js"></script>
</body>
</html> 
