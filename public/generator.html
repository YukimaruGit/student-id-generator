<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <!-- セキュリティヘッダーは _headers で統一管理（Studio埋め込み許可） -->
  
  <title>放課後クロニクル 学生証ジェネレーター</title>
  <meta property="og:title" content="放課後クロニクル 学生証ジェネレーター">
  <meta property="og:description" content="あなただけの学生証を作成しよう！">
  <meta property="og:image" content="https://res.cloudinary.com/di5xqlddy/image/upload/f_auto,q_auto,w_1200,h_630,c_fill,fl_force_strip/v1/student-id-generator/preview.png">
  <meta property="og:url" content="https://student-id-generator.pages.dev/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://res.cloudinary.com/di5xqlddy/image/upload/f_auto,q_auto,w_1200,h_630,c_fill,fl_force_strip/v1/student-id-generator/preview.png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

  <link id="generator-style" rel="stylesheet">
  <script>
    (function(){
      const ORIGIN = window.APP_ORIGIN || (location.hostname === 'localhost' || location.hostname === '127.0.0.1' 
        ? location.origin 
        : 'https://student-id-generator.pages.dev');
      
      // ファイルから直接開く場合は相対パスを使用
      if (location.protocol === 'file:') {
        document.getElementById('generator-style').href = 'assets/css/style.css';
      } else {
        document.getElementById('generator-style').href = ORIGIN + '/assets/css/style.css';
      }
    })();
  </script>
  <!-- <script src="assets/js/domain-masking.js"></script> -->
  <style>
    /* 進捗バーとカード高さ調整（診断結果ページと完全に同じ） */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin-bottom: 2rem;
      overflow: hidden;
      margin-top: 2rem;  /* 診断結果ページと同じ上余白 */
    }

    .progress-fill {
      height: 100%;
      background: #B997D6;
      border-radius: 4px;
      transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1);
      width: 0%;
    }

    /* メインコンテナのレイアウト */
    .generator-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* カードグリッドレイアウト（強制横並び） */
    .cards-grid {
      display: grid !important;
      grid-template-columns: 1fr 1fr !important;
      gap: 2rem !important;
      align-items: stretch !important;
      width: 100% !important;
      max-width: none !important;
      min-height: 500px !important;
      position: relative !important;
      overflow: visible !important;
      float: none !important;
      clear: both !important;
    }
    
    /* カードの強制横並び */
    .cards-grid > * {
      display: block !important;
      float: none !important;
      clear: none !important;
      width: auto !important;
      max-width: none !important;
    }
    
    /* フォームカードとプレビューカードの強制横並び */
    .form-card, .preview-card {
      display: block !important;
      float: none !important;
      clear: none !important;
      width: auto !important;
      max-width: none !important;
      position: relative !important;
    }

    /* フォームカードとプレビューカードの高さ調整 */
    .form-card, .preview-card {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(185, 151, 214, 0.2);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* カードのパディング調整 */
    .form-card {
      padding: 2rem;
    }

    .preview-card {
      padding: 2rem;
    }

    /* カードヘッダーとフッターのマージン調整 */
    .card-header {
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: #666;
      text-align: center;
      flex-shrink: 0;
    }

    .card-footer {
      margin-top: auto;
      padding-top: 1.5rem;
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    /* カードボディの調整 */
    .card-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* フォームカードの内容調整 */
    .form-card h2 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      flex-shrink: 0;
    }

    /* フォームグループのマージン調整 */
    .form-group {
      margin-bottom: 1.5rem;
    }

    /* ボタンコンテナのマージン調整 */
    .card-footer button {
      margin: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      background: #B997D6;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .card-footer button:hover {
      background: #A895D0;
      transform: translateY(-1px);
    }

    /* フォーム要素のスタイル */
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #666;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #B997D6;
    }

    /* 日付入力のレイアウト */
    .date-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* ファイル入力のスタイル */
    .file-input-label {
      display: block;
      padding: 2rem;
      border: 2px dashed #B997D6;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(185, 151, 214, 0.05);
    }

    .file-input-label:hover {
      background: rgba(185, 151, 214, 0.1);
      border-color: #A895D0;
    }

    .file-input-label input[type="file"] {
      display: none;
    }

    /* レスポンシブ対応（モバイルのみ） */
    @media (max-width: 768px) and (orientation: portrait) {
      .cards-grid {
        grid-template-columns: 1fr !important;
        gap: 1.5rem !important;
      }
      
      .generator-container {
        padding: 0 0.5rem !important;
      }
      
      .form-card, .preview-card {
        padding: 1.5rem !important;
        height: auto !important;
        min-height: 350px !important;
      }
      
      .card-footer {
        flex-direction: column !important;
        align-items: center !important;
        margin-top: 1.5rem !important;
      }
      
      .card-footer button {
        width: 100% !important;
        max-width: 300px !important;
      }
    }

    /* デスクトップ表示の強制横並び（重要） */
    @media (min-width: 769px) {
      .cards-grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 2rem !important;
        width: 100% !important;
        max-width: none !important;
        position: relative !important;
        overflow: visible !important;
        float: none !important;
        clear: both !important;
      }
      
      .generator-container {
        max-width: 1200px !important;
        margin: 0 auto !important;
        padding: 0 1rem !important;
      }
      
      .form-card, .preview-card {
        min-height: 500px !important;
        width: auto !important;
        flex: 1 !important;
        float: none !important;
        clear: none !important;
        max-width: none !important;
        position: relative !important;
      }
    }

    /* トースト表示のスタイル */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 10000;
      font-size: 14px;
      transition: opacity 0.3s ease;
    }

    .toast.show {
      opacity: 1;
    }

    .toast.hide {
      opacity: 0;
    }

    /* デバッグ用スタイルは削除済み（レイアウト問題解決完了） */
    
    /* 根本原因修正：style.cssのmain要素グリッド設定を無効化 */
    .generator-container {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
    }
    
    /* style.cssのmain要素グリッド設定を完全に無効化 */
    main.generator-container {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
      max-width: 1200px !important;
      margin: 0 auto !important;
      padding: 0 1rem !important;
    }
    
    /* すべてのmain要素のグリッド設定を無効化（確実性のため） */
    main {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
    }
    
    /* style.cssのmain要素グリッド設定を完全に無効化 */
    main.generator-container {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
      max-width: 1200px !important;
      margin: 0 auto !important;
      padding: 0 1rem !important;
    }
    
    /* より具体的なセレクタで無効化 */
    body > main.generator-container {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
    }
    
    /* すべてのmain要素のグリッド設定を完全に無効化 */
    main, main.generator-container, body > main {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
      grid-template-rows: none !important;
      grid-auto-flow: none !important;
      align-items: stretch !important;
      justify-items: stretch !important;
    }
    
    /* より強力な無効化 */
    *[class*="generator"] {
      display: block !important;
      grid-template-columns: none !important;
      gap: 0 !important;
    }
    
    /* style.cssのすべてのグリッド設定を完全に無効化 */
    main, main.generator-container, body > main,
    main[style*="grid"], main[class*="generator"] {
      display: block !important;
      grid-template-columns: none !important;
      grid-template-rows: none !important;
      gap: 0 !important;
      grid-auto-flow: none !important;
      align-items: stretch !important;
      justify-items: stretch !important;
      grid-template-areas: none !important;
      grid-area: auto !important;
    }
    
    /* メディアクエリ内のグリッド設定も無効化 */
    @media (max-width: 768px) {
      main, main.generator-container, body > main {
        display: block !important;
        grid-template-columns: none !important;
        grid-template-rows: none !important;
        gap: 0 !important;
        grid-auto-flow: none !important;
        align-items: stretch !important;
        justify-items: stretch !important;
      }
    }
    
    /* より具体的なセレクタで無効化 */
    body > main.generator-container,
    html body main.generator-container,
    .generator-container {
      display: block !important;
      grid-template-columns: none !important;
      grid-template-rows: none !important;
      gap: 0 !important;
      grid-auto-flow: none !important;
      align-items: stretch !important;
      justify-items: stretch !important;
      grid-template-areas: none !important;
      grid-area: auto !important;
    }
    
    /* cards-gridのグリッド設定を確実に有効化 */
    .cards-grid {
      display: grid !important;
      grid-template-columns: 1fr 1fr !important;
      grid-template-rows: 1fr !important;
      gap: 2rem !important;
      width: 100% !important;
      max-width: none !important;
      min-height: 600px !important;
      height: 600px !important;
      align-items: stretch !important;
      justify-items: stretch !important;
      position: relative !important;
      overflow: visible !important;
      float: none !important;
      clear: both !important;
      box-sizing: border-box !important;
      margin: 0 !important;
      padding: 0 !important;
      grid-auto-flow: row !important;
      grid-auto-rows: 1fr !important;
    }
    
    /* フォームカードとプレビューカードの高さ統一（最強化版） */
    .form-card, .preview-card {
      height: 600px !important;
      min-height: 600px !important;
      max-height: 600px !important;
      display: flex !important;
      flex-direction: column !important;
      justify-content: flex-start !important;
      align-items: stretch !important;
      box-sizing: border-box !important;
      overflow: hidden !important;
      position: relative !important;
      top: 0 !important;
      margin-top: 0 !important;
      padding-top: 2rem !important;
    }
    
    /* カード内の要素を強制的に配置 */
    .form-card > *, .preview-card > * {
      box-sizing: border-box !important;
      margin: 0 !important;
    }
    
    /* カードヘッダーの調整（高さ統一） */
    .form-card h2, .preview-card .card-header {
      margin-top: 0 !important;
      margin-bottom: 1.5rem !important;
      flex-shrink: 0 !important;
      height: auto !important;
      line-height: 1.2 !important;
      padding: 0 !important;
    }
    
    /* カードボディの調整（高さ統一） */
    .form-card #studentForm, .preview-card .card-body {
      flex: 1 !important;
      display: flex !important;
      flex-direction: column !important;
      justify-content: flex-start !important;
      align-items: stretch !important;
      min-height: 0 !important;
      height: auto !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    /* カードフッターの調整（高さ統一） */
    .form-card #diagnosisButtons, .preview-card .card-footer {
      margin-top: auto !important;
      padding-top: 1.5rem !important;
      flex-shrink: 0 !important;
      height: auto !important;
      position: relative !important;
      bottom: 0 !important;
    }
    
    /* プレビューカードの内容を中央に配置 */
    .preview-card .card-body {
      align-items: center !important;
      justify-content: center !important;
      flex: 1 !important;
    }
    
    /* プレビュー画像のサイズ調整 */
    #cardCanvas {
      max-width: 100% !important;
      height: auto !important;
      border-radius: 8px !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }
    
    /* 説明文の配置調整 */
    .preview-card small {
      margin-top: 1rem !important;
      text-align: center !important;
      line-height: 1.4 !important;
      flex-shrink: 0 !important;
    }
    
    /* カード内の要素を強制的に配置 */
    .form-card > *, .preview-card > * {
      box-sizing: border-box !important;
    }
    
    /* カードヘッダーの調整 */
    .form-card h2, .preview-card .card-header {
      margin-top: 0 !important;
      margin-bottom: 1.5rem !important;
      flex-shrink: 0 !important;
    }
    
    /* カードボディの調整 */
    .form-card #studentForm, .preview-card .card-body {
      flex: 1 !important;
      display: flex !important;
      flex-direction: column !important;
      justify-content: flex-start !important;
    }
    
    /* カードフッターの調整 */
    .form-card #diagnosisButtons, .preview-card .card-footer {
      margin-top: auto !important;
      padding-top: 1.5rem !important;
      flex-shrink: 0 !important;
    }
    
    /* プレビューカードの内容を中央に配置 */
    .preview-card .card-body {
      align-items: center !important;
      justify-content: center !important;
    }
    
    /* プレビュー画像のサイズ調整 */
    #cardCanvas {
      max-width: 100% !important;
      height: auto !important;
      border-radius: 8px !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }
    
    /* 説明文の配置調整 */
    .preview-card small {
      margin-top: 1rem !important;
      text-align: center !important;
      line-height: 1.4 !important;
    }
  </style>
  <script>
    // このページでは高度対策をOFF（画像保存・Canvas操作のため）
    window.AdvancedSecurityConfig = { preventSideChannelAttacks: false };
  </script>
  <!-- ブートローダー（フォールバック付き・自前ドメイン固定） -->
  <script>
    (function () {
      // ローカル環境と本番環境を自動判定
      const MY_ORIGIN = location.hostname === 'localhost' || location.hostname === '127.0.0.1' 
        ? location.origin 
        : 'https://student-id-generator.pages.dev';

      // 埋め込み先(preview.studio.site等)では常に自分のドメインから読み込む
      window.APP_ORIGIN = MY_ORIGIN;
      
      // app.js読み込みフラグ（重複防止用）
      if (typeof window.APP_JS_LOADED === 'undefined') {
        window.APP_JS_LOADED = false;
      }

      function loadWithFallback(primary, fallback) {
        const s = document.createElement('script');
        s.defer = true;
        s.src = APP_ORIGIN + '/' + primary;
        s.setAttribute('data-loaded', 'true');
        s.onload = () => {
          console.log('✅ loadWithFallback完了:', primary);
          // 初期化を確実に実行
          setTimeout(() => {
            if (typeof window.initGeneratorPage === 'function') {
              console.log('🔄 loadWithFallbackからinitGeneratorPageを実行中...');
              window.initGeneratorPage();
            } else {
              console.log('❌ loadWithFallbackからinitGeneratorPageが見つかりません');
            }
          }, 100);
        };
        s.onerror = () => {
          if (!fallback) return;
          console.log('フォールバック: ' + primary + ' → ' + fallback);
          const s2 = document.createElement('script');
          s2.defer = true;
          s2.src = fallback;
          s2.setAttribute('data-loaded', 'true');
          s2.onload = () => {
            console.log('✅ フォールバック完了:', fallback);
            // フォールバックでも初期化を実行
            setTimeout(() => {
              if (typeof window.initGeneratorPage === 'function') {
                console.log('🔄 フォールバックからinitGeneratorPageを実行中...');
                window.initGeneratorPage();
              } else {
                console.log('❌ フォールバックからinitGeneratorPageが見つかりません');
              }
            }, 100);
          };
          document.head.appendChild(s2);
        };
        document.head.appendChild(s);
      }

      function load(p) {
        const s = document.createElement('script');
        s.src = APP_ORIGIN + '/' + p;
        s.defer = true;
        document.head.appendChild(s);
      }

      // セキュリティ系（現状のままでOK）
      load('assets/js/comprehensive-security.js');
      load('assets/js/security.js');
      load('assets/js/privacy-protection.js');
      load('assets/js/security-monitor.js');

      // app.jsは最後に読み込み（依存関係のため）
      setTimeout(() => {
        // 既に読み込まれているかチェック
        if (typeof window.drawStudentCard === 'undefined' && !window.APP_JS_LOADED) {
          console.log('🔄 app.jsを読み込み中...');
          window.APP_JS_LOADED = true;
          loadWithFallback('assets/js/app.js?v=20250902', 'assets/js/app.js?v=20250902');
        } else {
          console.log('✅ app.jsは既に読み込まれています');
        }
      }, 100);
      
      // ページ遷移時の重複読み込み防止
      if (window.APP_JS_LOADED) {
        console.log('✅ ページ遷移時の重複読み込み防止');
      }
      
      // デバッグ用ログ
      console.log('✅ スクリプトローダー初期化完了');
      console.log('APP_ORIGIN:', APP_ORIGIN);
      console.log('現在のURL:', window.location.href);
      console.log('相対パステスト:', new URL('assets/js/app.js', window.location.href).href);
    })();
  </script>
  
  <!-- 共有URL生成機能 -->
  <script>
    // 共有用ドメイン（ローカル環境では現在のオリジンを使用）
    const SHARE_BASE = location.hostname === 'localhost' || location.hostname === '127.0.0.1' 
      ? location.origin 
      : 'https://student-id-generator.pages.dev';
    
    // Cloudinary設定（app.jsと同期、二重定義防止）
    window.cloudinaryConfig ??= { 
      cloudName: 'di5xqlddy', 
      uploadPreset: 'student_card_AS_chronicle' 
    };

    // Base64URL関数は削除済み（短い固定形式に統一）

    <!-- 共有URL生成は app.js の実装を利用（再定義しない） -->
    
    // 共有リンク更新関数（app.jsから呼び出される）…UIは保持のみ、ハンドラはapp.jsが参照
    function updateShareLinksWithImage(imageData, text) {
      const shareUrl = buildShareUrlWithImage({
        public_id: imageData.public_id,
        version: imageData.version
      });
      console.log('共有URL更新:', shareUrl);
      // 共有URLを保存
      window.__shareUrl = shareUrl;
      
      // URLコピー
      const urlBtn = document.getElementById('urlBtn');
      if (urlBtn) urlBtn.onclick = () => copyTextReliable(window.__shareUrl);
      
      // 画像生成後は共有素材を最新に更新（常時バインド済みハンドラがこれを参照する）
      window.__lastImageData = imageData;
      window.__ogpImageUrl = `${location.origin}/ogp/v${imageData.version}/${imageData.public_id.split('/').map(encodeURIComponent).join('/')}.jpg`;
      
      // 表示用フィールドがあれば更新
      const field = document.getElementById('shareLinkField');
      if (field) field.value = shareUrl;
    }
    window.updateShareLinksWithImage = updateShareLinksWithImage;
    

    
    // ✅ ページ読込時に"常時"バインド（画像生成の有無に関わらず動く）
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('twitterBtn');
      if (!btn) return;
      btn.addEventListener('click', async (e) => {
        e.preventDefault(); e.stopPropagation();
        try {
          const last = window.loadResult?.();
          if (!last || !last.public_id || !last.version) {
            alert('先に学生証を作成してください'); return;
          }
          // 共有URLは app.js の実装を使う
          const shareUrl = window.buildShareUrlWithImage?.({
            public_id: last.public_id,
            version  : last.version,
            eager_url: last.eager_url || last.secure_url
          });
          const text = [
            'ようこそ、夢見が丘女子高等学校へ！',
            '　忘れられない放課後を、あなたに。',
            '✎︎＿＿＿＿＿＿＿＿＿＿＿＿＿＿',
            '',
            '▼ #放課後クロニクル　のHPで自分だけの学生証を作ろう！'
          ].join('\n');
          // iOSはアプリのみ・他はIntent新規タブ
          await window.shareToXAppFirstOnly?.(last.eager_url || last.secure_url, `${text}\n${shareUrl}`);
        } catch (e){}
      }, { passive: false });
    });

    // フォーム初期化処理は app.js の initGeneratorPage に統合
    

  </script>
  
  <!-- 直アクセス防止：診断未実施なら診断ゲームへ誘導 -->
  <script>
    (() => {
      // ① 既に一度リダイレクトしたら二度目はしない（ループ防止）
      if (sessionStorage.getItem('redir_guard') === '1') return;

      const sp = new URLSearchParams(location.search);
      const hasParams = ['department','course','club'].some(k => sp.has(k));

      const hasCtx =
        sessionStorage.getItem('diagCtx') ||
        sessionStorage.getItem('as_chronicle_diagnosis') ||
        sessionStorage.getItem('as_chronicle_last_result');

      // ② 埋め込み判定を強化（sandbox / クロスオリジンでも確実に true になる条件を追加）
      function isEmbedded() {
        try { if (sp.get('embed') === '1') return true; } catch(_) {}
        try { if (window.parent && window.parent !== window) return true; } catch(_) { return true; } // 例外＝埋め込み扱い
        try {
          // リファラが他オリジン（preview.studio.site 等）なら埋め込み
          if (document.referrer && !document.referrer.startsWith(location.origin)) return true;
          // ancestorOrigins が使える環境なら祖先が存在すれば埋め込み
          if (location.ancestorOrigins && location.ancestorOrigins.length > 0) return true;
        } catch(_) {}
        return false;
      }
      const inEmbed = isEmbedded();

      // ③ 本当に"直リンク"だけ跳ねる
      if (!hasParams && !hasCtx && !inEmbed) {
        sessionStorage.setItem('redir_guard','1');
        location.replace('./index.html');
      }
      
      // デバッグ用ログ（埋め込み判定の確認）
      console.log('🔍 直アクセス防止チェック:', {
        hasParams, hasCtx, inEmbed,
        referrer: document.referrer,
        ancestorOrigins: location.ancestorOrigins,
        windowParent: window.parent !== window
      });
      
      // Studio埋め込み診断スクリプト（コンソールにコピペ用）
      console.log('🔧 埋め込み診断スクリプト（以下をコピペして実行）:');
      console.log(`
(async()=>{
  const ORG='https://student-id-generator.pages.dev';
  const show=(lab,r)=>console.log(lab,'=>',r.status, r.headers.get('content-type')||'', r.headers.get('location')||'');
  // 1) /generator.html の応答（リダイレクトなし、200で返る）
  let r = await fetch(ORG+'/generator.html',{redirect:'manual'});
  show('/generator.html', r);
  r.headers.forEach((v,k)=>/frame-ancestors|x-frame-options|location/i.test(k)&&console.log(k+':',v));
  // 2) JS/MIME
  await fetch(ORG+'/assets/js/app.js?v=20250901',{cache:'no-store'}).then(r=>show('app.js', r));
  // 3) 台紙PNG（初期描画のトリガー）
  await fetch(ORG+'/assets/img/student_template.png',{cache:'no-store'}).then(r=>show('template.png', r));
})();
      `);
    })();
  </script>
</head>
<body>
  <header>
    <!-- ヘッダータイトル削除 -->
  </header>

  <main class="generator-container">
    <!-- 進捗バー -->
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <div class="cards-grid">
      <section class="form-card">
        <h2>学生証を作成</h2>
        <div id="studentForm">
          <div class="form-group">
          <label class="file-input-label" for="photoInput">
            画像を選択
            <input type="file" id="photoInput" accept="image/*">
          </label>
        </div>

        <div class="form-group">
          <label>
            氏名（漢字）
            <input type="text" id="nameJa" placeholder="例：高森のばら" autocomplete="off" autocapitalize="off" spellcheck="false">
          </label>
        </div>

        <div class="form-group">
          <label>
            氏名（ローマ字）
            <input type="text" id="nameEn" placeholder="例：Takamori Nobara" autocapitalize="words" inputmode="latin" spellcheck="false" autocomplete="off">
          </label>
        </div>

        <div class="form-group">
          <label>
            生年月日
          </label>
          <div class="date-inputs">
            <div class="number-input">
              <select id="dobMonth" autocomplete="one-time-code">
                <option value="">月</option>
                <option value="1">1月</option>
                <option value="2">2月</option>
                <option value="3">3月</option>
                <option value="4">4月</option>
                <option value="5">5月</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
                <option value="9">9月</option>
                <option value="10">10月</option>
                <option value="11">11月</option>
                <option value="12">12月</option>
              </select>
            </div>
            <div class="number-input">
              <select id="dobDay" autocomplete="one-time-code">
                <option value="">日</option>
                <option value="1">1日</option>
                <option value="2">2日</option>
                <option value="3">3日</option>
                <option value="4">4日</option>
                <option value="5">5日</option>
                <option value="6">6日</option>
                <option value="7">7日</option>
                <option value="8">8日</option>
                <option value="9">9日</option>
                <option value="10">10日</option>
                <option value="11">11日</option>
                <option value="12">12日</option>
                <option value="13">13日</option>
                <option value="14">14日</option>
                <option value="15">15日</option>
                <option value="16">16日</option>
                <option value="17">17日</option>
                <option value="18">18日</option>
                <option value="19">19日</option>
                <option value="20">20日</option>
                <option value="21">21日</option>
                <option value="22">22日</option>
                <option value="23">23日</option>
                <option value="24">24日</option>
                <option value="25">25日</option>
                <option value="26">26日</option>
                <option value="27">27日</option>
                <option value="28">28日</option>
                <option value="29">29日</option>
                <option value="30">30日</option>
                <option value="31">31日</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 診断ゲーム連携ボタン（診断結果設定時のみ表示） -->
        <div id="diagnosisButtons" style="display: none; margin-top: 1rem; gap: 0.5rem; flex-wrap: wrap;">
          <button type="button" id="backToDiagnosisBtn" style="background: linear-gradient(135deg, #98d7a5, #98c8a8); color: white; flex: 1; min-width: 120px;">
            診断に戻る
          </button>
          <button type="button" id="viewDiagnosisResultBtn" style="background: linear-gradient(135deg, #87ceeb, #98c8e8); color: white; flex: 1; min-width: 120px;">
            診断結果を見る
          </button>
        </div>
      </section>

      <section class="preview-card">
        <div class="card-header">
          プレビュー
        </div>
        <div class="card-body">
          <canvas id="cardCanvas" width="800" height="500"></canvas>
          <img id="cardPreview" alt="学生証プレビュー" style="display: none;">
        </div>
        <small style="display:block; margin:.5rem 0 0; font-size:12px; color:#888; text-align:center;">
          ※PCはプレビュー画像の上で右クリック →「名前を付けて画像を保存」<br>
          ※共有URLは必ず「URLをコピー」ボタンから取得してください
        </small>
        <div class="card-footer">
          <button type="button" id="downloadBtn">
            画像を保存
          </button>
          <script>
            document.getElementById('downloadBtn')?.addEventListener('click', (e) => {
              e.preventDefault(); e.stopPropagation();
              try {
                // 直前生成フラグ（ガードを通す）
                sessionStorage.setItem('as_chronicle_last_result','1');
                const cvs = document.getElementById('cardCanvas');
                if (cvs) window.downloadCanvasAsImage?.(cvs, '放課後クロニクル_学生証.png');
              } catch(e){}
            }, { passive:false });
          </script>
          <button type="button" id="twitterBtn" class="btn-twitter">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 4px;">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            Xに投稿
          </button>
          <button type="button" id="urlBtn">
            URLをコピー
          </button>
        </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
          <div class="footer-content" style="text-align: center; padding: 1rem; color: #666;">
        <a href="./privacy.html" style="color: #2E8B57; text-decoration: none; margin: 0 1rem;">
          プライバシーポリシー
        </a>
      </div>
  </footer>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>処理中...</p>
  </div>

  <!-- トースト表示 -->
  <div id="toast" class="toast" style="display: none;">
    <div class="toast-content">
      <span id="toastMessage"></span>
    </div>
  </div>

  <!-- レイアウト強制修正 -->
  <script>
    // レイアウトを強制的に横並びに修正
    function forceHorizontalLayout() {
      const cardsGrid = document.querySelector('.cards-grid');
      if (cardsGrid) {
        // インラインスタイルで強制適用
        cardsGrid.style.cssText = `
          display: grid !important;
          grid-template-columns: 1fr 1fr !important;
          grid-template-rows: 1fr !important;
          gap: 2rem !important;
          width: 100% !important;
          max-width: none !important;
          min-height: 600px !important;
          height: 600px !important;
          align-items: stretch !important;
          justify-items: stretch !important;
          position: relative !important;
          overflow: visible !important;
          float: none !important;
          clear: both !important;
          box-sizing: border-box !important;
          margin: 0 !important;
          padding: 0 !important;
          grid-auto-flow: row !important;
          grid-auto-rows: 1fr !important;
        `;
        
        // さらに強制的にスタイルを適用
        cardsGrid.setAttribute('style', cardsGrid.style.cssText);
        
        // 直接スタイルプロパティを設定（より強力に）
        cardsGrid.style.setProperty('display', 'grid', 'important');
        cardsGrid.style.setProperty('grid-template-columns', '1fr 1fr', 'important');
        cardsGrid.style.setProperty('grid-template-rows', '1fr', 'important');
        cardsGrid.style.setProperty('gap', '2rem', 'important');
        cardsGrid.style.setProperty('width', '100%', 'important');
        cardsGrid.style.setProperty('max-width', 'none', 'important');
        cardsGrid.style.setProperty('min-height', '600px', 'important');
        cardsGrid.style.setProperty('height', '600px', 'important');
        cardsGrid.style.setProperty('align-items', 'stretch', 'important');
        cardsGrid.style.setProperty('justify-items', 'stretch', 'important');
        cardsGrid.style.setProperty('position', 'relative', 'important');
        cardsGrid.style.setProperty('overflow', 'visible', 'important');
        cardsGrid.style.setProperty('float', 'none', 'important');
        cardsGrid.style.setProperty('clear', 'none', 'important');
        cardsGrid.style.setProperty('box-sizing', 'border-box', 'important');
        cardsGrid.style.setProperty('margin', '0', 'important');
        cardsGrid.style.setProperty('padding', '0', 'important');
        cardsGrid.style.setProperty('grid-auto-flow', 'row', 'important');
        cardsGrid.style.setProperty('grid-auto-rows', '1fr', 'important');
        
        // 通常のスタイルプロパティも設定（バックアップ）
        cardsGrid.style.display = 'grid';
        cardsGrid.style.gridTemplateColumns = '1fr 1fr';
        cardsGrid.style.gridTemplateRows = '1fr';
        cardsGrid.style.gap = '2rem';
        cardsGrid.style.width = '100%';
        cardsGrid.style.maxWidth = 'none';
        cardsGrid.style.minHeight = '600px';
        cardsGrid.style.height = '600px';
        cardsGrid.style.alignItems = 'stretch';
        cardsGrid.style.justifyItems = 'stretch';
        cardsGrid.style.position = 'relative';
        cardsGrid.style.overflow = 'visible';
        cardsGrid.style.float = 'none';
        cardsGrid.style.clear = 'none';
        cardsGrid.style.boxSizing = 'border-box';
        cardsGrid.style.margin = '0';
        cardsGrid.style.padding = '0';
        cardsGrid.style.gridAutoFlow = 'row';
        cardsGrid.style.gridAutoRows = '1fr';
        
        console.log('✅ レイアウトを強制的に横並びに修正しました（最強化版）');
        
        // さらに強制的にスタイルを適用（確実性のため）
        setTimeout(() => {
          cardsGrid.style.setProperty('display', 'grid', 'important');
          cardsGrid.style.setProperty('grid-template-columns', '1fr 1fr', 'important');
          cardsGrid.style.setProperty('grid-template-rows', '1fr', 'important');
          cardsGrid.style.setProperty('gap', '2rem', 'important');
          cardsGrid.style.setProperty('height', '600px', 'important');
          console.log('✅ 遅延強制適用完了');
        }, 10);
        
        // さらに遅延して強制適用（確実性のため）
        setTimeout(() => {
          if (formCard) {
            formCard.style.setProperty('height', '600px', 'important');
            formCard.style.setProperty('min-height', '600px', 'important');
            formCard.style.setProperty('max-height', '600px', 'important');
            formCard.style.setProperty('top', '0', 'important');
            formCard.style.setProperty('margin-top', '0', 'important');
          }
          if (previewCard) {
            previewCard.style.setProperty('height', '600px', 'important');
            previewCard.style.setProperty('min-height', '600px', 'important');
            previewCard.style.setProperty('max-height', '600px', 'important');
            previewCard.style.setProperty('top', '0', 'important');
            previewCard.style.setProperty('margin-top', '0', 'important');
          }
          console.log('✅ 最終遅延強制適用完了');
        }, 100);
        
        // 子要素も強制修正
        const formCard = cardsGrid.querySelector('.form-card');
        const previewCard = cardsGrid.querySelector('.preview-card');
        
        if (formCard) {
          formCard.style.setProperty('display', 'flex', 'important');
          formCard.style.setProperty('flex-direction', 'column', 'important');
          formCard.style.setProperty('justify-content', 'flex-start', 'important');
          formCard.style.setProperty('align-items', 'stretch', 'important');
          formCard.style.setProperty('height', '600px', 'important');
          formCard.style.setProperty('min-height', '600px', 'important');
          formCard.style.setProperty('max-height', '600px', 'important');
          formCard.style.setProperty('float', 'none', 'important');
          formCard.style.setProperty('clear', 'none', 'important');
          formCard.style.setProperty('width', 'auto', 'important');
          formCard.style.setProperty('max-width', 'none', 'important');
          formCard.style.setProperty('position', 'relative', 'important');
          formCard.style.setProperty('box-sizing', 'border-box', 'important');
          formCard.style.setProperty('overflow', 'hidden', 'important');
          formCard.style.setProperty('top', '0', 'important');
          formCard.style.setProperty('margin-top', '0', 'important');
          formCard.style.setProperty('padding-top', '2rem', 'important');
          
          // 通常のスタイルプロパティも設定（バックアップ）
          formCard.style.display = 'flex';
          formCard.style.flexDirection = 'column';
          formCard.style.justifyContent = 'flex-start';
          formCard.style.alignItems = 'stretch';
          formCard.style.height = '600px';
          formCard.style.minHeight = '600px';
          formCard.style.maxHeight = '600px';
          formCard.style.float = 'none';
          formCard.style.clear = 'none';
          formCard.style.width = 'auto';
          formCard.style.maxWidth = 'none';
          formCard.style.position = 'relative';
          formCard.style.boxSizing = 'border-box';
          formCard.style.overflow = 'hidden';
          formCard.style.top = '0';
          formCard.style.marginTop = '0';
          formCard.style.paddingTop = '2rem';
        }
        
        if (previewCard) {
          previewCard.style.setProperty('display', 'flex', 'important');
          previewCard.style.setProperty('flex-direction', 'column', 'important');
          previewCard.style.setProperty('justify-content', 'flex-start', 'important');
          previewCard.style.setProperty('align-items', 'stretch', 'important');
          previewCard.style.setProperty('height', '600px', 'important');
          previewCard.style.setProperty('min-height', '600px', 'important');
          previewCard.style.setProperty('max-height', '600px', 'important');
          previewCard.style.setProperty('float', 'none', 'important');
          previewCard.style.setProperty('clear', 'none', 'important');
          previewCard.style.setProperty('width', 'auto', 'important');
          previewCard.style.setProperty('max-width', 'none', 'important');
          previewCard.style.setProperty('position', 'relative', 'important');
          previewCard.style.setProperty('box-sizing', 'border-box', 'important');
          previewCard.style.setProperty('overflow', 'hidden', 'important');
          previewCard.style.setProperty('top', '0', 'important');
          previewCard.style.setProperty('margin-top', '0', 'important');
          previewCard.style.setProperty('padding-top', '2rem', 'important');
          
          // 通常のスタイルプロパティも設定（バックアップ）
          previewCard.style.display = 'flex';
          previewCard.style.flexDirection = 'column';
          previewCard.style.justifyContent = 'flex-start';
          previewCard.style.alignItems = 'stretch';
          previewCard.style.height = '600px';
          previewCard.style.minHeight = '600px';
          previewCard.style.maxHeight = '600px';
          previewCard.style.float = 'none';
          previewCard.style.clear = 'none';
          previewCard.style.width = 'auto';
          previewCard.style.maxWidth = 'none';
          previewCard.style.position = 'relative';
          previewCard.style.boxSizing = 'border-box';
          previewCard.style.overflow = 'hidden';
          previewCard.style.top = '0';
          previewCard.style.marginTop = '0';
          previewCard.style.paddingTop = '2rem';
        }
        
        console.log('✅ カードの高さを600pxに統一しました');
        
        // カード内の要素の高さも統一
        if (formCard) {
          const formElements = formCard.querySelectorAll('*');
          formElements.forEach(element => {
            if (element.tagName === 'H2') {
              element.style.setProperty('margin-top', '0', 'important');
              element.style.setProperty('margin-bottom', '1.5rem', 'important');
              element.style.setProperty('flex-shrink', '0', 'important');
            } else if (element.id === 'studentForm') {
              element.style.setProperty('flex', '1', 'important');
              element.style.setProperty('display', 'flex', 'important');
              element.style.setProperty('flex-direction', 'column', 'important');
              element.style.setProperty('justify-content', 'flex-start', 'important');
            } else if (element.id === 'diagnosisButtons') {
              element.style.setProperty('margin-top', 'auto', 'important');
              element.style.setProperty('padding-top', '1.5rem', 'important');
              element.style.setProperty('flex-shrink', '0', 'important');
            }
          });
        }
        
        if (previewCard) {
          const previewElements = previewCard.querySelectorAll('*');
          previewElements.forEach(element => {
            if (element.className === 'card-header') {
              element.style.setProperty('margin-top', '0', 'important');
              element.style.setProperty('margin-bottom', '1.5rem', 'important');
              element.style.setProperty('flex-shrink', '0', 'important');
            } else if (element.className === 'card-body') {
              element.style.setProperty('flex', '1', 'important');
              element.style.setProperty('display', 'flex', 'important');
              element.style.setProperty('flex-direction', 'column', 'important');
              element.style.setProperty('justify-content', 'center', 'important');
              element.style.setProperty('align-items', 'center', 'important');
            } else if (element.className === 'card-footer') {
              element.style.setProperty('margin-top', 'auto', 'important');
              element.style.setProperty('padding-top', '1.5rem', 'important');
              element.style.setProperty('flex-shrink', '0', 'important');
            }
          });
        }
      }
    }
    
    // ページ読み込み完了後に実行
    document.addEventListener('DOMContentLoaded', forceHorizontalLayout);
    
    // 少し遅延してからも実行（確実性のため）
    setTimeout(forceHorizontalLayout, 50);
    setTimeout(forceHorizontalLayout, 100);
    setTimeout(forceHorizontalLayout, 200);
    setTimeout(forceHorizontalLayout, 500);
    setTimeout(forceHorizontalLayout, 1000);
    
    // ウィンドウ読み込み完了後にも実行
    window.addEventListener('load', forceHorizontalLayout);
    
    // レイアウトチェックは削除済み（正常動作確認完了）
    
    // 進捗バーの更新
    function updateProgress() {
      const progressFill = document.getElementById('progressFill');
      if (!progressFill) return;
      
      let completedFields = 0;
      const totalFields = 6; // 画像、氏名（漢字）、氏名（ローマ字）、生年月日、学科、部活動
      
      // 画像が選択されているかチェック
      const photoInput = document.getElementById('photoInput');
      if (photoInput && photoInput.files && photoInput.files.length > 0) {
        completedFields++;
      }
      
      // 氏名（漢字）が入力されているかチェック
      const nameJa = document.getElementById('nameJa');
      if (nameJa && nameJa.value.trim()) {
        completedFields++;
      }
      
      // 氏名（ローマ字）が入力されているかチェック
      const nameEn = document.getElementById('nameEn');
      if (nameEn && nameEn.value.trim()) {
        completedFields++;
      }
      
      // 生年月日が選択されているかチェック
      const dobMonth = document.getElementById('dobMonth');
      const dobDay = document.getElementById('dobDay');
      if (dobMonth && dobDay && dobMonth.value && dobDay.value) {
        completedFields++;
      }
      
      // 学科が選択されているかチェック
      const department = document.getElementById('department');
      if (department && department.value) {
        completedFields++;
      }
      
      // 部活動が選択されているかチェック
      const club = document.getElementById('club');
      if (club && club.value) {
        completedFields++;
      }
      
      // 進捗率を計算して更新
      const progress = (completedFields / totalFields) * 100;
      progressFill.style.width = `${progress}%`;
    }
    
    // フォーム要素の変更を監視
    function setupProgressTracking() {
      const formElements = [
        'photoInput', 'nameJa', 'nameEn', 'dobMonth', 'dobDay', 'department', 'club'
      ];
      
      formElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          if (element.type === 'file') {
            element.addEventListener('change', updateProgress);
          } else if (element.tagName === 'SELECT') {
            element.addEventListener('change', updateProgress);
          } else {
            element.addEventListener('input', updateProgress);
          }
        }
      });
    }
  </script>

  <!-- 診断ゲーム連携処理 -->
  <script>
    // 放課後クロニクル診断ゲームからの連携処理（セキュリティ強化版）
    document.addEventListener('DOMContentLoaded', function() {
      // 状態復元処理
      function restoreStudentIdState() {
        try {
          const savedResult = window.loadResult ? window.loadResult() : null;
          if (savedResult && savedResult.public_id && savedResult.version) {
            console.log('学生証の状態を復元します:', savedResult);
            
            // 共有URLを復元
            if (window.buildShareUrlWithImage) {
              const shareUrl = window.buildShareUrlWithImage({
                public_id: savedResult.public_id,
                version: savedResult.version
              });
              window.__shareUrl = shareUrl;
              
              // 共有リンクを更新
              if (window.updateShareLinksWithImage) {
                window.updateShareLinksWithImage(savedResult, '学生証が復元されました');
              }
            }
            
            // OGP画像URLを復元
            if (savedResult.eager_url) {
              window.__ogpImageUrl = savedResult.eager_url;
            }
            
            // 画像データを復元
            if (savedResult.imageData) {
              window.__lastImageData = savedResult.imageData;
            }
            
            // フォーム値を復元
            if (savedResult.formData) {
              const { nameJa, nameEn, dobMonth, dobDay } = savedResult.formData;
              if (nameJa && document.getElementById('nameJa')) {
                document.getElementById('nameJa').value = nameJa;
              }
              if (nameEn && document.getElementById('nameEn')) {
                document.getElementById('nameEn').value = nameEn;
              }
              if (dobMonth && document.getElementById('dobMonth')) {
                document.getElementById('dobMonth').value = dobMonth;
              }
              if (dobDay && document.getElementById('dobDay')) {
                document.getElementById('dobDay').value = dobDay;
              }
            }
            
            // プレビューを再描画
            if (typeof window.drawStudentCard === 'function') {
              setTimeout(() => window.drawStudentCard(), 100);
            }
            
            console.log('✅ 学生証の状態が復元されました');
          }
        } catch (error) {
          console.error('状態復元エラー:', error);
        }
      }
      
          // 状態復元を実行
    restoreStudentIdState();
    
    // トースト表示機能
    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      if (toast && toastMessage) {
        toastMessage.textContent = message;
        toast.style.display = 'block';
        toast.classList.add('show');
        
        setTimeout(() => {
          toast.classList.add('hide');
          setTimeout(() => {
            toast.style.display = 'none';
            toast.classList.remove('show', 'hide');
          }, 300);
        }, duration);
      }
    }
    
    window.showToast = showToast;
      // 診断情報をsessionStorageにバックアップ（クエリがある場合のみ）
      if (location.search) {
        sessionStorage.setItem('diagCtx', location.search);
      }
      
      // 安全なURLパラメータ取得
      const department = window.Security ? window.Security.getSafeUrlParam('department') : new URLSearchParams(location.search).get('department');
      const course = window.Security ? window.Security.getSafeUrlParam('course') : new URLSearchParams(location.search).get('course');
      const club = window.Security ? window.Security.getSafeUrlParam('club') : new URLSearchParams(location.search).get('club');
      
      console.log('診断結果連携:', { department, course, club });

      // 学科の自動設定
      if (department && course) {
        const selDept = document.getElementById('department');
        if (selDept) {
          // 既存の選択肢にない場合は動的に追加
          const existingOption = Array.from(selDept.options).find(opt => opt.value === course);
          if (!existingOption && course !== '') {
            const newOption = document.createElement('option');
            newOption.value = course;
            newOption.textContent = course;
            selDept.appendChild(newOption);
          }
          
          selDept.value = course;
          selDept.style.display = 'none';
          
          // ラベルを診断結果表示に変更（XSS対策：textContent使用）
          const deptLabel = selDept.parentElement.querySelector('label');
          if (deptLabel) {
            // 安全な表示用HTMLを構築
            const safeDepartment = document.createElement('div');
            safeDepartment.style.cssText = 'padding: 0.75rem; background: #f8f9fa; border-radius: 8px; color: #666; border: 2px solid #e0e0e0;';
            
            const deptText = document.createTextNode(`${department}（${course}コース） `);
            const resultSpan = document.createElement('span');
            resultSpan.style.cssText = 'font-size: 0.8em; color: #999;';
            resultSpan.textContent = '（診断結果）';
            
            safeDepartment.appendChild(deptText);
            safeDepartment.appendChild(resultSpan);
            
            // 既存の内容をクリアして安全に追加
            deptLabel.textContent = '学科';
            deptLabel.appendChild(safeDepartment);
          }
        }
      }

      // 部活動の自動設定
      if (club) {
        const selClub = document.getElementById('club');
        if (selClub) {
          // 既存の選択肢にない場合は動的に追加
          const existingOption = Array.from(selClub.options).find(opt => opt.value === club);
          if (!existingOption && club !== '') {
            const newOption = document.createElement('option');
            newOption.value = club;
            newOption.textContent = club;
            selClub.appendChild(newOption);
          }
          
          selClub.value = club;
          selClub.style.display = 'none';
          
          // ラベルを診断結果表示に変更（XSS対策：textContent使用）
          const clubLabel = selClub.parentElement.querySelector('label');
          if (clubLabel) {
            // 安全な表示用HTMLを構築
            const safeClub = document.createElement('div');
            safeClub.style.cssText = 'padding: 0.75rem; background: #f8f9fa; border-radius: 8px; color: #666; border: 2px solid #e0e0e0;';
            
            const clubText = document.createTextNode(`${club} `);
            const resultSpan = document.createElement('span');
            resultSpan.style.cssText = 'font-size: 0.8em; color: #999;';
            resultSpan.textContent = '（診断結果）';
            
            safeClub.appendChild(clubText);
            safeClub.appendChild(resultSpan);
            
            // 既存の内容をクリアして安全に追加
            clubLabel.textContent = '部活動';
            clubLabel.appendChild(safeClub);
          }
        }
      }

      // 診断結果が設定された場合、リアルタイムプレビューを更新
      if (department || course || club) {
        // 診断関連ボタンを表示
        const diagnosisButtons = document.getElementById('diagnosisButtons');
        if (diagnosisButtons) {
          diagnosisButtons.style.display = 'flex';
          
          // 診断に戻るボタン
          const backBtn = document.getElementById('backToDiagnosisBtn');
          if (backBtn) {
            backBtn.onclick = () => {
              const url = new URL('index.html', location.href);
              if (location.search.includes('embed=1')) url.searchParams.set('embed','1');
              location.href = url.toString();
            };
          }
          
          // 診断結果を見るボタン
          const viewResultBtn = document.getElementById('viewDiagnosisResultBtn');
          if (viewResultBtn) {
            viewResultBtn.onclick = () => {
              // URLパラメータを保持してindex.htmlの結果ページに移動
              const currentParams = new URLSearchParams(location.search);
              const diagnosisUrl = new URL('index.html', window.location.href);
              diagnosisUrl.searchParams.set('showResult', 'true');
              diagnosisUrl.searchParams.set('department', currentParams.get('department') || '');
              diagnosisUrl.searchParams.set('course', currentParams.get('course') || '');
              diagnosisUrl.searchParams.set('club', currentParams.get('club') || '');
              diagnosisUrl.searchParams.set('previewMessage', currentParams.get('previewMessage') || '');
              diagnosisUrl.searchParams.set('episodeMessage', currentParams.get('episodeMessage') || '');
              
              // 埋め込みモードの場合はembed=1を付与
              if (location.search.includes('embed=1')) diagnosisUrl.searchParams.set('embed','1');
              
              window.location.href = diagnosisUrl.toString();
            };
          }
        }

        // 少し遅延を入れてからプレビュー更新（他の初期化が完了してから）
        setTimeout(() => {
          if (typeof drawStudentCard === 'function') {
            drawStudentCard();
          }
        }, 500);
      }
      
      // 進捗バーの初期化
      setupProgressTracking();
      updateProgress();
      
      // 端末別の保存UI
      const isPc = matchMedia('(pointer:fine)').matches && (navigator.maxTouchPoints || 0) === 0;
      const saveBtn = document.getElementById('downloadBtn');
      if (saveBtn) {
        if (isPc) {
          // PCはボタン不要（右クリック保存）
          saveBtn.remove();
        } else {
          // モバイルはOGP画像を新規タブで開く（長押し保存）
          saveBtn.onclick = () => {
            if (window.__ogpImageUrl) window.open(window.__ogpImageUrl, '_blank', 'noopener');
          };
        }
      }
    });
  </script>
  
  <!-- 埋め込みモード対応 -->
  <script>
    // 埋め込みモード対応も自前ドメインから読み込み
    (function() {
      const s = document.createElement('script');
      s.src = (window.APP_ORIGIN || 'https://student-id-generator.pages.dev') + '/assets/js/embed-mode.js';
      s.defer = true;
      document.head.appendChild(s);
    })();
  </script>
  

  
  <!-- iPhoneでカメラが起動する件を修正 -->
  <script>
    // capture属性は既に削除済み
  </script>
  
  <!-- 共有機能は共有ブリッジ経由で統一管理 -->
  <!-- 共有ボタンは共有ブリッジを新規タブで開き、トップレベルでWeb Share実行 -->
  <!-- これによりiframe内でのWeb Share拒否問題を回避 -->
  
  <!-- app.jsの直接読み込み（最も確実な方法） -->
  <script>
    // 重複読み込み防止
    if (typeof window.APP_JS_LOADED === 'undefined' || !window.APP_JS_LOADED) {
      window.APP_JS_LOADED = true;
      const script = document.createElement('script');
      script.src = 'assets/js/app.js?v=20250902';
      script.onload = () => {
        console.log('✅ app.js直接読み込み完了（重複防止）');
        // 初期化を確実に実行
        setTimeout(() => {
          if (typeof window.initGeneratorPage === 'function') {
            console.log('🔄 initGeneratorPageを実行中...');
            window.initGeneratorPage();
          } else {
            console.log('❌ initGeneratorPageが見つかりません');
          }
        }, 100);
        
        // drawStudentCard関数の定義を待ってから初期化
        const checkDrawFunction = () => {
          // app.jsの読み込み完了もチェック
          if (typeof window.initGeneratorPage === 'function') {
            console.log('✅ initGeneratorPage関数が定義されました');
            
            // drawStudentCard関数が定義されていない場合は、すぐに関数を直接定義
            if (typeof window.drawStudentCard === 'function') {
              console.log('✅ drawStudentCard関数も定義されています');
                              console.log('🔄 関数定義後にinitGeneratorPageを実行中...');
                window.initGeneratorPage();
                
                // フォームの値が変更された時に自動的に学生証を更新
                const formElements = ['nameJa', 'nameEn', 'dobMonth', 'dobDay'];
                formElements.forEach(id => {
                  const element = document.getElementById(id);
                  if (element) {
                    element.addEventListener('input', () => {
                      console.log('🔄 フォーム値変更を検知、学生証を更新中...');
                      setTimeout(() => window.drawStudentCard(), 100);
                    });
                  }
                });
            } else {
              console.log('⏳ drawStudentCard関数が定義されていないため、直接定義します');
                          // 関数を直接定義
            window.drawStudentCard = function() {
              console.log('✅ drawStudentCard関数を直接定義しました');
              
              const canvas = document.getElementById('cardCanvas');
              if (!canvas) {
                console.error('❌ cardCanvas要素が見つかりません');
                return;
              }
              
              const ctx = canvas.getContext('2d');
              if (!ctx) {
                console.error('❌ Canvas 2Dコンテキストが取得できません');
                return;
              }
              
              // 学生証テンプレート画像を読み込んで描画
              const templateImage = new Image();
              templateImage.onload = function() {
                console.log('✅ 学生証テンプレート画像の読み込み完了');
                
                // Canvasをクリア
                ctx.clearRect(0, 0, 800, 500);
                
                // テンプレート画像を描画
                ctx.drawImage(templateImage, 0, 0, 800, 500);
                
                // アップロードされた画像を描画（完璧な位置に調整済み【絶対変更禁止】）
                const photoInput = document.getElementById('photoInput');
                if (photoInput && photoInput.files && photoInput.files.length > 0) {
                  const file = photoInput.files[0];
                  const img = new Image();
                  img.onload = function() {
                    // 写真フレームの座標（完璧に調整済み【変更厳禁】）
                    const PHOTO_FRAME = {
                      x: 42,   // 完璧に調整済み【変更厳禁】
                      y: 125,   // 完璧に調整済み【変更厳禁】
                      width: 255,  // 完璧に調整済み【変更厳禁】
                      height: 324  // 完璧に調整済み【変更厳禁】
                    };
                    
                    // 画像処理ロジック（完璧に調整済み【変更厳禁】）
                    ctx.save();
                    ctx.beginPath();
                    ctx.rect(PHOTO_FRAME.x, PHOTO_FRAME.y, PHOTO_FRAME.width, PHOTO_FRAME.height);
                    ctx.clip();
                    
                    const frameAspect = PHOTO_FRAME.width / PHOTO_FRAME.height;
                    const imgAspect = img.width / img.height;
                    
                    let drawWidth, drawHeight, drawX, drawY;

                    if (imgAspect > frameAspect) {
                      drawHeight = PHOTO_FRAME.height;
                      drawWidth = PHOTO_FRAME.height * imgAspect;
                      drawX = PHOTO_FRAME.x - (drawWidth - PHOTO_FRAME.width) / 2;
                      drawY = PHOTO_FRAME.y;
                    } else {
                      drawWidth = PHOTO_FRAME.width;
                      drawHeight = PHOTO_FRAME.width / imgAspect;
                      drawX = PHOTO_FRAME.x;
                      drawY = PHOTO_FRAME.y - (drawHeight - PHOTO_FRAME.height) / 2;
                    }
                    
                    ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                    ctx.restore();
                    
                    console.log('✅ アップロード画像を描画完了');
                    
                    // 画像描画後に文字を刻印
                    drawTextElements();
                  };
                  img.src = URL.createObjectURL(file);
                } else {
                  // 画像がない場合は直接文字を刻印
                  drawTextElements();
                }
                
                // 文字要素を描画する関数
                function drawTextElements() {
                  // フォームの値を取得
                  const nameJa = document.getElementById('nameJa')?.value || '';
                  const nameEn = document.getElementById('nameEn')?.value || '';
                  const dobMonth = document.getElementById('dobMonth')?.value || '';
                  const dobDay = document.getElementById('dobDay')?.value || '';
                
                // 診断結果の情報を取得
                const params = new URLSearchParams(location.search);
                const departmentLabel = params.get('course') || '';
                const clubLabel = params.get('club') || '';
                
                // フォントの準備
                ctx.font = '34px "Noto Serif JP", serif';
                ctx.fillStyle = '#000';
                ctx.textAlign = 'left';
                
                // 氏名（漢字）を刻印（完璧な位置に調整済み）
                if (nameJa) {
                  const nameX = Math.round(1400 / 2291 * 800);
                  const nameY = Math.round(540 / 1440 * 500);
                  ctx.fillText(nameJa, nameX, nameY);
                  console.log('✅ 氏名（漢字）を刻印:', nameJa, '位置:', nameX, nameY);
                }
                
                // 氏名（ローマ字）を刻印（完璧な位置に調整済み）
                if (nameEn) {
                  ctx.font = '16px "Noto Sans JP", sans-serif';
                  ctx.fillStyle = '#666';
                  const nameEnX = Math.round(1400 / 2291 * 800);
                  const nameEnY = Math.round(620 / 1440 * 500);
                  ctx.fillText(nameEn, nameEnX, nameEnY);
                  console.log('✅ 氏名（ローマ字）を刻印:', nameEn, '位置:', nameEnX, nameEnY);
                }
                
                // 生年月日を刻印（完璧な位置に調整済み【絶対変更禁止】）
                if (dobMonth && dobDay) {
                  ctx.font = '22px "Noto Sans JP", sans-serif';
                  ctx.fillStyle = '#000';
                  ctx.textAlign = 'center';
                  const monthX = Math.round(1570 / 2291 * 800);
                  const monthY = Math.round(1050 / 1440 * 500);
                  const dayX = Math.round(1720 / 2291 * 800);
                  const dayY = Math.round(1050 / 1440 * 500);
                  ctx.fillText(dobMonth, monthX, monthY);
                  ctx.fillText(dobDay, dayX, dayY);
                  console.log('✅ 生年月日を刻印:', `${dobMonth}月${dobDay}日`, '位置:', monthX, monthY, dayX, dayY);
                }
                
                // 学科・コース・部活動を刻印（完璧な位置に調整済み【絶対変更禁止】）
                if (departmentLabel || clubLabel) {
                  // 学科とコースを分けて生成
                  let actualDepartment = '';
                  let actualCourse = '';
                  
                  if (departmentLabel) {
                    switch(departmentLabel) {
                      case '特進':
                      case '特進コース':
                        actualDepartment = '普通科';
                        actualCourse = '特進コース';
                        break;
                      case '英語':
                      case '英語コース':
                        actualDepartment = '普通科';
                        actualCourse = '英語コース';
                        break;
                      case '音楽':
                      case '音楽コース':
                        actualDepartment = '芸術科';
                        actualCourse = '音楽コース';
                        break;
                      case '美術':
                      case '美術コース':
                        actualDepartment = '芸術科';
                        actualCourse = '美術コース';
                        break;
                      default:
                        if (departmentLabel.endsWith('コース')) {
                          const baseName = departmentLabel.replace('コース', '');
                          if (baseName === '特進' || baseName === '英語') {
                            actualDepartment = '普通科';
                          } else if (baseName === '音楽' || baseName === '美術') {
                            actualDepartment = '芸術科';
                          } else {
                            actualDepartment = '普通科';
                          }
                          actualCourse = departmentLabel;
                        } else {
                          actualDepartment = departmentLabel;
                          actualCourse = departmentLabel + 'コース';
                        }
                    }
                  }
                  
                  // 学科 - 完璧な位置に調整済み【絶対変更禁止】
                  ctx.font = '22px "Noto Sans JP", sans-serif';
                  ctx.fillStyle = '#000';
                  ctx.textAlign = 'center';
                  const deptX = Math.round(1520 / 2291 * 800);
                  const deptY = Math.round(800 / 1440 * 500);
                  if (actualDepartment) {
                    const cleanDepartment = actualDepartment.replace(/科$/, '');
                    ctx.fillText(cleanDepartment, deptX, deptY);
                    console.log('✅ 学科を刻印:', cleanDepartment, '位置:', deptX, deptY);
                  }
                  
                  // コース - 完璧な位置に調整済み【絶対変更禁止】
                  ctx.font = '22px "Noto Sans JP", sans-serif';
                  ctx.fillStyle = '#000';
                  ctx.textAlign = 'center';
                  const courseX = Math.round(2000 / 2291 * 800);
                  const courseY = Math.round(800 / 1440 * 500);
                  if (actualCourse) {
                    ctx.fillText(actualCourse, courseX, courseY);
                    console.log('✅ コースを刻印:', actualCourse, '位置:', courseX, courseY);
                  }
                  
                  // 部活 - 完璧な位置に調整済み【絶対変更禁止】
                  ctx.font = '22px "Noto Sans JP", sans-serif';
                  ctx.fillStyle = '#000';
                  ctx.textAlign = 'center';
                  const clubX = Math.round(1620 / 2291 * 800);
                  const clubY = Math.round(920 / 1440 * 500);
                  if (clubLabel) {
                    let displayClubName;
                    if (clubLabel === '帰宅') {
                      displayClubName = 'ー'; // 帰宅部の場合は横棒を表示
                    } else {
                      displayClubName = clubLabel.replace(/部$/, '');
                    }
                    ctx.fillText(displayClubName, clubX, clubY);
                    console.log('✅ 部活動を刻印:', displayClubName, '位置:', clubX, clubY);
                  }
                }
                
                console.log('✅ 学生証の描画が完了しました');
              }
              
              console.log('✅ 学生証の描画が完了しました');
            };
              
              templateImage.onerror = function() {
                console.error('❌ 学生証テンプレート画像の読み込みに失敗しました');
                // フォールバック：基本的な描画
                ctx.clearRect(0, 0, 800, 500);
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, 800, 500);
                ctx.fillStyle = '#333';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('学生証テンプレート読み込みエラー', 400, 250);
              };
              
              // 画像の読み込み開始
              console.log('🔄 学生証テンプレート画像を読み込み中...');
              templateImage.src = 'assets/img/student_template.png';
            };
              console.log('🔄 関数定義後にinitGeneratorPageを実行中...');
              window.initGeneratorPage();
            }
          } else {
            console.log('⏳ initGeneratorPage関数の定義を待機中...');
            // 100ms間隔でチェック、最大5秒でタイムアウト
            if (window.drawFunctionTimeout) {
              clearTimeout(window.drawFunctionTimeout);
            }
            if (window.drawFunctionTimeoutCount === undefined) {
              window.drawFunctionTimeoutCount = 0;
            }
            window.drawFunctionTimeoutCount++;
            
            if (window.drawFunctionTimeoutCount > 50) { // 5秒でタイムアウト
              console.error('❌ initGeneratorPage関数の定義がタイムアウトしました');
              return;
            }
            
            window.drawFunctionTimeout = setTimeout(checkDrawFunction, 100);
          }
        };
        checkDrawFunction();
      };
      script.onerror = () => console.error('❌ app.js直接読み込み失敗');
      document.head.appendChild(script);
    } else {
      console.log('✅ app.jsは既に読み込まれています（直接読み込みスキップ）');
      // 既に読み込まれている場合も初期化を実行
      setTimeout(() => {
        if (typeof window.initGeneratorPage === 'function') {
          console.log('🔄 initGeneratorPageを実行中...（既存）');
          window.initGeneratorPage();
        } else {
          console.log('❌ initGeneratorPageが見つかりません（既存）');
        }
      }, 100);
      
      // drawStudentCard関数の定義を待ってから初期化（既存）
      const checkDrawFunctionExisting = () => {
        // app.jsの読み込み完了もチェック
        if (typeof window.initGeneratorPage === 'function') {
          console.log('✅ initGeneratorPage関数が定義されました（既存）');
          
          // drawStudentCard関数が定義されていない場合は、すぐに関数を直接定義
          if (typeof window.drawStudentCard === 'function') {
            console.log('✅ drawStudentCard関数も定義されています（既存）');
            console.log('🔄 関数定義後にinitGeneratorPageを実行中...（既存）');
            window.initGeneratorPage();
          } else {
            console.log('⏳ drawStudentCard関数が定義されていないため、直接定義します（既存）');
            // 関数を直接定義
            window.drawStudentCard = function() {
              console.log('✅ drawStudentCard関数を直接定義しました（既存）');
              
              const canvas = document.getElementById('cardCanvas');
              if (!canvas) {
                console.error('❌ cardCanvas要素が見つかりません（既存）');
                return;
              }
              
              const ctx = canvas.getContext('2d');
              if (!ctx) {
                console.error('❌ Canvas 2Dコンテキストが取得できません（既存）');
                return;
              }
              
              // 学生証テンプレート画像を読み込んで描画
              const templateImage = new Image();
              templateImage.onload = function() {
                console.log('✅ 学生証テンプレート画像の読み込み完了（既存）');
                
                // Canvasをクリア
                ctx.clearRect(0, 0, 800, 500);
                
                // テンプレート画像を描画
                ctx.drawImage(templateImage, 0, 0, 800, 500);
                
                // フォームの値を取得
                const nameJa = document.getElementById('nameJa')?.value || '';
                const nameEn = document.getElementById('nameEn')?.value || '';
                const dobMonth = document.getElementById('dobMonth')?.value || '';
                const dobDay = document.getElementById('dobDay')?.value || '';
                
                // 診断結果の情報を取得
                const params = new URLSearchParams(location.search);
                const departmentLabel = params.get('course') || '';
                const clubLabel = params.get('club') || '';
                
                // フォントの準備
                ctx.font = '34px "Noto Serif JP", serif';
                ctx.fillStyle = '#000';
                ctx.textAlign = 'left';
                
                // 氏名（漢字）を刻印（完璧な位置に調整済み）
                if (nameJa) {
                  const nameX = Math.round(1400 / 2291 * 800);
                  const nameY = Math.round(540 / 1440 * 500);
                  ctx.fillText(nameJa, nameX, nameY);
                  console.log('✅ 氏名（漢字）を刻印:', nameJa, '位置:', nameX, nameY);
                }
                
                // 氏名（ローマ字）を刻印（完璧な位置に調整済み）
                if (nameEn) {
                  ctx.font = '16px "Noto Sans JP", sans-serif';
                  ctx.fillStyle = '#666';
                  const nameEnX = Math.round(1400 / 2291 * 800);
                  const nameEnY = Math.round(620 / 1440 * 500);
                  ctx.fillText(nameEn, nameEnX, nameEnY);
                  console.log('✅ 氏名（ローマ字）を刻印:', nameEn, '位置:', nameEnX, nameEnY);
                }
                
                // 生年月日を刻印（完璧な位置に調整済み【絶対変更禁止】）
                if (dobMonth && dobDay) {
                  ctx.font = '22px "Noto Sans JP", sans-serif';
                  ctx.fillStyle = '#000';
                  ctx.textAlign = 'center';
                  const monthX = Math.round(1570 / 2291 * 800);
                  const monthY = Math.round(1050 / 1440 * 500);
                  const dayX = Math.round(1720 / 2291 * 800);
                  const dayY = Math.round(1050 / 1440 * 500);
                  ctx.fillText(dobMonth, monthX, monthY);
                  ctx.fillText(dobDay, dayX, dayY);
                  console.log('✅ 生年月日を刻印:', `${dobMonth}月${dobDay}日`, '位置:', monthX, monthY, dayX, dayY);
                }
                
                // 学科・コース・部活動を刻印（完璧な位置に調整済み【絶対変更禁止】）
                if (departmentLabel || clubLabel) {
                  // 学科とコースを分けて生成
                  let actualDepartment = '';
                  let actualCourse = '';
                  
                  if (departmentLabel) {
                    switch(departmentLabel) {
                      case '特進':
                      case '特進コース':
                        actualDepartment = '普通科';
                        actualCourse = '特進コース';
                        break;
                      case '英語':
                      case '英語コース':
                        actualDepartment = '普通科';
                        actualCourse = '英語コース';
                        break;
                      case '音楽':
                      case '音楽コース':
                        actualDepartment = '芸術科';
                        actualCourse = '音楽コース';
                        break;
                      case '美術':
                      case '美術コース':
                        actualDepartment = '芸術科';
                        actualCourse = '美術コース';
                        break;
                      default:
                        if (departmentLabel.endsWith('コース')) {
                          const baseName = departmentLabel.replace('コース', '');
                          if (baseName === '特進' || baseName === '英語') {
                            actualDepartment = '普通科';
                          } else if (baseName === '音楽' || baseName === '美術') {
                            actualDepartment = '芸術科';
                          } else {
                            actualDepartment = '普通科';
                          }
                          actualCourse = departmentLabel;
                        } else {
                          actualDepartment = departmentLabel;
                          actualCourse = departmentLabel + 'コース';
                        }
                    }
                  }
                  
                  // 学科 - 完璧な位置に調整済み【絶対変更禁止】
                  ctx.font = '22px "Noto Sans JP", sans-serif';
                  ctx.fillStyle = '#000';
                  ctx.textAlign = 'center';
                  const deptX = Math.round(1520 / 2291 * 800);
                  const deptY = Math.round(800 / 1440 * 500);
                  if (actualDepartment) {
                    const cleanDepartment = actualDepartment.replace(/科$/, '');
                    ctx.fillText(cleanDepartment, deptX, deptY);
                    console.log('✅ 学科を刻印:', cleanDepartment, '位置:', deptX, deptY);
                  }
                  
                  // コース - 完璧な位置に調整済み【絶対変更禁止】
                  ctx.font = '22px "Noto Sans JP", sans-serif';
                  ctx.fillStyle = '#000';
                  ctx.textAlign = 'center';
                  const courseX = Math.round(2000 / 2291 * 800);
                  const courseY = Math.round(800 / 1440 * 500);
                  if (actualCourse) {
                    ctx.fillText(actualCourse, courseX, courseY);
                    console.log('✅ コースを刻印:', actualCourse, '位置:', courseX, courseY);
                  }
                  
                  // 部活 - 完璧な位置に調整済み【絶対変更禁止】
                  ctx.font = '22px "Noto Sans JP", sans-serif';
                  ctx.fillStyle = '#000';
                  ctx.textAlign = 'center';
                  const clubX = Math.round(1620 / 2291 * 800);
                  const clubY = Math.round(920 / 1440 * 500);
                  if (clubLabel) {
                    let displayClubName;
                    if (clubLabel === '帰宅') {
                      displayClubName = 'ー'; // 帰宅部の場合は横棒を表示
                    } else {
                      displayClubName = clubLabel.replace(/部$/, '');
                    }
                    ctx.fillText(displayClubName, clubX, clubY);
                    console.log('✅ 部活動を刻印:', displayClubName, '位置:', clubX, clubY);
                  }
                }
                
                console.log('✅ 学生証の描画が完了しました（既存）');
              };
              
              templateImage.onerror = function() {
                console.error('❌ 学生証テンプレート画像の読み込みに失敗しました（既存）');
                // フォールバック：基本的な描画
                ctx.clearRect(0, 0, 800, 500);
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, 800, 500);
                ctx.fillStyle = '#333';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('学生証テンプレート読み込みエラー', 400, 250);
              };
              
              // 画像の読み込み開始
              console.log('🔄 学生証テンプレート画像を読み込み中...（既存）');
              templateImage.src = 'assets/img/student_template.png';
            };
            console.log('🔄 関数定義後にinitGeneratorPageを実行中...（既存）');
            window.initGeneratorPage();
          }
        } else {
          console.log('⏳ initGeneratorPage関数の定義を待機中...（既存）');
          // 100ms間隔でチェック、最大5秒でタイムアウト
          if (window.drawFunctionTimeoutExisting) {
            clearTimeout(window.drawFunctionTimeoutExisting);
          }
          if (window.drawFunctionTimeoutCountExisting === undefined) {
            window.drawFunctionTimeoutCountExisting = 0;
          }
          window.drawFunctionTimeoutCountExisting++;
          
          if (window.drawFunctionTimeoutCountExisting > 50) { // 5秒でタイムアウト
            console.error('❌ initGeneratorPage関数の定義がタイムアウトしました（既存）');
            return;
          }
          
          window.drawFunctionTimeoutExisting = setTimeout(checkDrawFunctionExisting, 100);
        }
      };
      checkDrawFunctionExisting();
    }
  </script>
  

</body>
</html> 
