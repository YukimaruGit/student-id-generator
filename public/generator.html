<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <!-- セキュリティヘッダーは _headers で統一管理（Studio埋め込み許可） -->
  
  <title>放課後クロニクル 学生証ジェネレーター</title>
  <meta property="og:title" content="放課後クロニクル 学生証ジェネレーター">
  <meta property="og:description" content="あなただけの学生証を作成しよう！">
  <meta property="og:image" content="https://res.cloudinary.com/your-cloud-name/image/upload/v1/student-id-generator/preview.png">
  <meta property="og:url" content="https://student-id.app/">
  <meta name="twitter:card" content="summary_large_image">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="assets/css/style.css">
  <!-- <script src="assets/js/domain-masking.js"></script> -->
  <style>
    /* 進捗バーとカード高さ調整（診断結果ページと完全に同じ） */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin-bottom: 2rem;
      overflow: hidden;
      margin-top: 2rem;  /* 診断結果ページと同じ上余白 */
    }

    .progress-fill {
      height: 100%;
      background: #B997D6;
      border-radius: 4px;
      transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1);
      width: 0%;
    }

    /* メインコンテナのレイアウト */
    .generator-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* カードグリッドレイアウト */
    .cards-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      align-items: stretch;
    }

    /* フォームカードとプレビューカードの高さ調整 */
    .form-card, .preview-card {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(185, 151, 214, 0.2);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* カードのパディング調整 */
    .form-card {
      padding: 2rem;
    }

    .preview-card {
      padding: 2rem;
    }

    /* カードヘッダーとフッターのマージン調整 */
    .card-header {
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: #666;
      text-align: center;
      flex-shrink: 0;
    }

    .card-footer {
      margin-top: auto;
      padding-top: 1.5rem;
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    /* カードボディの調整 */
    .card-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* フォームカードの内容調整 */
    .form-card h2 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      flex-shrink: 0;
    }

    /* フォームグループのマージン調整 */
    .form-group {
      margin-bottom: 1.5rem;
    }

    /* ボタンコンテナのマージン調整 */
    .card-footer button {
      margin: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      background: #B997D6;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .card-footer button:hover {
      background: #A895D0;
      transform: translateY(-1px);
    }

    /* フォーム要素のスタイル */
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #666;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #B997D6;
    }

    /* 日付入力のレイアウト */
    .date-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* ファイル入力のスタイル */
    .file-input-label {
      display: block;
      padding: 2rem;
      border: 2px dashed #B997D6;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(185, 151, 214, 0.05);
    }

    .file-input-label:hover {
      background: rgba(185, 151, 214, 0.1);
      border-color: #A895D0;
    }

    .file-input-label input[type="file"] {
      display: none;
    }

    /* レスポンシブ対応 */
    @media (max-width: 768px) {
      .cards-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .generator-container {
        padding: 0 0.5rem;
      }
      
      .form-card, .preview-card {
        padding: 1.5rem;
        height: auto;
        min-height: 350px;
      }
      
      .card-footer {
        flex-direction: column;
        align-items: center;
        margin-top: 1.5rem;
      }
      
      .card-footer button {
        width: 100%;
        max-width: 300px;
      }
    }

    /* === Generator overrides (layout fix) === */
    
    /* main をブロック化：ページ共通の 2カラム指定を打ち消す */
    main.generator-container {
      display: block;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    /* このページの2カラムは .cards-grid に一本化 */
    .generator-container .cards-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      align-items: stretch;          /* 両カードを同じ高さに統一 */
    }
    
    /* 高さポリシーを統一：内容に合わせて自動調整 */
    .generator-container .form-card,
    .generator-container .preview-card {
      height: auto;
      min-height: 350px;             /* 診断結果ページと完全に同じ */
      max-height: none;              /* 最大高さの制限を解除 */
      overflow: visible;             /* スクロールなし、内容を全て表示 */
      border-radius: 16px;           /* 既存の角丸に合わせる */
    }
    
    /* プレビューの sticky は無効化（高さを揃えるため） */
    .generator-container .preview-card {
      position: static !important;
      top: auto !important;
    }
    
    /* 768px 以下は縦並び＆可変高 */
    @media (max-width: 768px) {
      .generator-container .cards-grid { grid-template-columns: 1fr; }
      .generator-container .form-card,
      .generator-container .preview-card { height: auto; min-height: 350px; }
    }
    
    /* このページではヘッダーのグラデーションを非表示に */
    header, .header-gradient, .gradient-header {
      display: none !important;
    }
    
    /* 進捗バーの上余白を診断結果ページと同じに */
    .generator-container .progress-bar { margin-top: 2rem; }
    
    /* 既存の競合するCSSルールを完全に無効化 */
    .generator-container .form-card,
    .generator-container .preview-card {
      height: auto !important;
      min-height: 350px !important;   /* 診断結果ページと完全に同じ */
      max-height: none !important;    /* 最大高さの制限を解除 */
      position: static !important;
      top: auto !important;
      overflow: visible !important;
    }
    
    /* style.cssのmainグリッド設定を完全に無効化 */
    main.generator-container {
      display: block !important;
      grid-template-columns: none !important;
      grid-template-rows: none !important;
      gap: 0 !important;
    }
  </style>
  <script src="assets/js/comprehensive-security.js"></script>
  <script src="assets/js/security.js"></script>
  <script src="assets/js/privacy-protection.js"></script>
  <script src="assets/js/security-monitor.js"></script>
  <script src="assets/js/app.js?v=20250819"></script>
  
  <!-- 共有URL生成機能 -->
  <script>
    // 共有用ドメイン
    const SHARE_BASE = 'https://student-id-generator.pages.dev';

    // Base64URL（短く安全）
    function b64url(str){
      return btoa(unescape(encodeURIComponent(str)))
        .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }

    // public_id -> /s/:slug（短い）
    function buildShareUrl(public_id){
      // public_id を Base64URL 化して /s/:slug だけにする（最短化）
      const slug = b64url(public_id);
      return `${SHARE_BASE}/s/${slug}`;
    }
    
    // 新しい共有方式：JSONスラッグ（OGP画像URLを含む、最も確実）
    function buildShareUrlWithImage(public_id, version, eager_url){
      const ogUrl = eager_url || `https://res.cloudinary.com/di5xqlddy/image/upload/f_auto,q_auto,w_1200,h_630,c_fill,fl_force_strip/v${version || 1}/${public_id}.png`;
      const payload = { i: ogUrl, p: public_id }; // i: OGP画像URL, p: public_id
      const slug = btoa(unescape(encodeURIComponent(JSON.stringify(payload))))
        .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      return `${SHARE_BASE}/s/${slug}`;
    }
    window.buildShareUrl = buildShareUrl; // 既存呼び出し互換
    
    // 共有ボタンの href を差し替える（既存ボタンやリンクID/クラスは変更しない）
    function updateShareLinks(public_id, text){
      const shareUrl = buildShareUrl(public_id);
      
      // X（Twitter）intent
      const x = document.getElementById('btnShareX'); // 既存のIDに合わせる。無ければクラス等でクエリして安全に
      if (x) {
        const intent = new URL('https://x.com/intent/post');
        intent.searchParams.set('text', text || '学生証を発行しました');
        intent.searchParams.set('url', shareUrl);
        x.setAttribute('href', intent.toString());
        x.setAttribute('rel','noopener noreferrer');
        x.setAttribute('target','_blank');
      }
      
      // Discord や その他は shareUrl をそのままコピーできるUI（既存のコピーボタンに流し込むだけ）
      const copy = document.getElementById('shareLinkField');
      if (copy) { copy.value = shareUrl; }
    }
    
    // 可能ならモバイルのWeb Share API Level 2で"画像添付"も試す（対応端末のみの強化。既存UIは維持）
    async function tryNativeShare(file, text, public_id){
      if (navigator.canShare && file && navigator.canShare({ files:[file] })) {
        try { await navigator.share({ files:[file], text }); return true; } catch(e){}
      }
      // 非対応なら通常のX intent（上記 updateShareLinks 済み）へ誘導
      return false;
    }
    

  </script>
</head>
<body>
  <header>
    <!-- ヘッダータイトル削除 -->
  </header>

  <main class="generator-container">
    <!-- 進捗バー -->
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <div class="cards-grid">
      <section class="form-card">
        <h2>学生証を作成</h2>
        <div class="form-group">
          <label class="file-input-label" for="photoInput">
            画像を選択
            <input type="file" id="photoInput" accept="image/*">
          </label>
        </div>

        <div class="form-group">
          <label>
            氏名（漢字）
            <input type="text" id="nameJa" placeholder="例：高森のばら" autocomplete="name">
          </label>
        </div>

        <div class="form-group">
          <label>
            氏名（ローマ字）
            <input type="text" id="nameEn" placeholder="例：Takamori Nobara" autocapitalize="words" inputmode="latin" spellcheck="false">
          </label>
        </div>

        <div class="form-group">
          <label>
            生年月日
          </label>
          <div class="date-inputs">
            <div class="number-input">
              <select id="dobMonth">
                <option value="">月</option>
                <option value="1">1月</option>
                <option value="2">2月</option>
                <option value="3">3月</option>
                <option value="4">4月</option>
                <option value="5">5月</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
                <option value="9">9月</option>
                <option value="10">10月</option>
                <option value="11">11月</option>
                <option value="12">12月</option>
              </select>
            </div>
            <div class="number-input">
              <select id="dobDay">
                <option value="">日</option>
                <option value="1">1日</option>
                <option value="2">2日</option>
                <option value="3">3日</option>
                <option value="4">4日</option>
                <option value="5">5日</option>
                <option value="6">6日</option>
                <option value="7">7日</option>
                <option value="8">8日</option>
                <option value="9">9日</option>
                <option value="10">10日</option>
                <option value="11">11日</option>
                <option value="12">12日</option>
                <option value="13">13日</option>
                <option value="14">14日</option>
                <option value="15">15日</option>
                <option value="16">16日</option>
                <option value="17">17日</option>
                <option value="18">18日</option>
                <option value="19">19日</option>
                <option value="20">20日</option>
                <option value="21">21日</option>
                <option value="22">22日</option>
                <option value="23">23日</option>
                <option value="24">24日</option>
                <option value="25">25日</option>
                <option value="26">26日</option>
                <option value="27">27日</option>
                <option value="28">28日</option>
                <option value="29">29日</option>
                <option value="30">30日</option>
                <option value="31">31日</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 診断ゲーム連携ボタン（診断結果設定時のみ表示） -->
        <div id="diagnosisButtons" style="display: none; margin-top: 1rem; gap: 0.5rem; flex-wrap: wrap;">
          <button type="button" id="backToDiagnosisBtn" style="background: linear-gradient(135deg, #98d7a5, #98c8a8); color: white; flex: 1; min-width: 120px;">
            診断に戻る
          </button>
          <button type="button" id="viewDiagnosisResultBtn" style="background: linear-gradient(135deg, #87ceeb, #98c8e8); color: white; flex: 1; min-width: 120px;">
            診断結果を見る
          </button>
        </div>
      </section>

      <section class="preview-card">
        <div class="card-header">
          プレビュー
        </div>
        <div class="card-body">
          <canvas id="cardCanvas" width="800" height="500"></canvas>
        </div>
        <div class="card-footer">
          <button type="button" id="downloadBtn">
            画像を保存
          </button>
          <button type="button" id="twitterBtn" class="btn-twitter">
            <i class="fab fa-x-twitter"></i>
            Xに投稿
          </button>
          <button type="button" id="urlBtn">
            URLをコピー
          </button>
        </div>
      </section>
    </div>
  </main>

  <footer>
          <div class="footer-content" style="text-align: center; padding: 1rem; color: #666;">
        <a href="./privacy.html" style="color: #2E8B57; text-decoration: none; margin: 0 1rem;">
          プライバシーポリシー
        </a>
      </div>
  </footer>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>処理中...</p>
  </div>

  <!-- 進捗バー制御 -->
  <script>
    // 進捗バーの更新
    function updateProgress() {
      const progressFill = document.getElementById('progressFill');
      if (!progressFill) return;
      
      let completedFields = 0;
      const totalFields = 6; // 画像、氏名（漢字）、氏名（ローマ字）、生年月日、学科、部活動
      
      // 画像が選択されているかチェック
      const photoInput = document.getElementById('photoInput');
      if (photoInput && photoInput.files && photoInput.files.length > 0) {
        completedFields++;
      }
      
      // 氏名（漢字）が入力されているかチェック
      const nameJa = document.getElementById('nameJa');
      if (nameJa && nameJa.value.trim()) {
        completedFields++;
      }
      
      // 氏名（ローマ字）が入力されているかチェック
      const nameEn = document.getElementById('nameEn');
      if (nameEn && nameEn.value.trim()) {
        completedFields++;
      }
      
      // 生年月日が選択されているかチェック
      const dobMonth = document.getElementById('dobMonth');
      const dobDay = document.getElementById('dobDay');
      if (dobMonth && dobDay && dobMonth.value && dobDay.value) {
        completedFields++;
      }
      
      // 学科が選択されているかチェック
      const department = document.getElementById('department');
      if (department && department.value) {
        completedFields++;
      }
      
      // 部活動が選択されているかチェック
      const club = document.getElementById('club');
      if (club && club.value) {
        completedFields++;
      }
      
      // 進捗率を計算して更新
      const progress = (completedFields / totalFields) * 100;
      progressFill.style.width = `${progress}%`;
    }
    
    // フォーム要素の変更を監視
    function setupProgressTracking() {
      const formElements = [
        'photoInput', 'nameJa', 'nameEn', 'dobMonth', 'dobDay', 'department', 'club'
      ];
      
      formElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          if (element.type === 'file') {
            element.addEventListener('change', updateProgress);
          } else if (element.tagName === 'SELECT') {
            element.addEventListener('change', updateProgress);
          } else {
            element.addEventListener('input', updateProgress);
          }
        }
      });
    }
  </script>

  <!-- 診断ゲーム連携処理 -->
  <script>
    // 放課後クロニクル診断ゲームからの連携処理（セキュリティ強化版）
    document.addEventListener('DOMContentLoaded', function() {
      // 診断情報をsessionStorageにバックアップ（クエリがある場合のみ）
      if (location.search) {
        sessionStorage.setItem('diagCtx', location.search);
      }
      
      // 安全なURLパラメータ取得
      const department = window.Security ? window.Security.getSafeUrlParam('department') : new URLSearchParams(location.search).get('department');
      const course = window.Security ? window.Security.getSafeUrlParam('course') : new URLSearchParams(location.search).get('course');
      const club = window.Security ? window.Security.getSafeUrlParam('club') : new URLSearchParams(location.search).get('club');
      
      console.log('診断結果連携:', { department, course, club });

      // 学科の自動設定
      if (department && course) {
        const selDept = document.getElementById('department');
        if (selDept) {
          // 既存の選択肢にない場合は動的に追加
          const existingOption = Array.from(selDept.options).find(opt => opt.value === course);
          if (!existingOption && course !== '') {
            const newOption = document.createElement('option');
            newOption.value = course;
            newOption.textContent = course;
            selDept.appendChild(newOption);
          }
          
          selDept.value = course;
          selDept.style.display = 'none';
          
          // ラベルを診断結果表示に変更（XSS対策：textContent使用）
          const deptLabel = selDept.parentElement.querySelector('label');
          if (deptLabel) {
            // 安全な表示用HTMLを構築
            const safeDepartment = document.createElement('div');
            safeDepartment.style.cssText = 'padding: 0.75rem; background: #f8f9fa; border-radius: 8px; color: #666; border: 2px solid #e0e0e0;';
            
            const deptText = document.createTextNode(`${department}（${course}コース） `);
            const resultSpan = document.createElement('span');
            resultSpan.style.cssText = 'font-size: 0.8em; color: #999;';
            resultSpan.textContent = '（診断結果）';
            
            safeDepartment.appendChild(deptText);
            safeDepartment.appendChild(resultSpan);
            
            // 既存の内容をクリアして安全に追加
            deptLabel.textContent = '学科';
            deptLabel.appendChild(safeDepartment);
          }
        }
      }

      // 部活動の自動設定
      if (club) {
        const selClub = document.getElementById('club');
        if (selClub) {
          // 既存の選択肢にない場合は動的に追加
          const existingOption = Array.from(selClub.options).find(opt => opt.value === club);
          if (!existingOption && club !== '') {
            const newOption = document.createElement('option');
            newOption.value = club;
            newOption.textContent = club;
            selClub.appendChild(newOption);
          }
          
          selClub.value = club;
          selClub.style.display = 'none';
          
          // ラベルを診断結果表示に変更（XSS対策：textContent使用）
          const clubLabel = selClub.parentElement.querySelector('label');
          if (clubLabel) {
            // 安全な表示用HTMLを構築
            const safeClub = document.createElement('div');
            safeClub.style.cssText = 'padding: 0.75rem; background: #f8f9fa; border-radius: 8px; color: #666; border: 2px solid #e0e0e0;';
            
            const clubText = document.createTextNode(`${club} `);
            const resultSpan = document.createElement('span');
            resultSpan.style.cssText = 'font-size: 0.8em; color: #999;';
            resultSpan.textContent = '（診断結果）';
            
            safeClub.appendChild(clubText);
            safeClub.appendChild(resultSpan);
            
            // 既存の内容をクリアして安全に追加
            clubLabel.textContent = '部活動';
            clubLabel.appendChild(safeClub);
          }
        }
      }

      // 診断結果が設定された場合、リアルタイムプレビューを更新
      if (department || course || club) {
        // 診断関連ボタンを表示
        const diagnosisButtons = document.getElementById('diagnosisButtons');
        if (diagnosisButtons) {
          diagnosisButtons.style.display = 'flex';
          
          // 診断に戻るボタン
          const backBtn = document.getElementById('backToDiagnosisBtn');
          if (backBtn) {
            backBtn.onclick = () => {
              const url = new URL('index.html', location.href);
              if (location.search.includes('embed=1')) url.searchParams.set('embed','1');
              location.href = url.toString();
            };
          }
          
          // 診断結果を見るボタン
          const viewResultBtn = document.getElementById('viewDiagnosisResultBtn');
          if (viewResultBtn) {
            viewResultBtn.onclick = () => {
              // URLパラメータを保持してindex.htmlの結果ページに移動
              const currentParams = new URLSearchParams(location.search);
              const diagnosisUrl = new URL('index.html', window.location.href);
              diagnosisUrl.searchParams.set('showResult', 'true');
              diagnosisUrl.searchParams.set('department', currentParams.get('department') || '');
              diagnosisUrl.searchParams.set('course', currentParams.get('course') || '');
              diagnosisUrl.searchParams.set('club', currentParams.get('club') || '');
              diagnosisUrl.searchParams.set('previewMessage', currentParams.get('previewMessage') || '');
              diagnosisUrl.searchParams.set('episodeMessage', currentParams.get('episodeMessage') || '');
              
              // 埋め込みモードの場合はembed=1を付与
              if (location.search.includes('embed=1')) diagnosisUrl.searchParams.set('embed','1');
              
              window.location.href = diagnosisUrl.toString();
            };
          }
        }

        // 少し遅延を入れてからプレビュー更新（他の初期化が完了してから）
        setTimeout(() => {
          if (typeof drawStudentCard === 'function') {
            drawStudentCard();
          }
        }, 500);
      }
      
      // 進捗バーの初期化
      setupProgressTracking();
      updateProgress();
    });
  </script>
  
  <!-- 埋め込みモード対応 -->
  <script src="assets/js/embed-mode.js" defer></script>
  
  <!-- iPhoneでカメラが起動する件を修正 -->
  <script>
    document.getElementById('photoInput')?.removeAttribute('capture');
  </script>
  
  <!-- 共有機能は app.js で統一管理 -->
</body>
</html> 