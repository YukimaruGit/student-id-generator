<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã¯ _headers ã§çµ±ä¸€ç®¡ç†ï¼ˆStudioåŸ‹ã‚è¾¼ã¿è¨±å¯ï¼‰ -->
  
  <title>æ”¾èª²å¾Œã‚¯ãƒ­ãƒ‹ã‚¯ãƒ« å­¦ç”Ÿè¨¼ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <meta property="og:title" content="æ”¾èª²å¾Œã‚¯ãƒ­ãƒ‹ã‚¯ãƒ« å­¦ç”Ÿè¨¼ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼">
  <meta property="og:description" content="ã‚ãªãŸã ã‘ã®å­¦ç”Ÿè¨¼ã‚’ä½œæˆã—ã‚ˆã†ï¼">
  <meta property="og:image" content="https://res.cloudinary.com/di5xqlddy/image/upload/f_auto,q_auto,w_1200,h_630,c_fill,fl_force_strip/v1/student-id-generator/preview.png">
  <meta property="og:url" content="https://student-id-generator.pages.dev/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://res.cloudinary.com/di5xqlddy/image/upload/f_auto,q_auto,w_1200,h_630,c_fill,fl_force_strip/v1/student-id-generator/preview.png">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="assets/css/style.css">
  <!-- <script src="assets/js/domain-masking.js"></script> -->
  <style>
    /* é€²æ—ãƒãƒ¼ã¨ã‚«ãƒ¼ãƒ‰é«˜ã•èª¿æ•´ï¼ˆè¨ºæ–­çµæœãƒšãƒ¼ã‚¸ã¨å®Œå…¨ã«åŒã˜ï¼‰ */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin-bottom: 2rem;
      overflow: hidden;
      margin-top: 2rem;  /* è¨ºæ–­çµæœãƒšãƒ¼ã‚¸ã¨åŒã˜ä¸Šä½™ç™½ */
    }

    .progress-fill {
      height: 100%;
      background: #B997D6;
      border-radius: 4px;
      transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1);
      width: 0%;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .generator-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .cards-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      align-items: stretch;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ã®é«˜ã•èª¿æ•´ */
    .form-card, .preview-card {
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(185, 151, 214, 0.2);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* ã‚«ãƒ¼ãƒ‰ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´ */
    .form-card {
      padding: 2rem;
    }

    .preview-card {
      padding: 2rem;
    }

    /* ã‚«ãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ•ãƒƒã‚¿ãƒ¼ã®ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
    .card-header {
      margin-bottom: 1.5rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: #666;
      text-align: center;
      flex-shrink: 0;
    }

    .card-footer {
      margin-top: auto;
      padding-top: 1.5rem;
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    /* ã‚«ãƒ¼ãƒ‰ãƒœãƒ‡ã‚£ã®èª¿æ•´ */
    .card-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã®å†…å®¹èª¿æ•´ */
    .form-card h2 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      flex-shrink: 0;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
    .form-group {
      margin-bottom: 1.5rem;
    }

    /* ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
    .card-footer button {
      margin: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      background: #B997D6;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .card-footer button:hover {
      background: #A895D0;
      transform: translateY(-1px);
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #666;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #B997D6;
    }

    /* æ—¥ä»˜å…¥åŠ›ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .date-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .file-input-label {
      display: block;
      padding: 2rem;
      border: 2px dashed #B997D6;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(185, 151, 214, 0.05);
    }

    .file-input-label:hover {
      background: rgba(185, 151, 214, 0.1);
      border-color: #A895D0;
    }

    .file-input-label input[type="file"] {
      display: none;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
      .cards-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .generator-container {
        padding: 0 0.5rem;
      }
      
      .form-card, .preview-card {
        padding: 1.5rem;
        height: auto;
        min-height: 350px;
      }
      
      .card-footer {
        flex-direction: column;
        align-items: center;
        margin-top: 1.5rem;
      }
      
      .card-footer button {
        width: 100%;
        max-width: 300px;
      }
    }

    /* === Generator overrides (layout fix) === */
    
    /* main ã‚’ãƒ–ãƒ­ãƒƒã‚¯åŒ–ï¼šãƒšãƒ¼ã‚¸å…±é€šã® 2ã‚«ãƒ©ãƒ æŒ‡å®šã‚’æ‰“ã¡æ¶ˆã™ */
    main.generator-container {
      display: block;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    /* ã“ã®ãƒšãƒ¼ã‚¸ã®2ã‚«ãƒ©ãƒ ã¯ .cards-grid ã«ä¸€æœ¬åŒ– */
    .generator-container .cards-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      align-items: stretch;          /* ä¸¡ã‚«ãƒ¼ãƒ‰ã‚’åŒã˜é«˜ã•ã«çµ±ä¸€ */
    }
    
    /* é«˜ã•ãƒãƒªã‚·ãƒ¼ã‚’çµ±ä¸€ï¼šå†…å®¹ã«åˆã‚ã›ã¦è‡ªå‹•èª¿æ•´ */
    .generator-container .form-card,
    .generator-container .preview-card {
      height: auto;
      min-height: 350px;             /* è¨ºæ–­çµæœãƒšãƒ¼ã‚¸ã¨å®Œå…¨ã«åŒã˜ */
      max-height: none;              /* æœ€å¤§é«˜ã•ã®åˆ¶é™ã‚’è§£é™¤ */
      overflow: visible;             /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã—ã€å†…å®¹ã‚’å…¨ã¦è¡¨ç¤º */
      border-radius: 16px;           /* æ—¢å­˜ã®è§’ä¸¸ã«åˆã‚ã›ã‚‹ */
    }
    
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã® sticky ã¯ç„¡åŠ¹åŒ–ï¼ˆé«˜ã•ã‚’æƒãˆã‚‹ãŸã‚ï¼‰ */
    .generator-container .preview-card {
      position: static !important;
      top: auto !important;
    }
    
    /* 768px ä»¥ä¸‹ã¯ç¸¦ä¸¦ã³ï¼†å¯å¤‰é«˜ */
    @media (max-width: 768px) {
      .generator-container .cards-grid { grid-template-columns: 1fr; }
      .generator-container .form-card,
      .generator-container .preview-card { height: auto; min-height: 350px; }
    }
    
    /* ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã« */
    header, .header-gradient, .gradient-header {
      display: none !important;
    }
    
    /* é€²æ—ãƒãƒ¼ã®ä¸Šä½™ç™½ã‚’è¨ºæ–­çµæœãƒšãƒ¼ã‚¸ã¨åŒã˜ã« */
    .generator-container .progress-bar { margin-top: 2rem; }
    
    /* æ—¢å­˜ã®ç«¶åˆã™ã‚‹CSSãƒ«ãƒ¼ãƒ«ã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ– */
    .generator-container .form-card,
    .generator-container .preview-card {
      height: auto !important;
      min-height: 350px !important;   /* è¨ºæ–­çµæœãƒšãƒ¼ã‚¸ã¨å®Œå…¨ã«åŒã˜ */
      max-height: none !important;    /* æœ€å¤§é«˜ã•ã®åˆ¶é™ã‚’è§£é™¤ */
      position: static !important;
      top: auto !important;
      overflow: visible !important;
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 10000;
      font-size: 14px;
      transition: opacity 0.3s ease;
    }

    .toast.show {
      opacity: 1;
    }

    .toast.hide {
      opacity: 0;
    }
    

    
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯ 8:5 ã‚’å³å®ˆã—ã¦ä¼¸ç¸® */
    .preview-card .card-body canvas#cardCanvas{
      width: 100%;
      height: auto;
      aspect-ratio: 8 / 5;
      display: block;
    }
    
    /* style.cssã®mainã‚°ãƒªãƒƒãƒ‰è¨­å®šã‚’å®Œå…¨ã«ç„¡åŠ¹åŒ– */
    main.generator-container {
      display: block !important;
      grid-template-columns: none !important;
      grid-template-rows: none !important;
      gap: 0 !important;
    }
  </style>
  <script>
    // ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯é«˜åº¦å¯¾ç­–ã‚’OFFï¼ˆç”»åƒä¿å­˜ãƒ»Canvasæ“ä½œã®ãŸã‚ï¼‰
    window.AdvancedSecurityConfig = { preventSideChannelAttacks: false };
  </script>
  <script src="assets/js/comprehensive-security.js"></script>
  <script src="assets/js/security.js"></script>
  <script src="assets/js/privacy-protection.js"></script>
  <script src="assets/js/security-monitor.js"></script>
  <script src="assets/js/app.js?v=20250822"></script>
  
  <!-- å…±æœ‰URLç”Ÿæˆæ©Ÿèƒ½ -->
  <script>
    // å…±æœ‰ç”¨ãƒ‰ãƒ¡ã‚¤ãƒ³
    const SHARE_BASE = 'https://student-id-generator.pages.dev';
    
    // Cloudinaryè¨­å®šï¼ˆapp.jsã¨åŒæœŸã€äºŒé‡å®šç¾©é˜²æ­¢ï¼‰
    window.cloudinaryConfig ??= { 
      cloudName: 'di5xqlddy', 
      uploadPreset: 'student_card_AS_chronicle' 
    };

    // Base64URLï¼ˆçŸ­ãå®‰å…¨ï¼‰
    function b64url(str){
      return btoa(unescape(encodeURIComponent(str)))
        .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }

    // å…±æœ‰URLã¯ JSON æ–¹å¼ã«ä¸€æœ¬åŒ–ï¼ˆpublic_id ã¨ version ã®ã¿ã§çŸ­ç¸®ï¼‰
    function buildShareUrlWithImage({public_id, version}) {
      const payload = { p: public_id, v: version }; // çŸ­ç¸®
      const json = JSON.stringify(payload);
      const slug = btoa(unescape(encodeURIComponent(json)))  // base64
                    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); // base64url
      return `${SHARE_BASE}/s/${slug}`;
    }
    window.buildShareUrlWithImage = buildShareUrlWithImage;
    
    // å…±æœ‰ãƒªãƒ³ã‚¯æ›´æ–°é–¢æ•°ï¼ˆapp.jsã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼‰â€¦UIã¯ä¿æŒã®ã¿ã€ãƒãƒ³ãƒ‰ãƒ©ã¯app.jsãŒå‚ç…§
    function updateShareLinksWithImage(imageData, text) {
      const shareUrl = buildShareUrlWithImage({
        public_id: imageData.public_id,
        version: imageData.version
      });
      console.log('å…±æœ‰URLæ›´æ–°:', shareUrl);
      // å…±æœ‰URLã‚’ä¿å­˜
      window.__shareUrl = shareUrl;
      
      // URLã‚³ãƒ”ãƒ¼
      const urlBtn = document.getElementById('urlBtn');
      if (urlBtn) urlBtn.onclick = () => copyTextReliable(window.__shareUrl);
      
      // XæŠ•ç¨¿ï¼ˆæŒ‡å®šã®ãƒ†ãƒ³ãƒ—ãƒ¬ã«å·®ã—æ›¿ãˆãƒ»æ–°è¦ã‚¿ãƒ–ã§é–‹ãï¼‰
      const twitterBtn = document.getElementById('twitterBtn');
      if (twitterBtn) {
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å­¦ç§‘/éƒ¨æ´»ã‚’å–å¾—ï¼ˆéƒ¨æ´»ã¯"éƒ¨"ã‚’ä»˜ã‘ã‚‹ï¼‰
        const p = new URLSearchParams(location.search);
        const course = p.get('course') || 'æ™®é€šç§‘';
        const rawClub = p.get('club') || 'å¸°å®…';
        const club = /éƒ¨$/.test(rawClub) ? rawClub : `${rawClub}éƒ¨`;

        const tweet = [
          `${window.__shareUrl}`,
          '',
          'ğŸ«å¤¢è¦‹ãŒä¸˜å¥³å­é«˜ç­‰å­¦æ ¡ å…¥å­¦è¨ºæ–­',
          `ã€${course}ã€‘ã®ã€${club}ã€‘ã«ãªã‚Šã¾ã—ãŸï¼`,
          'è¨ºæ–­ã®æœ€å¾Œã«ã¯ã€è‡ªåˆ†ã ã‘ã®å­¦ç”Ÿè¨¼ã‚‚ã‚‚ã‚‰ãˆã¾ã™ğŸ“ğŸ“¸',
          '',
          'å›ã‚‚æ”¾èª²å¾Œã‚¯ãƒ­ãƒ‹ã‚¯ãƒ«ã®ä¸–ç•Œã¸â€•â€•',
          '',
          '#æ”¾èª²å¾Œã‚¯ãƒ­ãƒ‹ã‚¯ãƒ« #å­¦ç”Ÿè¨¼ãƒ¡ãƒ¼ã‚«ãƒ¼'
        ].join('\n');

        const webIntent = `https://x.com/intent/post?text=${encodeURIComponent(tweet)}`;
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
        let isSharing = false;
        twitterBtn.onclick = async () => {
          if (isSharing) return; // é€£æ‰“é˜²æ­¢
          isSharing = true;
          
          try {
            // æ–°ã—ã„çµ±åˆå…±æœ‰é–¢æ•°ã‚’ä½¿ç”¨ï¼ˆç”»åƒ + URL ã‚’ç¢ºå®Ÿã«ã‚·ã‚§ã‚¢ï¼‰
            const finalImageUrl = window.__ogpImageUrl || window.__lastImageData?.eager_url || window.__lastImageData?.secure_url;
            if (finalImageUrl) {
              await window.shareStudentId(finalImageUrl, window.__shareUrl, 'ğŸ«å¤¢è¦‹ãŒä¸˜å¥³å­é«˜ç­‰å­¦æ ¡ å­¦ç”Ÿè¨¼ ã¤ãã£ãŸã‚ˆ');
              // å…±æœ‰å®Œäº†å¾Œã®ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
              if (window.showToast) {
                window.showToast('Xã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã¯ã“ã®ã¾ã¾åˆ©ç”¨ã§ãã¾ã™ã€‚');
              }
            } else {
              // ç”»åƒURLãŒãªã„å ´åˆã¯Web Intentã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
              const webIntent = `https://x.com/intent/post?text=${encodeURIComponent(tweet)}`;
              if (window.openInNewTab) {
                window.openInNewTab(webIntent);
              } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const a = document.createElement('a');
                a.href = webIntent;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                document.body.appendChild(a);
                a.click();
                a.remove();
              }
            }
          } finally {
            // 1.5ç§’å¾Œã«ãƒ­ãƒƒã‚¯è§£é™¤
            setTimeout(() => { isSharing = false; }, 1500);
          }
        };
      }
      
      // è¡¨ç¤ºç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Œã°æ›´æ–°
      const field = document.getElementById('shareLinkField');
      if (field) field.value = shareUrl;
    }
    window.updateShareLinksWithImage = updateShareLinksWithImage;
    
    // å¯èƒ½ãªã‚‰ãƒ¢ãƒã‚¤ãƒ«ã®Web Share API Level 2ã§"ç”»åƒæ·»ä»˜"ã‚‚è©¦ã™ï¼ˆå¯¾å¿œç«¯æœ«ã®ã¿ã®å¼·åŒ–ã€‚æ—¢å­˜UIã¯ç¶­æŒï¼‰
    async function tryNativeShare(file, text, public_id){
      if (navigator.canShare && file && navigator.canShare({ files:[file] })) {
        try { await navigator.share({ files:[file], text }); return true; } catch(e){}
      }
      // éå¯¾å¿œãªã‚‰é€šå¸¸ã®X intentï¼ˆä¸Šè¨˜ updateShareLinks æ¸ˆã¿ï¼‰ã¸èª˜å°
      return false;
    }
    

  </script>
  
  <!-- ç›´ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢ï¼šè¨ºæ–­æœªå®Ÿæ–½ãªã‚‰è¨ºæ–­ã‚²ãƒ¼ãƒ ã¸èª˜å° -->
  <script>
    (() => {
      const sp = new URLSearchParams(location.search);
      const hasParams = ['department','course','club'].some(k => sp.has(k));
      // è¨ºæ–­çµæœã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿æŒã—ã¦ã„ã‚‹ã‚­ãƒ¼ï¼ˆã‚ãªãŸã®å®Ÿè£…ã«åˆã‚ã›ã¦ä¸¡å¯¾å¿œï¼‰
      const hasCtx =
        sessionStorage.getItem('diagCtx') ||
        sessionStorage.getItem('as_chronicle_diagnosis');
      const inEmbed = sp.get('embed') === '1' || (window !== window.top);

      if (!hasParams && !hasCtx && !inEmbed) {
        // ç›´ãƒªãƒ³ã‚¯/å±¥æ­´å¾©å¸°ã§ generator ã«æ¥ãŸã¨åˆ¤æ–­ â†’ è¨ºæ–­ã¸èª˜å°
        location.replace('./index.html'); // ã¾ãŸã¯ './quiz.html'
      }
    })();
  </script>
</head>
<body>
  <header>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«å‰Šé™¤ -->
  </header>

  <main class="generator-container">
    <!-- é€²æ—ãƒãƒ¼ -->
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <div class="cards-grid">
      <section class="form-card">
        <h2>å­¦ç”Ÿè¨¼ã‚’ä½œæˆ</h2>
        <div class="form-group">
          <label class="file-input-label" for="photoInput">
            ç”»åƒã‚’é¸æŠ
            <input type="file" id="photoInput" accept="image/*">
          </label>
        </div>

        <div class="form-group">
          <label>
            æ°åï¼ˆæ¼¢å­—ï¼‰
            <input type="text" id="nameJa" placeholder="ä¾‹ï¼šé«˜æ£®ã®ã°ã‚‰" autocomplete="name">
          </label>
        </div>

        <div class="form-group">
          <label>
            æ°åï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰
            <input type="text" id="nameEn" placeholder="ä¾‹ï¼šTakamori Nobara" autocapitalize="words" inputmode="latin" spellcheck="false">
          </label>
        </div>

        <div class="form-group">
          <label>
            ç”Ÿå¹´æœˆæ—¥
          </label>
          <div class="date-inputs">
            <div class="number-input">
              <select id="dobMonth">
                <option value="">æœˆ</option>
                <option value="1">1æœˆ</option>
                <option value="2">2æœˆ</option>
                <option value="3">3æœˆ</option>
                <option value="4">4æœˆ</option>
                <option value="5">5æœˆ</option>
                <option value="6">6æœˆ</option>
                <option value="7">7æœˆ</option>
                <option value="8">8æœˆ</option>
                <option value="9">9æœˆ</option>
                <option value="10">10æœˆ</option>
                <option value="11">11æœˆ</option>
                <option value="12">12æœˆ</option>
              </select>
            </div>
            <div class="number-input">
              <select id="dobDay">
                <option value="">æ—¥</option>
                <option value="1">1æ—¥</option>
                <option value="2">2æ—¥</option>
                <option value="3">3æ—¥</option>
                <option value="4">4æ—¥</option>
                <option value="5">5æ—¥</option>
                <option value="6">6æ—¥</option>
                <option value="7">7æ—¥</option>
                <option value="8">8æ—¥</option>
                <option value="9">9æ—¥</option>
                <option value="10">10æ—¥</option>
                <option value="11">11æ—¥</option>
                <option value="12">12æ—¥</option>
                <option value="13">13æ—¥</option>
                <option value="14">14æ—¥</option>
                <option value="15">15æ—¥</option>
                <option value="16">16æ—¥</option>
                <option value="17">17æ—¥</option>
                <option value="18">18æ—¥</option>
                <option value="19">19æ—¥</option>
                <option value="20">20æ—¥</option>
                <option value="21">21æ—¥</option>
                <option value="22">22æ—¥</option>
                <option value="23">23æ—¥</option>
                <option value="24">24æ—¥</option>
                <option value="25">25æ—¥</option>
                <option value="26">26æ—¥</option>
                <option value="27">27æ—¥</option>
                <option value="28">28æ—¥</option>
                <option value="29">29æ—¥</option>
                <option value="30">30æ—¥</option>
                <option value="31">31æ—¥</option>
              </select>
            </div>
          </div>
        </div>

        <!-- è¨ºæ–­ã‚²ãƒ¼ãƒ é€£æºãƒœã‚¿ãƒ³ï¼ˆè¨ºæ–­çµæœè¨­å®šæ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
        <div id="diagnosisButtons" style="display: none; margin-top: 1rem; gap: 0.5rem; flex-wrap: wrap;">
          <button type="button" id="backToDiagnosisBtn" style="background: linear-gradient(135deg, #98d7a5, #98c8a8); color: white; flex: 1; min-width: 120px;">
            è¨ºæ–­ã«æˆ»ã‚‹
          </button>
          <button type="button" id="viewDiagnosisResultBtn" style="background: linear-gradient(135deg, #87ceeb, #98c8e8); color: white; flex: 1; min-width: 120px;">
            è¨ºæ–­çµæœã‚’è¦‹ã‚‹
          </button>
        </div>
      </section>

      <section class="preview-card">
        <div class="card-header">
          ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        </div>
        <div class="card-body">
          <canvas id="cardCanvas" width="800" height="500"></canvas>
        </div>
        <small style="display:block; margin:.5rem 0 0; font-size:12px; color:#888; text-align:center;">
          â€»PCã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®ä¸Šã§å³ã‚¯ãƒªãƒƒã‚¯ â†’ã€Œåå‰ã‚’ä»˜ã‘ã¦ç”»åƒã‚’ä¿å­˜ã€<br>
          â€»å…±æœ‰URLã¯å¿…ãšã€ŒURLã‚’ã‚³ãƒ”ãƒ¼ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å–å¾—ã—ã¦ãã ã•ã„
        </small>
        <div class="card-footer">
          <button type="button" id="downloadBtn">
            ç”»åƒã‚’ä¿å­˜
          </button>
          <button type="button" id="twitterBtn" class="btn-twitter">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 4px;">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            Xã«æŠ•ç¨¿
          </button>
          <button type="button" id="urlBtn">
            URLã‚’ã‚³ãƒ”ãƒ¼
          </button>
        </div>
      </section>
    </div>
  </main>

  <footer>
          <div class="footer-content" style="text-align: center; padding: 1rem; color: #666;">
        <a href="./privacy.html" style="color: #2E8B57; text-decoration: none; margin: 0 1rem;">
          ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼
        </a>
      </div>
  </footer>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>å‡¦ç†ä¸­...</p>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º -->
  <div id="toast" class="toast" style="display: none;">
    <div class="toast-content">
      <span id="toastMessage"></span>
    </div>
  </div>

  <!-- é€²æ—ãƒãƒ¼åˆ¶å¾¡ -->
  <script>
    // é€²æ—ãƒãƒ¼ã®æ›´æ–°
    function updateProgress() {
      const progressFill = document.getElementById('progressFill');
      if (!progressFill) return;
      
      let completedFields = 0;
      const totalFields = 6; // ç”»åƒã€æ°åï¼ˆæ¼¢å­—ï¼‰ã€æ°åï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰ã€ç”Ÿå¹´æœˆæ—¥ã€å­¦ç§‘ã€éƒ¨æ´»å‹•
      
      // ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const photoInput = document.getElementById('photoInput');
      if (photoInput && photoInput.files && photoInput.files.length > 0) {
        completedFields++;
      }
      
      // æ°åï¼ˆæ¼¢å­—ï¼‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const nameJa = document.getElementById('nameJa');
      if (nameJa && nameJa.value.trim()) {
        completedFields++;
      }
      
      // æ°åï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const nameEn = document.getElementById('nameEn');
      if (nameEn && nameEn.value.trim()) {
        completedFields++;
      }
      
      // ç”Ÿå¹´æœˆæ—¥ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const dobMonth = document.getElementById('dobMonth');
      const dobDay = document.getElementById('dobDay');
      if (dobMonth && dobDay && dobMonth.value && dobDay.value) {
        completedFields++;
      }
      
      // å­¦ç§‘ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const department = document.getElementById('department');
      if (department && department.value) {
        completedFields++;
      }
      
      // éƒ¨æ´»å‹•ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const club = document.getElementById('club');
      if (club && club.value) {
        completedFields++;
      }
      
      // é€²æ—ç‡ã‚’è¨ˆç®—ã—ã¦æ›´æ–°
      const progress = (completedFields / totalFields) * 100;
      progressFill.style.width = `${progress}%`;
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®å¤‰æ›´ã‚’ç›£è¦–
    function setupProgressTracking() {
      const formElements = [
        'photoInput', 'nameJa', 'nameEn', 'dobMonth', 'dobDay', 'department', 'club'
      ];
      
      formElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          if (element.type === 'file') {
            element.addEventListener('change', updateProgress);
          } else if (element.tagName === 'SELECT') {
            element.addEventListener('change', updateProgress);
          } else {
            element.addEventListener('input', updateProgress);
          }
        }
      });
    }
  </script>

  <!-- è¨ºæ–­ã‚²ãƒ¼ãƒ é€£æºå‡¦ç† -->
  <script>
    // æ”¾èª²å¾Œã‚¯ãƒ­ãƒ‹ã‚¯ãƒ«è¨ºæ–­ã‚²ãƒ¼ãƒ ã‹ã‚‰ã®é€£æºå‡¦ç†ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ç‰ˆï¼‰
    document.addEventListener('DOMContentLoaded', function() {
      // çŠ¶æ…‹å¾©å…ƒå‡¦ç†
      function restoreStudentIdState() {
        try {
          const savedResult = window.loadResult ? window.loadResult() : null;
          if (savedResult && savedResult.public_id && savedResult.version) {
            console.log('å­¦ç”Ÿè¨¼ã®çŠ¶æ…‹ã‚’å¾©å…ƒã—ã¾ã™:', savedResult);
            
            // å…±æœ‰URLã‚’å¾©å…ƒ
            if (window.buildShareUrlWithImage) {
              const shareUrl = window.buildShareUrlWithImage({
                public_id: savedResult.public_id,
                version: savedResult.version
              });
              window.__shareUrl = shareUrl;
              
              // å…±æœ‰ãƒªãƒ³ã‚¯ã‚’æ›´æ–°
              if (window.updateShareLinksWithImage) {
                window.updateShareLinksWithImage(savedResult, 'å­¦ç”Ÿè¨¼ãŒå¾©å…ƒã•ã‚Œã¾ã—ãŸ');
              }
            }
            
            // OGPç”»åƒURLã‚’å¾©å…ƒ
            if (savedResult.eager_url) {
              window.__ogpImageUrl = savedResult.eager_url;
            }
            
            // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
            if (savedResult.imageData) {
              window.__lastImageData = savedResult.imageData;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’å¾©å…ƒ
            if (savedResult.formData) {
              const { nameJa, nameEn, dobMonth, dobDay } = savedResult.formData;
              if (nameJa && document.getElementById('nameJa')) {
                document.getElementById('nameJa').value = nameJa;
              }
              if (nameEn && document.getElementById('nameEn')) {
                document.getElementById('nameEn').value = nameEn;
              }
              if (dobMonth && document.getElementById('dobMonth')) {
                document.getElementById('dobMonth').value = dobMonth;
              }
              if (dobDay && document.getElementById('dobDay')) {
                document.getElementById('dobDay').value = dobDay;
              }
            }
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å†æç”»
            if (typeof window.drawStudentCard === 'function') {
              setTimeout(() => window.drawStudentCard(), 100);
            }
            
            console.log('âœ… å­¦ç”Ÿè¨¼ã®çŠ¶æ…‹ãŒå¾©å…ƒã•ã‚Œã¾ã—ãŸ');
          }
        } catch (error) {
          console.error('çŠ¶æ…‹å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
        }
      }
      
          // çŠ¶æ…‹å¾©å…ƒã‚’å®Ÿè¡Œ
    restoreStudentIdState();
    
    // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºæ©Ÿèƒ½
    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      if (toast && toastMessage) {
        toastMessage.textContent = message;
        toast.style.display = 'block';
        toast.classList.add('show');
        
        setTimeout(() => {
          toast.classList.add('hide');
          setTimeout(() => {
            toast.style.display = 'none';
            toast.classList.remove('show', 'hide');
          }, 300);
        }, duration);
      }
    }
    
    window.showToast = showToast;
      // è¨ºæ–­æƒ…å ±ã‚’sessionStorageã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚¯ã‚¨ãƒªãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
      if (location.search) {
        sessionStorage.setItem('diagCtx', location.search);
      }
      
      // å®‰å…¨ãªURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
      const department = window.Security ? window.Security.getSafeUrlParam('department') : new URLSearchParams(location.search).get('department');
      const course = window.Security ? window.Security.getSafeUrlParam('course') : new URLSearchParams(location.search).get('course');
      const club = window.Security ? window.Security.getSafeUrlParam('club') : new URLSearchParams(location.search).get('club');
      
      console.log('è¨ºæ–­çµæœé€£æº:', { department, course, club });

      // å­¦ç§‘ã®è‡ªå‹•è¨­å®š
      if (department && course) {
        const selDept = document.getElementById('department');
        if (selDept) {
          // æ—¢å­˜ã®é¸æŠè‚¢ã«ãªã„å ´åˆã¯å‹•çš„ã«è¿½åŠ 
          const existingOption = Array.from(selDept.options).find(opt => opt.value === course);
          if (!existingOption && course !== '') {
            const newOption = document.createElement('option');
            newOption.value = course;
            newOption.textContent = course;
            selDept.appendChild(newOption);
          }
          
          selDept.value = course;
          selDept.style.display = 'none';
          
          // ãƒ©ãƒ™ãƒ«ã‚’è¨ºæ–­çµæœè¡¨ç¤ºã«å¤‰æ›´ï¼ˆXSSå¯¾ç­–ï¼štextContentä½¿ç”¨ï¼‰
          const deptLabel = selDept.parentElement.querySelector('label');
          if (deptLabel) {
            // å®‰å…¨ãªè¡¨ç¤ºç”¨HTMLã‚’æ§‹ç¯‰
            const safeDepartment = document.createElement('div');
            safeDepartment.style.cssText = 'padding: 0.75rem; background: #f8f9fa; border-radius: 8px; color: #666; border: 2px solid #e0e0e0;';
            
            const deptText = document.createTextNode(`${department}ï¼ˆ${course}ã‚³ãƒ¼ã‚¹ï¼‰ `);
            const resultSpan = document.createElement('span');
            resultSpan.style.cssText = 'font-size: 0.8em; color: #999;';
            resultSpan.textContent = 'ï¼ˆè¨ºæ–­çµæœï¼‰';
            
            safeDepartment.appendChild(deptText);
            safeDepartment.appendChild(resultSpan);
            
            // æ—¢å­˜ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¦å®‰å…¨ã«è¿½åŠ 
            deptLabel.textContent = 'å­¦ç§‘';
            deptLabel.appendChild(safeDepartment);
          }
        }
      }

      // éƒ¨æ´»å‹•ã®è‡ªå‹•è¨­å®š
      if (club) {
        const selClub = document.getElementById('club');
        if (selClub) {
          // æ—¢å­˜ã®é¸æŠè‚¢ã«ãªã„å ´åˆã¯å‹•çš„ã«è¿½åŠ 
          const existingOption = Array.from(selClub.options).find(opt => opt.value === club);
          if (!existingOption && club !== '') {
            const newOption = document.createElement('option');
            newOption.value = club;
            newOption.textContent = club;
            selClub.appendChild(newOption);
          }
          
          selClub.value = club;
          selClub.style.display = 'none';
          
          // ãƒ©ãƒ™ãƒ«ã‚’è¨ºæ–­çµæœè¡¨ç¤ºã«å¤‰æ›´ï¼ˆXSSå¯¾ç­–ï¼štextContentä½¿ç”¨ï¼‰
          const clubLabel = selClub.parentElement.querySelector('label');
          if (clubLabel) {
            // å®‰å…¨ãªè¡¨ç¤ºç”¨HTMLã‚’æ§‹ç¯‰
            const safeClub = document.createElement('div');
            safeClub.style.cssText = 'padding: 0.75rem; background: #f8f9fa; border-radius: 8px; color: #666; border: 2px solid #e0e0e0;';
            
            const clubText = document.createTextNode(`${club} `);
            const resultSpan = document.createElement('span');
            resultSpan.style.cssText = 'font-size: 0.8em; color: #999;';
            resultSpan.textContent = 'ï¼ˆè¨ºæ–­çµæœï¼‰';
            
            safeClub.appendChild(clubText);
            safeClub.appendChild(resultSpan);
            
            // æ—¢å­˜ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¦å®‰å…¨ã«è¿½åŠ 
            clubLabel.textContent = 'éƒ¨æ´»å‹•';
            clubLabel.appendChild(safeClub);
          }
        }
      }

      // è¨ºæ–­çµæœãŒè¨­å®šã•ã‚ŒãŸå ´åˆã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      if (department || course || club) {
        // è¨ºæ–­é–¢é€£ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        const diagnosisButtons = document.getElementById('diagnosisButtons');
        if (diagnosisButtons) {
          diagnosisButtons.style.display = 'flex';
          
          // è¨ºæ–­ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³
          const backBtn = document.getElementById('backToDiagnosisBtn');
          if (backBtn) {
            backBtn.onclick = () => {
              const url = new URL('index.html', location.href);
              if (location.search.includes('embed=1')) url.searchParams.set('embed','1');
              location.href = url.toString();
            };
          }
          
          // è¨ºæ–­çµæœã‚’è¦‹ã‚‹ãƒœã‚¿ãƒ³
          const viewResultBtn = document.getElementById('viewDiagnosisResultBtn');
          if (viewResultBtn) {
            viewResultBtn.onclick = () => {
              // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¦index.htmlã®çµæœãƒšãƒ¼ã‚¸ã«ç§»å‹•
              const currentParams = new URLSearchParams(location.search);
              const diagnosisUrl = new URL('index.html', window.location.href);
              diagnosisUrl.searchParams.set('showResult', 'true');
              diagnosisUrl.searchParams.set('department', currentParams.get('department') || '');
              diagnosisUrl.searchParams.set('course', currentParams.get('course') || '');
              diagnosisUrl.searchParams.set('club', currentParams.get('club') || '');
              diagnosisUrl.searchParams.set('previewMessage', currentParams.get('previewMessage') || '');
              diagnosisUrl.searchParams.set('episodeMessage', currentParams.get('episodeMessage') || '');
              
              // åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯embed=1ã‚’ä»˜ä¸
              if (location.search.includes('embed=1')) diagnosisUrl.searchParams.set('embed','1');
              
              window.location.href = diagnosisUrl.toString();
            };
          }
        }

        // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ã‹ã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ï¼ˆä»–ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¦ã‹ã‚‰ï¼‰
        setTimeout(() => {
          if (typeof drawStudentCard === 'function') {
            drawStudentCard();
          }
        }, 500);
      }
      
      // é€²æ—ãƒãƒ¼ã®åˆæœŸåŒ–
      setupProgressTracking();
      updateProgress();
      
      // ç«¯æœ«åˆ¥ã®ä¿å­˜UI
      const isPc = matchMedia('(pointer:fine)').matches && (navigator.maxTouchPoints || 0) === 0;
      const saveBtn = document.getElementById('downloadBtn');
      if (saveBtn) {
        if (isPc) {
          // PCã¯ãƒœã‚¿ãƒ³ä¸è¦ï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ä¿å­˜ï¼‰
          saveBtn.remove();
        } else {
          // ãƒ¢ãƒã‚¤ãƒ«ã¯OGPç”»åƒã‚’æ–°è¦ã‚¿ãƒ–ã§é–‹ãï¼ˆé•·æŠ¼ã—ä¿å­˜ï¼‰
          saveBtn.onclick = () => {
            if (window.__ogpImageUrl) window.open(window.__ogpImageUrl, '_blank', 'noopener');
          };
        }
      }
    });
  </script>
  
  <!-- åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ -->
  <script src="assets/js/embed-mode.js" defer></script>
  
  <!-- iPhoneã§ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã™ã‚‹ä»¶ã‚’ä¿®æ­£ -->
  <script>
    // captureå±æ€§ã¯æ—¢ã«å‰Šé™¤æ¸ˆã¿
  </script>
  
  <!-- å…±æœ‰æ©Ÿèƒ½ã¯ app.js ã§çµ±ä¸€ç®¡ç† -->
  

</body>
</html> 